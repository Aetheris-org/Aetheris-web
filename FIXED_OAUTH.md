# ‚úÖ OAuth2 –ò–°–ü–†–ê–í–õ–ï–ù!

## üêõ –ü—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞:

–¢–æ–∫–µ–Ω –ø—Ä–∏—Ö–æ–¥–∏–ª –∏–∑ Google (`ya29.a0ATi6K2u4mq7xk...`), –Ω–æ –∑–∞–ø—Ä–æ—Å `/api/users/me` –≤–æ–∑–≤—Ä–∞—â–∞–ª **401 Unauthorized**.

**–ü—Ä–∏—á–∏–Ω–∞**: Strapi –Ω–µ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–ª callback –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –∏ —Ç–æ–∫–µ–Ω, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏—Ö–æ–¥–∏–ª –æ—Ç Google - —ç—Ç–æ **Google Access Token**, –∞ –Ω–µ **Strapi JWT**.

## ‚úÖ –†–µ—à–µ–Ω–∏–µ:

–°–æ–∑–¥–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–∞–π–ª —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è `strapi-server.ts`, –∫–æ—Ç–æ—Ä—ã–π:

1. **–ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä OAuth callback** - —Ç–µ–ø–µ—Ä—å Strapi –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±–º–µ–Ω–∏–≤–∞–µ—Ç Google code –Ω–∞ JWT
2. **–î–æ–±–∞–≤–ª—è–µ—Ç –∫–∞—Å—Ç–æ–º–Ω—ã–π —Ä–æ—É—Ç** `/api/users/me` (PUT) –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è
3. **–î–æ–±–∞–≤–ª—è–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä** –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è username

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤:

```
backend/strapi-backend/src/extensions/users-permissions/
‚îî‚îÄ‚îÄ strapi-server.ts  ‚Üê –ï–î–ò–ù–°–¢–í–ï–ù–ù–´–ô —Ñ–∞–π–ª —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
```

**–£–¥–∞–ª–µ–Ω—ã:**
- ‚ùå `controllers/auth.ts`
- ‚ùå `controllers/user.ts`
- ‚ùå `routes/custom-auth.ts`
- ‚ùå `routes/custom-user.ts`

---

## üöÄ –ö–∞–∫ —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç:

```
1. User ‚Üí –ù–∞–∂–∏–º–∞–µ—Ç "–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google"
   window.location.href = "http://localhost:1337/api/connect/google"
   
2. Strapi ‚Üí –†–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç –Ω–∞ Google OAuth
   
3. Google ‚Üí User logs in ‚Üí –†–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç –æ–±—Ä–∞—Ç–Ω–æ:
   http://localhost:1337/api/connect/google/callback?code=XXX
   
4. ‚úÖ –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –≤ strapi-server.ts:
   - –ü–æ–ª—É—á–∞–µ—Ç code –æ—Ç Google
   - –û–±–º–µ–Ω–∏–≤–∞–µ—Ç –Ω–∞ Google access_token
   - –°–æ–∑–¥–∞—ë—Ç/–æ–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Strapi
   - –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç STRAPI JWT
   - –†–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç: http://localhost:5173/auth/callback?access_token=STRAPI_JWT
   
5. Frontend AuthCallback.vue:
   - –ò–∑–≤–ª–µ–∫–∞–µ—Ç STRAPI JWT –∏–∑ URL
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ localStorage
   - –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç GET /api/users/me (—Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç!)
   - –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ /auth/finalize –∏–ª–∏ /
```

---

## üß™ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π –°–ï–ô–ß–ê–°:

1. –û—Ç–∫—Ä–æ–π http://localhost:5173
2. –ü–æ–ø—Ä–æ–±—É–π –∑–∞–π—Ç–∏ –Ω–∞ `/profile`
3. –ù–∞–∂–º–∏ **"–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å Google"**
4. –í—ã–±–µ—Ä–∏ –∞–∫–∫–∞—É–Ω—Ç
5. **–¢–µ–ø–µ—Ä—å –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å!** ‚úÖ

---

## üìä –í –ª–æ–≥–∞—Ö –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:

**Strapi logs** (—Ç–µ—Ä–º–∏–Ω–∞–ª):
```
‚úÖ OAuth success for user: your-email@gmail.com
http: GET /api/connect/google/callback (220 ms) 302
http: GET /api/users/me (2 ms) 200  ‚Üê –¢–µ–ø–µ—Ä—å 200, –∞ –Ω–µ 401!
```

**Browser Console**:
```
warn: Access token found: ya29...
(–Ω–µ—Ç –æ—à–∏–±–æ–∫ "Failed to fetch user: 401")
```

---

## üìù –í–∞–∂–Ω–æ:

–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –≤ Strapi Admin **–£–ñ–ï –ù–ê–°–¢–†–û–ï–ù–´** (—Ç—ã —ç—Ç–æ —Å–¥–µ–ª–∞–ª).

–ï—Å–ª–∏ –≤—Å—ë —Ä–∞–≤–Ω–æ **401** - –ø—Ä–æ–≤–µ—Ä—å –≤ Strapi Admin:
- **Settings** ‚Üí **Roles** ‚Üí **Authenticated**
- ‚úÖ Users-permissions ‚Üí `me` (GET) –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤–∫–ª—é—á–µ–Ω–∞

---

## üîß –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ —Å–ª–æ–º–∞–ª–æ—Å—å:

### –û—à–∏–±–∫–∞: "This provider is disabled"
**–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä—å –≤ Strapi Admin ‚Üí Providers ‚Üí Google ‚Üí Enabled = ON

### –û—à–∏–±–∫–∞: 401 –ø—Ä–∏ GET /api/users/me
**–†–µ—à–µ–Ω–∏–µ**: 
1. Strapi Admin ‚Üí Settings ‚Üí Roles ‚Üí Authenticated
2. –í–∫–ª—é—á–∏ `me` (GET) –≤ —Ä–∞–∑–¥–µ–ª–µ Users-permissions
3. Save

### –û—à–∏–±–∫–∞: "Username is already taken"
**–†–µ—à–µ–Ω–∏–µ**: –ü–æ–ø—Ä–æ–±—É–π –¥—Ä—É–≥–æ–π –Ω–∏–∫–Ω–µ–π–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ /auth/finalize

---

## ‚ú® –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å:

1. ‚úÖ **–ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Ñ–∞–π–ª** `strapi-server.ts` - –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –ø–ª–∞–≥–∏–Ω–∞
2. ‚úÖ **Callback –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω** - —Ç–µ–ø–µ—Ä—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç Strapi JWT, –∞ –Ω–µ Google token
3. ‚úÖ **–ö–∞—Å—Ç–æ–º–Ω—ã–π endpoint** `/api/users/me` (PUT) —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
4. ‚úÖ **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –¥–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

---

**Strapi —É–∂–µ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω. –¢–µ—Å—Ç–∏—Ä—É–π! üöÄ**

