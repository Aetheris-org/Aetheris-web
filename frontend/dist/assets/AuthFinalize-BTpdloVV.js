import{d as y,a as k,r as m,o as z,D as b,e as p,i,j as t,y as S,v as A,l as f,O as U,m as x,t as h,B as F,Q as I,E as u,_ as N}from"./index-Cha8mMNk.js";const V={class:"finalize-page"},w={class:"finalize-container"},B={class:"input-group"},C=["disabled"],E={key:0,class:"validation-error"},D={key:1,class:"server-error"},M=["disabled"],R={key:0},K={key:1,class:"saving-state"},T=y({__name:"AuthFinalize",setup(W){const d=b(),s=k(),r=m(""),n=m(""),o=m(!1);z(()=>{if(console.log("üîµ AuthFinalize mounted, auth state:",{isAuthenticated:s.isAuthenticated,hasUser:!!s.user,username:s.user?.username}),s.loadFromStorage(),!s.isAuthenticated){console.log("‚ùå Not authenticated, redirecting to /auth"),d.replace("/auth");return}const a=s.user?.username&&s.user.username!==s.user.email&&!s.user.username.startsWith("user_")&&!s.user.username.startsWith("hash-");if(console.log("üîµ Username validation:",{username:s.user?.username,hasValidUsername:a}),a){console.log("‚úÖ User already has valid username, redirecting");const e=sessionStorage.getItem("auth_redirect");sessionStorage.removeItem("auth_redirect"),d.replace(e||"/");return}console.log("‚úÖ User needs to set username, showing form"),r.value=""});const l=p(()=>r.value?r.value.length<3?"–ú–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞":r.value.length>24?"–ú–∞–∫—Å–∏–º—É–º 24 —Å–∏–º–≤–æ–ª–∞":/^[a-zA-Z0-9_-]+$/.test(r.value)?"":"–¢–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, –¥–µ—Ñ–∏—Å –∏ –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏–µ":"–ù–∏–∫–Ω–µ–π–º –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º"),c=p(()=>!l.value&&!o.value&&r.value.trim()!=="");async function v(){if(c.value){o.value=!0,n.value="";try{const a=await I.put("/api/users/me",{username:r.value.trim()});a.data&&s.setUser({...s.user,username:a.data.username});const e=sessionStorage.getItem("auth_redirect");sessionStorage.removeItem("auth_redirect"),d.replace(e||"/")}catch(a){console.error("Failed to update username:",a),a.response?.data?.error?.message?n.value=a.response.data.error.message:a.response?.status===400?n.value="–≠—Ç–æ—Ç –Ω–∏–∫–Ω–µ–π–º —É–∂–µ –∑–∞–Ω—è—Ç":n.value="–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∏–∫–Ω–µ–π–º. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑."}finally{o.value=!1}}}function _(a){a.key==="Enter"&&c.value&&v()}return(a,e)=>(u(),i("div",V,[t("div",w,[e[4]||(e[4]=t("div",{class:"finalize-header"},[t("h1",null,"–ü–æ—Å–ª–µ–¥–Ω–∏–π —à–∞–≥"),t("p",null,"–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º –¥–ª—è –≤–∞—à–µ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è")],-1)),t("form",{onSubmit:S(v,["prevent"]),class:"finalize-form"},[t("div",B,[e[1]||(e[1]=t("label",{for:"nickname"},"–ù–∏–∫–Ω–µ–π–º",-1)),A(t("input",{id:"nickname","onUpdate:modelValue":e[0]||(e[0]=g=>r.value=g),type:"text",placeholder:"–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º",disabled:o.value,class:x({"input-error":l.value||n.value}),onKeypress:_,autofocus:""},null,42,C),[[U,r.value]]),l.value?(u(),i("p",E,h(l.value),1)):f("",!0),n.value?(u(),i("p",D,h(n.value),1)):f("",!0),e[2]||(e[2]=t("p",{class:"input-hint"},"–õ–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, –¥–µ—Ñ–∏—Å –∏ –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏–µ (3-24 —Å–∏–º–≤–æ–ª–∞)",-1))]),t("button",{type:"submit",class:"save-btn",disabled:!c.value},[o.value?(u(),i("span",K,[...e[3]||(e[3]=[t("span",{class:"spinner-small"},null,-1),F(" –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ... ",-1)])])):(u(),i("span",R,"–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å"))],8,M)],32),e[5]||(e[5]=t("div",{class:"finalize-footer"},[t("p",null,"–í—ã —Å–º–æ–∂–µ—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∏–∫–Ω–µ–π–º –ø–æ–∑–∂–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ø—Ä–æ—Ñ–∏–ª—è")],-1))])]))}}),O=N(T,[["__scopeId","data-v-13e5366d"]]);export{O as default};
