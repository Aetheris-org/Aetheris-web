import{d as Se,r as u,e as Ye,w as Xe,o as ze,i as Ce,j as v,y as R,M as Be,v as De,B as oe,O as We,t as He,E as Te,_ as ke}from"./index-Cha8mMNk.js";const Ee={class:"avatar-cropper"},Ie={class:"cropper-overlay"},$e={class:"cropper-controls"},_e={class:"control-group"},Re={class:"zoom-value"},j=1e3,G=560,A=480,k=60,Ae=Se({__name:"AvatarCropper",props:{imageUrl:{},shape:{},outputSize:{},outputType:{},maxBytes:{},maintainAspect:{type:Boolean}},emits:["crop"],setup(ne,{expose:le,emit:se}){const c=ne,ce=se,g=u(null),W=u(null),d=u(1),Y=u(0),X=u(0),M=u(!1),E=u(0),I=u(0),$=u(0),_=u(0),J=u(0),K=u(1),U=u(!1),z=u(A),C=u(A),b=u((j-A)/2),w=u((G-A)/2),re=Ye(()=>{const e=(c.shape??"circle")==="circle";return{width:`${z.value}px`,height:`${C.value}px`,left:`${b.value}px`,top:`${w.value}px`,border:"3px dashed #ffffff",borderRadius:e?"50%":"8px",position:"absolute",pointerEvents:"none",boxSizing:"border-box"}});let m=null;const t={x:0,y:0,w:0,h:0},L=()=>{W.value&&(m=new Image,m.crossOrigin="anonymous",m.onload=()=>{B();const e=Math.min(A,t.w,t.h);cropBoxSize.value=Math.max(k,e),b.value=t.x+(t.w-cropBoxSize.value)/2,w.value=t.y+(t.h-cropBoxSize.value)/2},m.onerror=()=>{console.error("Failed to load image")},m.src=c.imageUrl)},B=()=>{if(!W.value||!m)return;const e=W.value,a=e.getContext("2d");if(!a)return;e.width=j,e.height=G,a.fillStyle="#1a1a1a",a.fillRect(0,0,e.width,e.height);const l=m.width*d.value,s=m.height*d.value,i=(j-l)/2+Y.value,o=(G-s)/2+X.value;t.x=i,t.y=o,t.w=l,t.h=s,a.drawImage(m,i,o,l,s)},y=u(!1),n={x:0,y:0,boxX:0,boxY:0,boxW:0,boxH:0};let q=0,V=0;const F=e=>{y.value=e,n.x=q,n.y=V,n.boxX=b.value,n.boxY=w.value,n.boxW=z.value,n.boxH=C.value},N=u(!1),S={x:0,y:0,boxX:0,boxY:0},ie=e=>{N.value=!0,S.x=e.clientX,S.y=e.clientY,S.boxX=b.value,S.boxY=w.value},ue=e=>{g.value&&(M.value=!0,E.value=e.clientX,I.value=e.clientY,$.value=Y.value,_.value=X.value,g.value.style.cursor="grabbing",q=e.clientX,V=e.clientY)},ve=e=>{if(q=e.clientX,V=e.clientY,N.value){const s=e.clientX-S.x,i=e.clientY-S.y;let o=S.boxX+s,r=S.boxY+i;o=Math.max(t.x,Math.min(o,t.x+t.w-z.value)),r=Math.max(t.y,Math.min(r,t.y+t.h-C.value)),b.value=o,w.value=r;return}if(y.value){const s=e.clientX-n.x,i=e.clientY-n.y;let o=n.boxW,r=n.boxH,h=n.boxX,x=n.boxY;const p=c.maintainAspect??(c.shape??"circle")==="circle";switch(y.value){case"se":o=n.boxW+s,r=p?o:n.boxH+i;break;case"ne":o=n.boxW+s,r=p?o:n.boxH-i,x=n.boxY+n.boxH-r;break;case"sw":o=n.boxW-s,r=p?o:n.boxH+i,h=n.boxX+n.boxW-o;break;case"nw":o=n.boxW-s,r=p?o:n.boxH-i,h=n.boxX+n.boxW-o,x=n.boxY+n.boxH-r;break}if(o=Math.max(k,o),r=Math.max(k,r),h+o>t.x+t.w&&(o=t.x+t.w-h),x+r>t.y+t.h&&(r=t.y+t.h-x),h<t.x&&(o-=t.x-h,h=t.x),x<t.y&&(r-=t.y-x,x=t.y),p){const H=Math.min(o,r);(y.value==="ne"||y.value==="nw")&&(x=x+(r-H)),(y.value==="sw"||y.value==="nw")&&(h=h+(o-H)),o=H,r=H}z.value=o,C.value=r,b.value=h,w.value=x;return}if(!M.value)return;const a=e.clientX-E.value,l=e.clientY-I.value;Y.value=$.value+a,X.value=_.value+l,B()},Z=()=>{M.value&&(M.value=!1,g.value&&(g.value.style.cursor="grab")),y.value=!1,N.value=!1},pe=e=>{e.preventDefault();const a=e.deltaY>0?-.1:.1,l=Math.max(.5,Math.min(8,d.value+a));l!==d.value&&(d.value=l,B())},ee=(e,a)=>{const l=e.clientX-a.clientX,s=e.clientY-a.clientY;return Math.sqrt(l*l+s*s)},he=e=>{e.touches.length===2?(U.value=!0,J.value=ee(e.touches[0],e.touches[1]),K.value=d.value,e.preventDefault()):e.touches.length===1&&(M.value=!0,E.value=e.touches[0].clientX,I.value=e.touches[0].clientY,$.value=Y.value,_.value=X.value,g.value&&(g.value.style.cursor="grabbing"))},xe=e=>{if(U.value&&e.touches.length===2){const l=ee(e.touches[0],e.touches[1])/J.value,s=Math.max(.5,Math.min(8,K.value*l));d.value=s,B(),e.preventDefault()}else if(M.value&&e.touches.length===1){const a=e.touches[0].clientX-E.value,l=e.touches[0].clientY-I.value;Y.value=$.value+a,X.value=_.value+l,B(),e.preventDefault()}},de=e=>{e.touches.length===0?(U.value=!1,M.value=!1,g.value&&(g.value.style.cursor="grab")):e.touches.length===1&&(U.value=!1,M.value=!0,E.value=e.touches[0].clientX,I.value=e.touches[0].clientY,$.value=Y.value,_.value=X.value)},fe=()=>{d.value=1,Y.value=0,X.value=0,B()},me=()=>{if(c.maintainAspect??(c.shape??"circle")==="circle"){const a=Math.max(k,Math.min(t.w,t.h));z.value=a,C.value=a,b.value=t.x+(t.w-a)/2,w.value=t.y+(t.h-a)/2}else z.value=Math.max(k,t.w),C.value=Math.max(k,t.h),b.value=t.x,w.value=t.y},te=()=>new Promise((e,a)=>{if(!W.value||!m){a(new Error("Canvas or image not available"));return}const l=document.createElement("canvas"),s=z.value,i=C.value;l.width=s,l.height=i;const o=l.getContext("2d");if(!o){a(new Error("Failed to get context"));return}const r=b.value,h=w.value,x=(c.shape??"circle")==="circle";if(o.save(),x){o.beginPath();const f=Math.min(s,i)/2;o.arc(s/2,i/2,f,0,2*Math.PI),o.clip()}o.drawImage(W.value,r,h,s,i,0,0,s,i),o.restore();const p=document.createElement("canvas"),H=c.maintainAspect??(c.shape??"circle")==="circle";let P,O;if(H){const f=typeof c.outputSize=="number"?c.outputSize:Math.min(1024,Math.max(s,i));P=f,O=f}else{const T=(typeof c.outputSize=="number"?c.outputSize:Math.min(1024,Math.max(s,i)))/Math.max(s,i);P=Math.max(1,Math.round(s*T)),O=Math.max(1,Math.round(i*T))}p.width=P,p.height=O;const D=p.getContext("2d");if(!D){a(new Error("Failed to get final context"));return}if(D.save(),(c.shape??"circle")==="circle"){D.beginPath();const f=Math.min(p.width,p.height)/2;D.arc(p.width/2,p.height/2,f,0,2*Math.PI),D.clip()}D.drawImage(l,0,0,P,O),D.restore();const Q=c.outputType??"image/jpeg",be=c.maxBytes??((c.shape??"circle")==="circle"?10*1024:500*1024),we=(c.shape??"circle")==="circle"?.65:.92,ae=f=>{p.toBlob(T=>{if(!T){a(new Error("Failed to create blob"));return}if(T.size>be&&f>.5)ae(f-.1);else{const Me=(c.shape??"circle")==="circle"?"avatar":"preview",ye=new File([T],`${Me}.${Q==="image/webp"?"webp":"jpg"}`,{type:Q});e(ye)}},Q,f)};ae(we)}),ge=async()=>{try{const e=await te();ce("crop",e)}catch(e){console.error("Crop error:",e)}};return Xe(()=>c.imageUrl,()=>{c.imageUrl&&L()}),ze(()=>{c.imageUrl&&L()}),le({crop:ge,getCroppedImage:te,selectFull:me}),(e,a)=>(Te(),Ce("div",Ee,[v("div",{class:"cropper-container",ref_key:"containerRef",ref:g,onMousedown:ue,onMousemove:ve,onMouseup:Z,onMouseleave:Z,onWheel:pe,onTouchstart:he,onTouchmove:xe,onTouchend:de},[v("canvas",{ref_key:"canvasRef",ref:W,class:"cropper-canvas"},null,512),v("div",Ie,[v("div",{class:"crop-box",style:Be(re.value),onMousedown:R(ie,["stop","prevent"])},[v("span",{class:"handle handle-nw",onMousedown:a[0]||(a[0]=R(l=>F("nw"),["stop","prevent"]))},null,32),v("span",{class:"handle handle-ne",onMousedown:a[1]||(a[1]=R(l=>F("ne"),["stop","prevent"]))},null,32),v("span",{class:"handle handle-sw",onMousedown:a[2]||(a[2]=R(l=>F("sw"),["stop","prevent"]))},null,32),v("span",{class:"handle handle-se",onMousedown:a[3]||(a[3]=R(l=>F("se"),["stop","prevent"]))},null,32)],36)])],544),v("div",$e,[v("div",_e,[a[5]||(a[5]=v("label",{class:"control-label"},[oe(" Масштаб "),v("span",{class:"hint-text"},"(колесико мыши или слайдер)")],-1)),De(v("input",{type:"range",min:"0.5",max:"8",step:"0.1","onUpdate:modelValue":a[4]||(a[4]=l=>d.value=l),onInput:B,class:"zoom-slider"},null,544),[[We,d.value,void 0,{number:!0}]]),v("span",Re,He(Math.round(d.value*100))+"%",1)]),a[6]||(a[6]=v("div",{class:"control-group"},[v("label",{class:"control-label"},[oe(" Управление "),v("span",{class:"hint-text"},"(перетаскивайте мышкой для перемещения)")])],-1)),v("div",{class:"control-group"},[v("button",{onClick:fe,class:"control-btn secondary"},"Сбросить")])])]))}}),Fe=ke(Ae,[["__scopeId","data-v-bbb34b97"]]);export{Fe as A};
