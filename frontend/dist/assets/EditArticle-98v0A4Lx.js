import{d as Re,u as Ee,c as Ie,r as s,e as Q,a as De,o as Fe,g as Oe,f as Se,i as u,j as e,l as _,k as I,t as o,s as h,D as Be,y as b,m as C,A as X,T as Z,v as re,O as ue,S as Pe,F as P,q as K,p as Me,G as je,E as n,_ as Ne}from"./index-Cha8mMNk.js";import{u as Ve,F as qe}from"./useTags-nhpkAlsk.js";import{F as Ke}from"./FullArticleCard-0H59Q-Oh.js";import{A as ze}from"./AvatarCropper-CrIIn-tx.js";import{u as Ge}from"./DeleteConfirmDialog-CrHiTmEy.js";import{j as Je,i as ce,k as de}from"./articles-Cl6OgbpY.js";import"./index-CIrCQqjO.js";const We={class:"create-article-container"},Ye={class:"content-wrapper"},He={class:"warning-block"},Qe={class:"warning-title"},Xe={class:"warning-subtitle"},Ze={class:"nice-uploader"},xe={key:0,class:"uploader-empty"},et={key:1,class:"uploader-preview"},tt=["src"],lt={class:"uploader-actions"},at={class:"preview-upload-section"},it={class:"preview-upload-header"},st={class:"preview-upload-title"},ot={class:"preview-upload-subtitle"},nt={class:"preview-upload-wrapper"},rt=["disabled"],ut={class:"file-upload-content"},ct={key:"loading",class:"upload-loading"},dt={class:"upload-text"},vt=["src"],pt={class:"upload-preview-overlay"},ft={key:"empty",class:"upload-empty"},mt={class:"upload-text"},yt={class:"upload-hint"},gt={class:"path-block"},ht={class:"edit-title"},bt={class:"edit-subtitle"},wt={class:"tags-section"},kt={class:"tags-title"},At={class:"tags-subtitle"},_t={key:0,class:"selected-tags"},Ct={class:"tag-text"},$t=["onClick","aria-label"],Ut={class:"tag-input-wrapper"},Tt=["onKeydown","placeholder","disabled"],Lt={key:0,class:"tags-suggestions"},Rt=["onClick"],Et={class:"tags-counter"},It={class:"difficulty-section"},Dt={class:"difficulty-title"},Ft={class:"difficulty-subtitle"},Ot={class:"difficulty-circles"},St=["onClick","title"],Bt={class:"action-buttons"},Pt=["disabled"],Mt={key:0,class:"pi pi-send button-icon"},jt={key:1,class:"pi pi-spin pi-spinner button-icon"},Nt={class:"button-text"},Vt=["disabled"],qt={class:"button-text"},Kt=["disabled"],zt={class:"button-text"},Gt={key:0,class:"api-error"},Jt={class:"api-error-message"},Wt={class:"preview-modal-header"},Yt={class:"preview-modal-title"},Ht={class:"preview-modal-content"},Qt={key:0,class:"validation-toast",role:"alert","aria-live":"polite"},Xt={class:"validation-toast-header"},Zt={class:"validation-toast-title"},xt=["aria-label"],el={class:"validation-toast-content"},tl={class:"validation-intro"},ll={class:"validation-list"},al={class:"preview-modal-header"},il={class:"preview-modal-title"},sl={class:"preview-modal-content"},ol={class:"cropper-footer-actions"},nl=Re({__name:"EditArticle",setup(rl){const{t:i}=Ee(),v=Ie(),w=s(""),g=s(""),z=Be(),ve=Oe(),$=s(null),c=s(null),p=s(!1),M=s(!1);s({});const m=s(!1),U=s(!1),y=s(null),k=s(null),x=s("preview.webp"),j=s(null),N=s(!1),ee=s(null),L=s([]),G=s(!1),D=s(!1),A=s({title:!1,content:!1,tags:!1}),pe=Q(()=>{const l=f.user?.nickname||f.user?.username||"Anonymous",t=c.value||void 0;return t&&console.log("Preview URL в computed:",t,typeof t),{id:E.value||0,title:w.value.trim()||i("notifications.editArticle.defaultTitle"),content:g.value||"<p>Содержание статьи еще не добавлено...</p>",excerpt:Y(g.value),tags:d.value||[],difficulty:R.value||"medium",status:"published",previewImage:t,preview_image:t,author:{id:f.user?.id||0,username:l,avatar:f.user?.avatar},createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),likes:0,views:0,commentsCount:0}}),{getTagSeverity:fe,filterTags:me}=Ve(),d=s([]),F=s(""),O=s(!1),R=s("medium"),ye=Q(()=>({easy:i("create-article.difficulty.easy"),medium:i("create-article.difficulty.medium"),hard:i("create-article.difficulty.hard")})),S=Q(()=>me(F.value,d.value).slice(0,10)),{createArticle:te,loading:B,error:le}=Ge(),f=De(),J=s(!0),E=s(null);s(!1),s(!1),s(!1),s(!1),s(!1),s(!1),s(!1),console.log("VITE_IMGBB_API_KEY =",void 0);const W=l=>{if(d.value.length>=5){v.add({severity:"warn",summary:i("create-article.tags.limitTitle"),detail:i("create-article.tags.limitToast"),life:3e3});return}d.value.includes(l)||(d.value.push(l),F.value="",O.value=!1)},ge=l=>{const t=d.value.indexOf(l);t>-1&&d.value.splice(t,1)},he=()=>{O.value=!0},be=()=>{const l=F.value.trim();if(!l)return;if(d.value.length>=5){v.add({severity:"warn",summary:i("create-article.tags.limitTitle"),detail:i("create-article.tags.limitToast"),life:3e3});return}const t=S.value.find(a=>a.toLowerCase()===l.toLowerCase());t?W(t):S.value.length>0&&W(S.value[0])},we=l=>{R.value=l},ae=l=>{l.target.closest(".tag-input-wrapper")||(O.value=!1)},ke=async()=>{if(L.value=[],A.value={title:!1,content:!1,tags:!1},w.value.trim()||(A.value.title=!0,L.value.push(i("notifications.editArticle.validation.titleRequired"))),g.value.trim()||(A.value.content=!0,L.value.push(i("notifications.editArticle.validation.contentRequired"))),d.value.length===0&&(A.value.tags=!0,L.value.push(i("notifications.editArticle.validation.tagsRequired"))),L.value.length>0){D.value=!0,G.value=!0,setTimeout(()=>{D.value=!1},600),v.add({severity:"warn",summary:i("notifications.editArticle.validation.fillFields.summary"),detail:i("notifications.editArticle.validation.fillFields.detail"),life:3e3});return}try{let l;if(k.value||$.value){p.value=!0;try{const r=k.value?new File([k.value],x.value,{type:"image/webp"}):$.value;l=await ce(r)}catch(r){console.error(r),v.add({severity:"warn",summary:i("notifications.editArticle.upload.previewNotLoaded.summary"),detail:i("notifications.editArticle.upload.previewNotLoaded.detail"),life:4e3})}finally{p.value=!1}}const t={title:w.value.trim(),content:g.value,excerpt:Y(g.value),tags:d.value,status:"published",preview_image:l,difficulty:R.value,author:f.user?.nickname||f.user?.username||"Anonymous"},a=J.value&&E.value&&f.user?.id?await de(E.value,f.user.id,t):await te(t);console.log("ArticleData перед API:",t),console.log("Созданная статья:",a),v.add({severity:"success",summary:i("notifications.editArticle.publish.success.summary"),detail:i("notifications.editArticle.publish.success.detail"),life:4e3}),await z.push("/your-articles")}catch(l){console.error(l),v.add({severity:"error",summary:i("notifications.editArticle.publish.error.summary"),detail:i("notifications.editArticle.publish.error.detail"),life:5e3})}},Y=l=>{const t=l.replace(/<[^>]*>/g,"");return t.length>200?t.substring(0,200)+"...":t},Ae=()=>{B.value||p.value||m.value||(M.value=!0,document.body.style.overflow="hidden")},V=()=>{M.value=!1,document.body.style.overflow=""},ie=()=>{c.value&&(URL.revokeObjectURL(c.value),c.value=null),y.value&&(URL.revokeObjectURL(y.value),y.value=null),$.value=null,k.value=null},_e=async()=>{if(!w.value.trim()){A.value.title=!0,D.value=!0,setTimeout(()=>{D.value=!1},600),v.add({severity:"warn",summary:i("notifications.editArticle.draft.noTitle.summary"),detail:i("notifications.editArticle.draft.noTitle.detail"),life:3e3});return}try{let l;if(k.value||$.value){p.value=!0;try{const r=k.value?new File([k.value],x.value,{type:"image/webp"}):$.value;l=await ce(r)}catch(r){console.error(r)}finally{p.value=!1}}const t={title:w.value.trim(),content:g.value,excerpt:Y(g.value),tags:d.value,status:"draft",preview_image:l,difficulty:R.value,author:f.user?.nickname||f.user?.username||"Anonymous"},a=J.value&&E.value&&f.user?.id?await de(E.value,f.user.id,t):await te(t);console.log("Черновик сохранен:",a),v.add({severity:"success",summary:i("notifications.editArticle.draft.saved.summary"),detail:i("notifications.editArticle.draft.saved.detail"),life:4e3}),await z.push("/your-articles")}catch(l){console.error(l),v.add({severity:"error",summary:i("notifications.editArticle.draft.error.summary"),detail:i("notifications.editArticle.draft.error.detail"),life:5e3})}},se=l=>{l.key==="Escape"&&M.value&&V()};Fe(async()=>{document.addEventListener("click",ae),document.addEventListener("keydown",se);const l=ve.params.id,t=typeof l=="string"?parseInt(l,10):Array.isArray(l)?parseInt(l[0],10):NaN;if(!isNaN(t))try{const a=await Je(t);E.value=a.id,w.value=a.title||"",g.value=a.content||"",d.value=Array.isArray(a.tags)?a.tags:a.tags?String(a.tags).split(",").map(r=>r.trim()).filter(Boolean):[],R.value=a.difficulty||"medium",c.value=a.previewImage||a.preview_image||null}catch{v.add({severity:"error",summary:i("notifications.editArticle.loadError.summary"),detail:i("notifications.editArticle.loadError.detail"),life:4e3})}}),Se(()=>{document.removeEventListener("click",ae),document.removeEventListener("keydown",se),c.value&&URL.revokeObjectURL(c.value),y.value&&URL.revokeObjectURL(y.value)});async function H(l){const t=l.target;if(t.files&&t.files[0]){const a=t.files[0];if(a.size>10*1024*1024){v.add({severity:"warn",summary:i("notifications.editArticle.upload.fileTooLarge.summary"),detail:i("notifications.editArticle.upload.fileTooLarge.detail"),life:4e3}),t.value="",m.value=!1;return}m.value=!0;try{await new Promise(q=>setTimeout(q,500)),c.value&&(URL.revokeObjectURL(c.value),c.value=null),$.value=a,y.value&&URL.revokeObjectURL(y.value);const r=new FileReader;r.onload=q=>{y.value=q.target?.result,U.value=!0},r.readAsDataURL(a)}catch(r){console.error("Ошибка при обработке файла:",r),v.add({severity:"error",summary:i("notifications.editArticle.upload.error.summary"),detail:i("notifications.editArticle.upload.error.detail"),life:4e3}),t.value=""}finally{m.value=!1}}else c.value&&(URL.revokeObjectURL(c.value),c.value=null),$.value=null,m.value=!1}function oe(){y.value&&(U.value=!0)}function ne(){ee.value?.click()}function Ce(){N.value=!0}function $e(){N.value=!1}function Ue(l){N.value=!1;const t=l.dataTransfer?.files;t&&t.length>0&&H({target:{files:t}})}let T=null;function Te(l){T=l}async function Le(){try{!T&&j?.value?.getCroppedImage&&(T=await j.value.getCroppedImage()),T&&(k.value=T,c.value&&URL.revokeObjectURL(c.value),c.value=URL.createObjectURL(T),U.value=!1)}catch(l){console.error(l),v.add({severity:"error",summary:i("notifications.editArticle.upload.cropError.summary"),detail:i("notifications.editArticle.upload.cropError.detail"),life:4e3})}finally{T=null}}return(l,t)=>(n(),u(P,null,[e("div",We,[t[26]||(t[26]=e("div",{class:"header-spacer"},null,-1)),e("div",Ye,[e("div",He,[e("h2",Qe,o(l.$t("create-article.h1")),1),e("h2",Xe,o(l.$t("create-article.h2")),1),e("button",{class:"read-rules-button",type:"button",onClick:t[0]||(t[0]=a=>h(z).push("/legal/community-rules"))},o(l.$t("create-article.button1")),1)]),e("section",Ze,[e("div",{class:C(["uploader-dropzone",{"is-drag":N.value}]),onClick:ne,onDragover:b(Ce,["prevent"]),onDragleave:b($e,["prevent"]),onDrop:b(Ue,["prevent"])},[e("input",{ref_key:"fileInputRef",ref:ee,type:"file",class:"hidden-file-input",accept:"image/*",onChange:H},null,544),c.value?(n(),u("div",et,[e("img",{src:c.value,alt:"Article preview"},null,8,tt),e("div",lt,[e("button",{type:"button",class:"btn subtle",onClick:b(oe,["stop"])},[t[14]||(t[14]=e("i",{class:"pi pi-pencil"},null,-1)),e("span",null,o(l.$t("create-article.imageButtons.crop")),1)]),e("button",{type:"button",class:"btn ghost",onClick:b(ne,["stop"])},[t[15]||(t[15]=e("i",{class:"pi pi-refresh"},null,-1)),e("span",null,o(l.$t("create-article.imageButtons.replace")),1)]),e("button",{type:"button",class:"btn danger",onClick:b(ie,["stop"])},[t[16]||(t[16]=e("i",{class:"pi pi-trash"},null,-1)),e("span",null,o(l.$t("create-article.imageButtons.remove")),1)])])])):(n(),u("div",xe,[...t[13]||(t[13]=[e("i",{class:"pi pi-image"},null,-1),e("h3",null,"Загрузите превью статьи",-1),e("p",null,"Перетащите изображение сюда или нажмите, чтобы выбрать файл",-1),e("span",{class:"hint"},"WebP/JPEG/PNG до 10MB",-1)])]))],34)]),e("div",at,[e("div",it,[e("h3",st,o(l.$t("create-article.imageUpload.title")),1),e("p",ot,o(l.$t("create-article.imageUpload.subtitle")),1)]),e("div",nt,[e("label",{class:C(["file-upload-label",{uploading:p.value||m.value,"has-preview":c.value}])},[e("input",{type:"file",onChange:H,accept:"image/*",class:"file-input",disabled:p.value},null,40,rt),e("div",ut,[I(Z,{name:"fade",mode:"out-in"},{default:X(()=>[p.value||m.value?(n(),u("div",ct,[t[17]||(t[17]=e("div",{class:"spinner"},null,-1)),e("p",dt,o(p.value?l.$t("notifications.editArticle.upload.loading"):l.$t("notifications.editArticle.upload.processing")),1)])):c.value?(n(),u("div",{key:"preview",class:"upload-preview",onClick:t[1]||(t[1]=b(a=>oe(),["prevent"]))},[e("img",{src:c.value,alt:"Preview",class:"upload-preview-img"},null,8,vt),e("div",pt,[t[18]||(t[18]=e("i",{class:"pi pi-image"},null,-1)),e("p",null,o(l.$t("create-article.imageUpload.clickToChange")),1)])])):(n(),u("div",ft,[t[19]||(t[19]=e("i",{class:"pi pi-image"},null,-1)),e("p",mt,o(l.$t("create-article.imageUpload.clickToUpload")),1),e("span",yt,o(l.$t("create-article.imageUpload.formats")),1)]))]),_:1})])],2),c.value&&!p.value&&!m.value?(n(),u("button",{key:0,onClick:ie,class:"remove-preview-btn",type:"button"},[t[20]||(t[20]=e("i",{class:"pi pi-times"},null,-1)),e("span",null,o(l.$t("create-article.imageButtons.remove")),1)])):_("",!0)])]),e("div",gt,[e("h2",ht,o(l.$t("create-article.h4")),1),e("h2",bt,o(l.$t("create-article.h5")),1),re(e("input",{type:"text",placeholder:"Enter title...",class:C(["title-input",{invalid:A.value.title}]),"onUpdate:modelValue":t[2]||(t[2]=a=>w.value=a)},null,2),[[ue,w.value]])]),e("div",{class:C(["edit-block",{shake:D.value}])},[e("div",{class:C(["editor-wrapper",{invalid:A.value.content}])},[I(h(Pe),{modelValue:g.value,"onUpdate:modelValue":t[3]||(t[3]=a=>g.value=a),editorStyle:"height: 500px;"},null,8,["modelValue"])],2),e("div",wt,[e("h2",kt,o(l.$t("create-article.h6")||"Теги статьи"),1),e("h2",At,o(l.$t("create-article.h7")||"Выберите до 5 тегов для вашей статьи"),1),d.value.length>0?(n(),u("div",_t,[(n(!0),u(P,null,K(d.value,a=>(n(),u("div",{key:a,class:C(["custom-tag-wrapper",`tag-${h(fe)(a)}`])},[e("span",Ct,o(a),1),e("button",{onClick:r=>ge(a),class:"tag-remove-btn",type:"button","aria-label":l.$t("notifications.editArticle.removeTag",{tag:a})},[...t[21]||(t[21]=[e("i",{class:"pi pi-times"},null,-1)])],8,$t)],2))),128))])):_("",!0),e("div",Ut,[re(e("input",{type:"text","onUpdate:modelValue":t[4]||(t[4]=a=>F.value=a),onInput:he,onFocus:t[5]||(t[5]=a=>O.value=!0),onKeydown:Me(b(be,["prevent"]),["enter"]),placeholder:d.value.length>=5?l.$t("create-article.tags.placeholderMax"):l.$t("create-article.tags.placeholder"),disabled:d.value.length>=5,class:C(["tags-input-field",{invalid:A.value.tags}])},null,42,Tt),[[ue,F.value]]),O.value&&S.value.length>0&&d.value.length<5?(n(),u("div",Lt,[(n(!0),u(P,null,K(S.value,a=>(n(),u("div",{key:a,onClick:r=>W(a),class:"suggestion-item"},o(a),9,Rt))),128))])):_("",!0)]),e("p",Et,o(l.$t("create-article.tagsCounter",{count:d.value.length,max:5})),1)]),e("div",It,[e("h2",Dt,o(l.$t("create-article.h8")),1),e("h2",Ft,o(l.$t("create-article.h9")),1),e("div",Ot,[(n(!0),u(P,null,K(ye.value,(a,r)=>(n(),u("button",{key:r,class:C(["difficulty-circle",`difficulty-${r}`,{selected:R.value===r}]),onClick:q=>we(r),type:"button",title:a},[I(h(qe),{class:"difficulty-icon"})],10,St))),128))])]),e("div",Bt,[e("button",{class:"create-button",onClick:ke,disabled:h(B)||p.value||m.value},[h(B)?(n(),u("i",jt)):(n(),u("i",Mt)),e("p",Nt,o(J.value?l.$t("create-article.button5"):l.$t("create-article.button2")),1)],8,Pt),e("button",{class:"preview-button",onClick:Ae,disabled:h(B)||p.value||m.value},[t[22]||(t[22]=e("i",{class:"pi pi-eye button-icon"},null,-1)),e("p",qt,o(l.$t("create-article.button3")),1)],8,Vt),e("button",{class:"draft-button",onClick:_e,disabled:h(B)||p.value||m.value},[t[23]||(t[23]=e("i",{class:"pi pi-save button-icon"},null,-1)),e("p",zt,o(l.$t("create-article.button4")),1)],8,Kt)]),h(le)?(n(),u("div",Gt,[e("p",Jt,o(h(le)),1)])):_("",!0)],2)]),I(Z,{name:"modal-fade"},{default:X(()=>[M.value?(n(),u("div",{key:0,class:"preview-modal-overlay",onClick:V},[e("div",{class:"preview-modal",onClick:t[6]||(t[6]=b(()=>{},["stop"]))},[e("div",Wt,[e("h2",Yt,o(l.$t("create-article.previewModal.title")),1),e("button",{class:"preview-modal-close",onClick:V,type:"button"},[...t[24]||(t[24]=[e("i",{class:"pi pi-times"},null,-1)])])]),e("div",Ht,[I(Ke,{article:pe.value,onArticleDeleted:V},null,8,["article"])])])])):_("",!0)]),_:1}),I(Z,{name:"toast-slide"},{default:X(()=>[G.value?(n(),u("div",Qt,[e("div",Xt,[e("span",Zt,o(l.$t("notifications.editArticle.validation.title")),1),e("button",{class:"validation-toast-close",onClick:t[7]||(t[7]=a=>G.value=!1),type:"button","aria-label":l.$t("common.close")},[...t[25]||(t[25]=[e("i",{class:"pi pi-times"},null,-1)])],8,xt)]),e("div",el,[e("p",tl,o(l.$t("notifications.editArticle.validation.intro")),1),e("ul",ll,[(n(!0),u(P,null,K(L.value,(a,r)=>(n(),u("li",{key:r},o(a),1))),128))])])])):_("",!0)]),_:1})]),U.value?(n(),u("div",{key:0,class:"preview-modal-overlay",onClick:t[12]||(t[12]=a=>U.value=!1)},[e("div",{class:"preview-modal",onClick:t[11]||(t[11]=b(()=>{},["stop"])),style:{width:"min(96vw, 1280px)","max-height":"90vh"}},[e("div",al,[e("h2",il,o(l.$t("create-article.cropperModal.title")),1),e("button",{class:"preview-modal-close",onClick:t[8]||(t[8]=a=>U.value=!1),type:"button"},[...t[27]||(t[27]=[e("i",{class:"pi pi-times"},null,-1)])])]),e("div",sl,[y.value?(n(),je(ze,{key:0,imageUrl:y.value,shape:"square",outputSize:1024,outputType:"image/webp",maxBytes:5e5,maintainAspect:!1,onCrop:Te,ref_key:"articleCropperRef",ref:j},null,8,["imageUrl"])):_("",!0)]),e("div",ol,[e("button",{class:"btn ghost",type:"button",onClick:t[9]||(t[9]=a=>j.value?.selectFull?.())},[...t[28]||(t[28]=[e("i",{class:"pi pi-expand"},null,-1),e("span",null,"Вся область",-1)])]),t[31]||(t[31]=e("div",{class:"grow"},null,-1)),e("button",{class:"btn subtle",onClick:t[10]||(t[10]=a=>U.value=!1),type:"button"},[...t[29]||(t[29]=[e("i",{class:"pi pi-times"},null,-1),e("span",null,"Отмена",-1)])]),e("button",{class:"btn primary",onClick:Le,type:"button"},[...t[30]||(t[30]=[e("i",{class:"pi pi-check"},null,-1),e("span",null,"Применить",-1)])])])])])):_("",!0)],64))}}),yl=Ne(nl,[["__scopeId","data-v-663c0eb9"]]);export{yl as default};
