# üîç –û–¢–õ–ê–î–ö–ê OAuth2

## ‚úÖ –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:

1. **–ó–∞–º–µ–Ω–µ–Ω—ã –≤—Å–µ `/login` –Ω–∞ `/auth`** –≤–æ –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö
2. **–î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –≤ `strapi-server.ts` –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
3. **–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–æ–∫–µ–Ω–∞ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –≤ router guard** - —Ç–µ–ø–µ—Ä—å —Ç–æ–∫–µ–Ω –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è —Å—Ä–∞–∑—É –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ `/auth/callback`
4. **–£–ø—Ä–æ—â—ë–Ω `AuthCallback.vue`** - —Ç–µ–ø–µ—Ä—å –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∑–∞–≥—Ä—É–∑–∫—É/–æ—à–∏–±–∫—É

---

## üêõ –û—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞:

**–í –ª–æ–≥–∞—Ö Strapi:**
```
http: GET /api/users/me (2 ms) 401
```

**–≠—Ç–æ –∑–Ω–∞—á–∏—Ç:** –¢–æ–∫–µ–Ω –ø—Ä–∏—Ö–æ–¥–∏—Ç, –Ω–æ Strapi –µ–≥–æ –Ω–µ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç.

---

## üîß –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –∏ —Ä–µ—à–µ–Ω–∏—è:

### 1. –ü—Ä–∞–≤–∞ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –≤ Strapi Admin

**–ü—Ä–æ–≤–µ—Ä—å:**
1. –û—Ç–∫—Ä–æ–π http://localhost:1337/admin
2. **Settings** ‚Üí **Roles** ‚Üí **Authenticated**
3. –ü—Ä–æ–∫—Ä—É—Ç–∏ –¥–æ **Permissions** ‚Üí **Users-permissions**
4. –£–±–µ–¥–∏—Å—å, —á—Ç–æ —Å—Ç–æ–∏—Ç –≥–∞–ª–æ—á–∫–∞: ‚úÖ **`me` (GET)**
5. **–ù–∞–∂–º–∏ "Save"**

**–ï—Å–ª–∏ –Ω–µ –≤–∏–¥–∏—à—å `me` –≤ —Å–ø–∏—Å–∫–µ:**
- –í–æ–∑–º–æ–∂–Ω–æ, –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å Strapi
- –ò–ª–∏ —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–æ–±–ª–µ–º–∞ —Å –≤–µ—Ä—Å–∏–µ–π Strapi

---

### 2. –¢–æ–∫–µ–Ω –Ω–µ —Ç–æ—Ç —Ñ–æ—Ä–º–∞—Ç (Google token –≤–º–µ—Å—Ç–æ Strapi JWT)

**–ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:**
1. –û—Ç–∫—Ä–æ–π Browser DevTools ‚Üí Console
2. –ü–æ—Å–ª–µ –ø–æ–ø—ã—Ç–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–∞–π–¥–∏ –ª–æ–≥: `üîµ Router guard: Found access_token in URL`
3. –ü–æ—Å–º–æ—Ç—Ä–∏ —Ç–æ–∫–µ–Ω –≤ localStorage: `localStorage.getItem('jwt')`
4. **Strapi JWT** –æ–±—ã—á–Ω–æ –≤—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫: `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...` (—Ç—Ä–∏ —á–∞—Å—Ç–∏, —Ä–∞–∑–¥–µ–ª—ë–Ω–Ω—ã–µ —Ç–æ—á–∫–∞–º–∏)
5. **Google token** –≤—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫: `ya29.a0ATi6K2u4mq7xk...` (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å `ya29`)

**–ï—Å–ª–∏ —Ç–æ–∫–µ–Ω Google (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å `ya29`):**
- –ü—Ä–æ–±–ª–µ–º–∞ –≤ `strapi-server.ts` - callback –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç Strapi JWT
- –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏ Strapi - –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å: `‚úÖ OAuth success for user: ...`

---

### 3. Callback –Ω–µ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ

**–ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:**
1. –û—Ç–∫—Ä–æ–π —Ç–µ—Ä–º–∏–Ω–∞–ª —Å–æ Strapi
2. –ü–æ–ø—Ä–æ–±—É–π –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ Google
3. **–î–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è –ª–æ–≥–∏:**
   ```
   üîµ OAuth callback called for provider: google
   üîµ Query params: { code: '...', ... }
   üîµ OAuth connect result: { hasUser: true, hasJwt: true, ... }
   ‚úÖ OAuth success for user: your-email@gmail.com, JWT length: 123
   ```

**–ï—Å–ª–∏ —ç—Ç–∏—Ö –ª–æ–≥–æ–≤ –ù–ï–¢:**
- `strapi-server.ts` –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è
- –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ —Ñ–∞–π–ª –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤: `backend/strapi-backend/src/extensions/users-permissions/strapi-server.ts`
- –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ Strapi

---

### 4. –ü—Ä–æ–±–ª–µ–º–∞ —Å CORS –∏–ª–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏

**–ü—Ä–æ–≤–µ—Ä—å:**
1. Browser DevTools ‚Üí Network
2. –ù–∞–π–¥–∏ –∑–∞–ø—Ä–æ—Å `GET /api/users/me`
3. –ü—Ä–æ–≤–µ—Ä—å **Request Headers**:
   ```
   Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
   ```
4. –ü—Ä–æ–≤–µ—Ä—å **Response Headers** - –Ω–µ—Ç –ª–∏ –æ—à–∏–±–æ–∫ CORS

---

## üß™ –ö–∞–∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å:

### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä—å Strapi –ª–æ–≥–∏

–û—Ç–∫—Ä–æ–π —Ç–µ—Ä–º–∏–Ω–∞–ª —Å–æ Strapi –∏ –ø–æ–ø—Ä–æ–±—É–π –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è. –î–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è –ª–æ–≥–∏:

```
üîµ OAuth callback called for provider: google
üîµ Query params: { code: '4/0Ab32j90...', scope: '...', ... }
üîµ OAuth connect result: {
  hasUser: true,
  hasJwt: true,
  userId: 1,
  userEmail: 'your-email@gmail.com',
  jwtLength: 123,
  jwtPreview: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'
}
‚úÖ OAuth success for user: your-email@gmail.com, JWT length: 123
üîµ Redirecting to: http://localhost:5173/auth/callback?access_token=...
```

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä—å Browser Console

–ü–æ—Å–ª–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ –Ω–∞ `/auth/callback` –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è –ª–æ–≥–∏:

```
üîµ Router guard: Found access_token in URL, processing...
```

**–ï—Å–ª–∏ –∑–∞—Ç–µ–º –ø–æ—è–≤–ª—è–µ—Ç—Å—è:**
```
‚ùå Failed to fetch user: 401
```

**–ó–Ω–∞—á–∏—Ç –ø—Ä–æ–±–ª–µ–º–∞ –≤ –ø—Ä–∞–≤–∞—Ö Strapi –∏–ª–∏ —Ñ–æ—Ä–º–∞—Ç–µ —Ç–æ–∫–µ–Ω–∞.**

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä—å localStorage

–ü–æ—Å–ª–µ –ø–æ–ø—ã—Ç–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:
1. Browser DevTools ‚Üí Application ‚Üí Local Storage
2. –ü—Ä–æ–≤–µ—Ä—å –∫–ª—é—á `jwt`
3. –¢–æ–∫–µ–Ω –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å `eyJ` (Strapi JWT), –∞ –Ω–µ `ya29` (Google token)

---

## üìù –ß—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ:

1. **–ü–æ–ø—Ä–æ–±—É–π –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è —Å–Ω–æ–≤–∞**
2. **–ü–æ—Å–º–æ—Ç—Ä–∏ –ª–æ–≥–∏ Strapi** - –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è –ª–æ–≥–∏ —Å üîµ
3. **–ü–æ—Å–º–æ—Ç—Ä–∏ Browser Console** - –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è –ª–æ–≥–∏ —Å üîµ
4. **–ï—Å–ª–∏ –≤—Å—ë —Ä–∞–≤–Ω–æ 401:**
   - –ü—Ä–æ–≤–µ—Ä—å –ø—Ä–∞–≤–∞ –≤ Strapi Admin (—à–∞–≥ 1 –≤—ã—à–µ)
   - –ü—Ä–æ–≤–µ—Ä—å —Ñ–æ—Ä–º–∞—Ç —Ç–æ–∫–µ–Ω–∞ (—à–∞–≥ 2 –≤—ã—à–µ)
   - –ü—Ä–∏—à–ª–∏ –º–Ω–µ –ª–æ–≥–∏ Strapi –∏ Browser Console

---

## üéØ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:
1. ‚úÖ Strapi –ª–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç: `‚úÖ OAuth success for user: ...`
2. ‚úÖ Browser Console –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç: `üîµ Router guard: Found access_token...`
3. ‚úÖ –ó–∞–ø—Ä–æ—Å `GET /api/users/me` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç **200 OK** (–Ω–µ 401!)
4. ‚úÖ –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ `/auth/finalize` –∏–ª–∏ `/` (–µ—Å–ª–∏ username —É–∂–µ –µ—Å—Ç—å)
5. ‚úÖ –í localStorage –µ—Å—Ç—å `jwt` (Strapi JWT, –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å `eyJ`)

---

**–ü–æ–ø—Ä–æ–±—É–π —Å–µ–π—á–∞—Å –∏ –ø—Ä–∏—à–ª–∏ –º–Ω–µ –ª–æ–≥–∏! üöÄ**


