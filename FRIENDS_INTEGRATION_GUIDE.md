# üë• –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º—ã –¥—Ä—É–∑–µ–π —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö

## üìã –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ
1. [–û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã](#–æ–±–∑–æ—Ä-—Å–∏—Å—Ç–µ–º—ã)
2. [–°—Ç—Ä—É–∫—Ç—É—Ä–∞ Strapi](#—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-strapi)
3. [API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã](#api-—ç–Ω–¥–ø–æ–∏–Ω—Ç—ã)
4. [–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º](#–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è-—Å-—Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º)
5. [Real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è](#real-time-–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è)
6. [–ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å](#–ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å-–∏-–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)
7. [–ß–µ–∫–ª–∏—Å—Ç –º–∏–≥—Ä–∞—Ü–∏–∏](#—á–µ–∫–ª–∏—Å—Ç-–º–∏–≥—Ä–∞—Ü–∏–∏)

---

## üéØ –û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã

–°–∏—Å—Ç–µ–º–∞ –¥—Ä—É–∑–µ–π Aetheris –≤–∫–ª—é—á–∞–µ—Ç:
- **–°–ø–∏—Å–æ–∫ –¥—Ä—É–∑–µ–π** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –¥—Ä—É–∂–µ—Å–∫–∏–º–∏ —Å–≤—è–∑—è–º–∏
- **–ó–∞–ø—Ä–æ—Å—ã –≤ –¥—Ä—É–∑—å—è** - –æ—Ç–ø—Ä–∞–≤–∫–∞, –ø—Ä–∏–Ω—è—Ç–∏–µ –∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤
- **–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π** - –ø–æ–∏—Å–∫ –Ω–æ–≤—ã—Ö –¥—Ä—É–∑–µ–π –ø–æ –∏–º–µ–Ω–∏ –∏ –∏–Ω—Ç–µ—Ä–µ—Å–∞–º
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏** - —É–º–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –¥—Ä—É–∑–µ–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ–±—â–∏—Ö —Å–≤—è–∑–µ–π –∏ –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤
- **–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –¥—Ä—É–∑–µ–π** - –ª–µ–Ω—Ç–∞ –¥–µ–π—Å—Ç–≤–∏–π –¥—Ä—É–∑–µ–π
- **–ò–∑–±—Ä–∞–Ω–Ω—ã–µ –¥—Ä—É–∑—å—è** - –ø–æ–º–µ—Ç–∫–∞ –≤–∞–∂–Ω—ã—Ö –¥—Ä—É–∑–µ–π
- **–¢–µ–≥–∏ –∏ –∑–∞–º–µ—Ç–∫–∏** - –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –¥—Ä—É–∑–µ–π —Å –ø–æ–º–æ—â—å—é —Ç–µ–≥–æ–≤ –∏ –ª–∏—á–Ω—ã—Ö –∑–∞–º–µ—Ç–æ–∫
- **–û–Ω–ª–∞–π–Ω —Å—Ç–∞—Ç—É—Å** - –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –¥—Ä—É–∑–µ–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

---

## üóÑÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ Strapi

### 1. Content Type: `FriendRequest`

```typescript
{
  // Relations
  sender: relation (User, many-to-one)
  receiver: relation (User, many-to-one)
  
  // Status
  status: enumeration ['pending', 'accepted', 'declined'] (required, default: 'pending')
  
  // Message
  message: text (optional, max 500 chars)
  
  // Timestamps
  createdAt: datetime (auto)
  updatedAt: datetime (auto)
  respondedAt: datetime (nullable) // When request was accepted/declined
}
```

**Unique constraint:** `sender` + `receiver` (one request per pair)

**Hooks –¥–ª—è FriendRequest:**
```typescript
// beforeCreate
- Check if users are already friends
- Check if reverse request exists (receiver -> sender)
- Check rate limiting (max 10 requests per day)
- Validate that sender !== receiver

// afterCreate
- Send notification to receiver
- Update sender's sentRequests count
- Update receiver's pendingRequests count

// afterUpdate (status change to 'accepted')
- Create Friendship record
- Delete the request
- Send notification to sender
- Update both users' friend counts

// afterUpdate (status change to 'declined')
- Send notification to sender (optional)
- Delete the request after 7 days (cleanup job)
```

---

### 2. Content Type: `Friendship`

```typescript
{
  // Relations
  user: relation (User, many-to-one)
  friend: relation (User, many-to-one)
  
  // Metadata
  isFavorite: boolean (default: false)
  notes: text (nullable, private notes about friend)
  tags: json (array of strings, for organizing friends)
  
  // Timestamps
  createdAt: datetime (auto) // When friendship was established
  updatedAt: datetime (auto)
}
```

**Unique constraint:** `user` + `friend` (bidirectional, create two records for each friendship)

**Hooks –¥–ª—è Friendship:**
```typescript
// afterCreate
- Create reverse friendship (friend -> user)
- Update both users' totalFriends count
- Send notification

// afterDelete
- Delete reverse friendship
- Update both users' totalFriends count
- Send notification (optional)
```

---

### 3. Content Type: `FriendActivity`

```typescript
{
  // Relations
  user: relation (User, many-to-one) // User who performed the action
  
  // Activity details
  type: enumeration [
    'article_published',
    'course_created',
    'achievement_unlocked',
    'level_up',
    'joined_event',
    'comment_posted',
    'project_shared'
  ] (required)
  
  title: string (required, max 200 chars)
  description: text (nullable, max 500 chars)
  link: string (nullable) // Link to the activity
  
  // Metadata
  metadata: json (nullable) // Additional data specific to activity type
  
  // Visibility
  isPublic: boolean (default: true) // Can be seen by friends
  
  // Timestamps
  timestamp: datetime (required)
  createdAt: datetime (auto)
}
```

**Hooks –¥–ª—è FriendActivity:**
```typescript
// afterCreate
- Notify friends about new activity
- Update activity feed cache

// Cleanup job (cron)
- Delete activities older than 30 days
```

---

### 4. –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ User Content Type

–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π User:

```typescript
{
  // ... existing fields
  
  // Friend-related
  totalFriends: number (default: 0)
  pendingRequests: number (default: 0) // Received requests
  sentRequests: number (default: 0)
  
  // Online status
  isOnline: boolean (default: false)
  lastSeen: datetime (nullable)
  
  // Privacy settings
  friendPrivacy: enumeration ['everyone', 'friends_of_friends', 'nobody'] (default: 'everyone')
  activityPrivacy: enumeration ['public', 'friends', 'private'] (default: 'friends')
  onlineStatusVisible: boolean (default: true)
  
  // Relations
  friends: relation (Friendship, one-to-many, field: 'user')
  sentFriendRequests: relation (FriendRequest, one-to-many, field: 'sender')
  receivedFriendRequests: relation (FriendRequest, one-to-many, field: 'receiver')
  activities: relation (FriendActivity, one-to-many)
}
```

---

### 5. Content Type: `BlockedUser` (–¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)

```typescript
{
  // Relations
  blocker: relation (User, many-to-one) // User who blocked
  blocked: relation (User, many-to-one) // User who was blocked
  
  // Reason
  reason: enumeration ['spam', 'harassment', 'inappropriate', 'other'] (nullable)
  notes: text (nullable)
  
  // Timestamps
  createdAt: datetime (auto)
}
```

**Unique constraint:** `blocker` + `blocked`

---

## üîå API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

### Friends

```typescript
// GET /api/friends
// Query params: search, tags, onlineOnly, favorites, sortBy, pagination
// Returns: { data: Friendship[], meta: { pagination, stats } }

// GET /api/friends/:id
// Returns: { data: Friendship }

// DELETE /api/friends/:id
// Remove friend
// Returns: { data: { success: true } }

// PUT /api/friends/:id
// Update friendship (favorite, notes, tags)
// Body: { isFavorite?: boolean, notes?: string, tags?: string[] }
// Returns: { data: Friendship }
```

### Friend Requests

```typescript
// GET /api/friends/requests/received
// Get received friend requests
// Query params: pagination
// Returns: { data: FriendRequest[], meta: { pagination } }

// GET /api/friends/requests/sent
// Get sent friend requests
// Query params: pagination
// Returns: { data: FriendRequest[], meta: { pagination } }

// POST /api/friends/requests
// Send friend request
// Body: { receiverId: string, message?: string }
// Returns: { data: FriendRequest }

// PUT /api/friends/requests/:id/accept
// Accept friend request
// Returns: { data: Friendship }

// PUT /api/friends/requests/:id/decline
// Decline friend request
// Returns: { data: { success: true } }

// DELETE /api/friends/requests/:id
// Cancel sent request
// Returns: { data: { success: true } }
```

### Friend Suggestions

```typescript
// GET /api/friends/suggestions
// Get friend suggestions based on mutual friends and interests
// Query params: limit (default: 10)
// Returns: { 
//   data: Array<{
//     user: User,
//     reason: 'mutual_friends' | 'same_interests' | 'same_location' | 'popular',
//     mutualFriends?: User[],
//     commonTags?: string[],
//     score: number
//   }>
// }
```

### User Search

```typescript
// GET /api/friends/search
// Search users by username, displayName, bio
// Query params: q (query), limit, offset
// Returns: { data: User[], meta: { pagination } }
```

### Friend Activity

```typescript
// GET /api/friends/activity
// Get friends' recent activity
// Query params: limit (default: 20), offset
// Returns: { data: FriendActivity[], meta: { pagination } }

// POST /api/friends/activity
// Create activity (automatic from other actions)
// Body: { type, title, description?, link?, metadata? }
// Returns: { data: FriendActivity }
```

### Statistics

```typescript
// GET /api/friends/stats
// Get friendship statistics
// Returns: {
//   data: {
//     totalFriends: number,
//     onlineFriends: number,
//     pendingRequests: number,
//     sentRequests: number,
//     mutualFriends: number,
//     recentActivity: number
//   }
// }
```

### Blocking

```typescript
// POST /api/friends/block
// Block a user
// Body: { userId: string, reason?: string, notes?: string }
// Returns: { data: BlockedUser }

// DELETE /api/friends/block/:id
// Unblock a user
// Returns: { data: { success: true } }

// GET /api/friends/blocked
// Get blocked users list
// Returns: { data: BlockedUser[] }
```

---

## üé® –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º

### 1. –°–æ–∑–¥–∞—Ç—å API –∫–ª–∏–µ–Ω—Ç

**–§–∞–π–ª:** `frontend-react/src/api/friends.ts`

```typescript
import { api } from './client'
import type {
  FriendUser,
  Friendship,
  FriendRequest,
  FriendSuggestion,
  FriendActivity,
  FriendStats,
  FriendsFilters,
} from '@/types/friends'

export const friendsApi = {
  // Get friends list
  getFriends: async (filters?: FriendsFilters) => {
    const params = new URLSearchParams()
    
    if (filters?.search) params.append('filters[friend][username][$containsi]', filters.search)
    if (filters?.onlineOnly) params.append('filters[friend][isOnline][$eq]', 'true')
    if (filters?.favorites) params.append('filters[isFavorite][$eq]', 'true')
    if (filters?.tags?.length) {
      filters.tags.forEach(tag => params.append('filters[tags][$contains]', tag))
    }
    if (filters?.sortBy) {
      const sortMap = {
        name: 'friend.username:asc',
        recent: 'createdAt:desc',
        reputation: 'friend.reputation:desc',
        level: 'friend.level:desc',
      }
      params.append('sort', sortMap[filters.sortBy])
    }
    
    params.append('populate', 'friend')
    
    const response = await api.get(`/friends?${params.toString()}`)
    return response.data
  },

  // Remove friend
  removeFriend: async (friendshipId: string) => {
    const response = await api.delete(`/friends/${friendshipId}`)
    return response.data
  },

  // Update friendship
  updateFriendship: async (
    friendshipId: string,
    data: { isFavorite?: boolean; notes?: string; tags?: string[] }
  ) => {
    const response = await api.put(`/friends/${friendshipId}`, { data })
    return response.data.data as Friendship
  },

  // Get received requests
  getReceivedRequests: async () => {
    const response = await api.get('/friends/requests/received?populate=sender')
    return response.data.data as FriendRequest[]
  },

  // Get sent requests
  getSentRequests: async () => {
    const response = await api.get('/friends/requests/sent?populate=receiver')
    return response.data.data as FriendRequest[]
  },

  // Send friend request
  sendFriendRequest: async (receiverId: string, message?: string) => {
    const response = await api.post('/friends/requests', {
      data: { receiver: receiverId, message },
    })
    return response.data.data as FriendRequest
  },

  // Accept friend request
  acceptFriendRequest: async (requestId: string) => {
    const response = await api.put(`/friends/requests/${requestId}/accept`)
    return response.data.data as Friendship
  },

  // Decline friend request
  declineFriendRequest: async (requestId: string) => {
    const response = await api.put(`/friends/requests/${requestId}/decline`)
    return response.data
  },

  // Cancel sent request
  cancelFriendRequest: async (requestId: string) => {
    const response = await api.delete(`/friends/requests/${requestId}`)
    return response.data
  },

  // Get friend suggestions
  getSuggestions: async (limit = 10) => {
    const response = await api.get(`/friends/suggestions?limit=${limit}`)
    return response.data.data as FriendSuggestion[]
  },

  // Search users
  searchUsers: async (query: string, limit = 20) => {
    const response = await api.get(`/friends/search?q=${encodeURIComponent(query)}&limit=${limit}`)
    return response.data.data as FriendUser[]
  },

  // Get friend activity
  getFriendActivity: async (limit = 20) => {
    const response = await api.get(`/friends/activity?limit=${limit}&populate=user`)
    return response.data.data as FriendActivity[]
  },

  // Get statistics
  getStats: async () => {
    const response = await api.get('/friends/stats')
    return response.data.data as FriendStats
  },

  // Block user
  blockUser: async (userId: string, reason?: string, notes?: string) => {
    const response = await api.post('/friends/block', {
      data: { blocked: userId, reason, notes },
    })
    return response.data
  },

  // Unblock user
  unblockUser: async (blockId: string) => {
    const response = await api.delete(`/friends/block/${blockId}`)
    return response.data
  },

  // Get blocked users
  getBlockedUsers: async () => {
    const response = await api.get('/friends/blocked?populate=blocked')
    return response.data.data
  },
}
```

---

### 2. –û–±–Ω–æ–≤–∏—Ç—å FriendsPage –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è API

**–§–∞–π–ª:** `frontend-react/src/pages/FriendsPage.tsx`

–ó–∞–º–µ–Ω–∏—Ç—å –∏–º–ø–æ—Ä—Ç –º–æ–∫-–¥–∞–Ω–Ω—ã—Ö:

```typescript
// ‚ùå –£–¥–∞–ª–∏—Ç—å
import {
  mockFriendships,
  mockReceivedRequests,
  mockSentRequests,
  mockSuggestions,
  mockFriendActivity,
  mockFriendStats,
  mockUsers,
} from '@/data/friendsMockData'

// ‚úÖ –î–æ–±–∞–≤–∏—Ç—å
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query'
import { friendsApi } from '@/api/friends'
import { Skeleton } from '@/components/ui/skeleton'
import { useToast } from '@/hooks/use-toast'
```

–ó–∞–º–µ–Ω–∏—Ç—å useState –Ω–∞ useQuery:

```typescript
// Friends list
const { data: friendships, isLoading: friendsLoading } = useQuery({
  queryKey: ['friends', { searchQuery, onlineOnly, favoritesOnly }],
  queryFn: () => friendsApi.getFriends({
    search: searchQuery,
    onlineOnly,
    favorites: favoritesOnly,
  }),
})

// Received requests
const { data: receivedRequests } = useQuery({
  queryKey: ['friendRequests', 'received'],
  queryFn: () => friendsApi.getReceivedRequests(),
})

// Sent requests
const { data: sentRequests } = useQuery({
  queryKey: ['friendRequests', 'sent'],
  queryFn: () => friendsApi.getSentRequests(),
})

// Suggestions
const { data: suggestions } = useQuery({
  queryKey: ['friendSuggestions'],
  queryFn: () => friendsApi.getSuggestions(),
})

// Activity
const { data: friendActivity } = useQuery({
  queryKey: ['friendActivity'],
  queryFn: () => friendsApi.getFriendActivity(),
})

// Stats
const { data: stats } = useQuery({
  queryKey: ['friendStats'],
  queryFn: () => friendsApi.getStats(),
})

// Search users
const { data: searchResults } = useQuery({
  queryKey: ['userSearch', searchQuery],
  queryFn: () => friendsApi.searchUsers(searchQuery),
  enabled: !!searchQuery && activeTab === 'search',
})
```

–î–æ–±–∞–≤–∏—Ç—å mutations:

```typescript
const queryClient = useQueryClient()
const { toast } = useToast()

// Accept friend request
const acceptRequestMutation = useMutation({
  mutationFn: (requestId: string) => friendsApi.acceptFriendRequest(requestId),
  onSuccess: () => {
    queryClient.invalidateQueries(['friendRequests'])
    queryClient.invalidateQueries(['friends'])
    queryClient.invalidateQueries(['friendStats'])
    toast({
      title: '–ó–∞–ø—Ä–æ—Å –ø—Ä–∏–Ω—è—Ç',
      description: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω –≤ –¥—Ä—É–∑—å—è',
    })
  },
})

// Decline friend request
const declineRequestMutation = useMutation({
  mutationFn: (requestId: string) => friendsApi.declineFriendRequest(requestId),
  onSuccess: () => {
    queryClient.invalidateQueries(['friendRequests'])
    queryClient.invalidateQueries(['friendStats'])
    toast({
      title: '–ó–∞–ø—Ä–æ—Å –æ—Ç–∫–ª–æ–Ω–µ–Ω',
    })
  },
})

// Send friend request
const sendRequestMutation = useMutation({
  mutationFn: ({ userId, message }: { userId: string; message?: string }) =>
    friendsApi.sendFriendRequest(userId, message),
  onSuccess: () => {
    queryClient.invalidateQueries(['friendRequests'])
    queryClient.invalidateQueries(['friendStats'])
    toast({
      title: '–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω',
      description: '–û–∂–∏–¥–∞–π—Ç–µ –æ—Ç–≤–µ—Ç–∞ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
    })
  },
})

// Cancel friend request
const cancelRequestMutation = useMutation({
  mutationFn: (requestId: string) => friendsApi.cancelFriendRequest(requestId),
  onSuccess: () => {
    queryClient.invalidateQueries(['friendRequests'])
    queryClient.invalidateQueries(['friendStats'])
    toast({
      title: '–ó–∞–ø—Ä–æ—Å –æ—Ç–º–µ–Ω–µ–Ω',
    })
  },
})

// Remove friend
const removeFriendMutation = useMutation({
  mutationFn: (friendshipId: string) => friendsApi.removeFriend(friendshipId),
  onSuccess: () => {
    queryClient.invalidateQueries(['friends'])
    queryClient.invalidateQueries(['friendStats'])
    toast({
      title: '–î—Ä—É–≥ —É–¥–∞–ª–µ–Ω',
    })
  },
})

// Update friendship
const updateFriendshipMutation = useMutation({
  mutationFn: ({ id, data }: { id: string; data: any }) =>
    friendsApi.updateFriendship(id, data),
  onSuccess: () => {
    queryClient.invalidateQueries(['friends'])
    toast({
      title: '–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã',
    })
  },
})
```

---

## üîÑ Real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

### 1. WebSocket –¥–ª—è –æ–Ω–ª–∞–π–Ω —Å—Ç–∞—Ç—É—Å–∞

**–£—Å—Ç–∞–Ω–æ–≤–∫–∞:**
```bash
npm install socket.io-client
```

**–§–∞–π–ª:** `frontend-react/src/services/socket.ts`

```typescript
import { io, Socket } from 'socket.io-client'

class SocketService {
  private socket: Socket | null = null

  connect(userId: string) {
    this.socket = io(process.env.VITE_WS_URL || 'ws://localhost:1337', {
      auth: {
        token: localStorage.getItem('jwt'),
      },
    })

    this.socket.on('connect', () => {
      console.log('WebSocket connected')
      this.socket?.emit('user:online', { userId })
    })

    this.socket.on('friend:online', ({ friendId }) => {
      // Update friend online status in cache
      console.log('Friend came online:', friendId)
    })

    this.socket.on('friend:offline', ({ friendId }) => {
      // Update friend offline status in cache
      console.log('Friend went offline:', friendId)
    })

    this.socket.on('friend:request', ({ request }) => {
      // Show notification about new friend request
      console.log('New friend request:', request)
    })

    this.socket.on('friend:accepted', ({ friendship }) => {
      // Show notification about accepted request
      console.log('Friend request accepted:', friendship)
    })

    this.socket.on('friend:activity', ({ activity }) => {
      // Update activity feed
      console.log('New friend activity:', activity)
    })
  }

  disconnect() {
    if (this.socket) {
      this.socket.disconnect()
      this.socket = null
    }
  }

  updateOnlineStatus(isOnline: boolean) {
    this.socket?.emit('user:status', { isOnline })
  }
}

export const socketService = new SocketService()
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ App.tsx:**

```typescript
import { socketService } from '@/services/socket'

function App() {
  const user = useAuthStore((state) => state.user)

  useEffect(() => {
    if (user) {
      socketService.connect(user.id)
      
      // Update online status on visibility change
      const handleVisibilityChange = () => {
        socketService.updateOnlineStatus(!document.hidden)
      }
      
      document.addEventListener('visibilitychange', handleVisibilityChange)
      
      return () => {
        document.removeEventListener('visibilitychange', handleVisibilityChange)
        socketService.disconnect()
      }
    }
  }, [user])

  // ...
}
```

---

### 2. Strapi WebSocket —Å–µ—Ä–≤–µ—Ä

**–§–∞–π–ª:** `backend/src/websocket/index.ts`

```typescript
import { Server } from 'socket.io'

export default {
  register({ strapi }) {
    const io = new Server(strapi.server.httpServer, {
      cors: {
        origin: process.env.FRONTEND_URL,
        credentials: true,
      },
    })

    // Store user socket connections
    const userSockets = new Map<string, string>() // userId -> socketId

    io.on('connection', (socket) => {
      console.log('Client connected:', socket.id)

      // Authenticate user
      const token = socket.handshake.auth.token
      // Verify token and get userId
      const userId = verifyToken(token) // Implement this

      if (!userId) {
        socket.disconnect()
        return
      }

      // User came online
      socket.on('user:online', async ({ userId }) => {
        userSockets.set(userId, socket.id)
        
        // Update user online status in database
        await strapi.entityService.update('plugin::users-permissions.user', userId, {
          data: { isOnline: true, lastSeen: new Date() },
        })

        // Notify friends
        const friends = await strapi.entityService.findMany('api::friendship.friendship', {
          filters: { user: userId },
          populate: ['friend'],
        })

        friends.forEach((friendship) => {
          const friendSocketId = userSockets.get(friendship.friend.id)
          if (friendSocketId) {
            io.to(friendSocketId).emit('friend:online', { friendId: userId })
          }
        })
      })

      // User status update
      socket.on('user:status', async ({ isOnline }) => {
        await strapi.entityService.update('plugin::users-permissions.user', userId, {
          data: { isOnline, lastSeen: new Date() },
        })

        // Notify friends
        const friends = await strapi.entityService.findMany('api::friendship.friendship', {
          filters: { user: userId },
          populate: ['friend'],
        })

        friends.forEach((friendship) => {
          const friendSocketId = userSockets.get(friendship.friend.id)
          if (friendSocketId) {
            const event = isOnline ? 'friend:online' : 'friend:offline'
            io.to(friendSocketId).emit(event, { friendId: userId })
          }
        })
      })

      // Disconnect
      socket.on('disconnect', async () => {
        console.log('Client disconnected:', socket.id)
        userSockets.delete(userId)
        
        // Update user offline status
        await strapi.entityService.update('plugin::users-permissions.user', userId, {
          data: { isOnline: false, lastSeen: new Date() },
        })

        // Notify friends
        const friends = await strapi.entityService.findMany('api::friendship.friendship', {
          filters: { user: userId },
          populate: ['friend'],
        })

        friends.forEach((friendship) => {
          const friendSocketId = userSockets.get(friendship.friend.id)
          if (friendSocketId) {
            io.to(friendSocketId).emit('friend:offline', { friendId: userId })
          }
        })
      })
    })

    strapi.io = io
  },
}
```

---

## üîê –ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏

–î–æ–±–∞–≤–∏—Ç—å –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:

```typescript
// frontend-react/src/pages/SettingsPage.tsx

<Card>
  <CardHeader>
    <CardTitle>–ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å –¥—Ä—É–∑–µ–π</CardTitle>
    <CardDescription>
      –£–ø—Ä–∞–≤–ª—è–π—Ç–µ —Ç–µ–º, –∫—Ç–æ –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –≤–∞–º –∑–∞–ø—Ä–æ—Å—ã –≤ –¥—Ä—É–∑—å—è
    </CardDescription>
  </CardHeader>
  <CardContent className="space-y-4">
    <div className="space-y-2">
      <Label>–ö—Ç–æ –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∑–∞–ø—Ä–æ—Å—ã</Label>
      <Select value={friendPrivacy} onValueChange={setFriendPrivacy}>
        <SelectTrigger>
          <SelectValue />
        </SelectTrigger>
        <SelectContent>
          <SelectItem value="everyone">–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</SelectItem>
          <SelectItem value="friends_of_friends">–î—Ä—É–∑—å—è –¥—Ä—É–∑–µ–π</SelectItem>
          <SelectItem value="nobody">–ù–∏–∫—Ç–æ</SelectItem>
        </SelectContent>
      </Select>
    </div>

    <div className="space-y-2">
      <Label>–í–∏–¥–∏–º–æ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</Label>
      <Select value={activityPrivacy} onValueChange={setActivityPrivacy}>
        <SelectTrigger>
          <SelectValue />
        </SelectTrigger>
        <SelectContent>
          <SelectItem value="public">–í—Å–µ</SelectItem>
          <SelectItem value="friends">–¢–æ–ª—å–∫–æ –¥—Ä—É–∑—å—è</SelectItem>
          <SelectItem value="private">–ù–∏–∫—Ç–æ</SelectItem>
        </SelectContent>
      </Select>
    </div>

    <div className="flex items-center justify-between">
      <div>
        <Label>–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –æ–Ω–ª–∞–π–Ω —Å—Ç–∞—Ç—É—Å</Label>
        <p className="text-sm text-muted-foreground">
          –î—Ä—É–∑—å—è —Å–º–æ–≥—É—Ç –≤–∏–¥–µ—Ç—å, –∫–æ–≥–¥–∞ –≤—ã –æ–Ω–ª–∞–π–Ω
        </p>
      </div>
      <Switch
        checked={onlineStatusVisible}
        onCheckedChange={setOnlineStatusVisible}
      />
    </div>
  </CardContent>
</Card>
```

---

### 2. Rate Limiting

**–í Strapi middleware:**

```typescript
// backend/src/middlewares/rateLimitFriendRequests.ts
export default (config, { strapi }) => {
  const requestCounts = new Map<string, { count: number; resetAt: number }>()

  return async (ctx, next) => {
    if (ctx.request.url === '/api/friends/requests' && ctx.request.method === 'POST') {
      const userId = ctx.state.user.id
      const now = Date.now()
      const limit = 10 // Max 10 requests per day
      const windowMs = 24 * 60 * 60 * 1000 // 24 hours

      const userLimit = requestCounts.get(userId)

      if (!userLimit || now > userLimit.resetAt) {
        requestCounts.set(userId, { count: 1, resetAt: now + windowMs })
      } else if (userLimit.count >= limit) {
        return ctx.badRequest('–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –¥—Ä—É–∑—å—è –Ω–∞ —Å–µ–≥–æ–¥–Ω—è')
      } else {
        userLimit.count++
      }
    }

    await next()
  }
}
```

---

### 3. –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞:**

```typescript
// backend/src/api/friend-request/controllers/friend-request.ts
export default {
  async create(ctx) {
    const { receiver, message } = ctx.request.body.data
    const sender = ctx.state.user.id

    // Check if blocked
    const isBlocked = await strapi.entityService.findMany('api::blocked-user.blocked-user', {
      filters: {
        $or: [
          { blocker: sender, blocked: receiver },
          { blocker: receiver, blocked: sender },
        ],
      },
    })

    if (isBlocked.length > 0) {
      return ctx.forbidden('–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å —ç—Ç–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é')
    }

    // Check privacy settings
    const receiverUser = await strapi.entityService.findOne(
      'plugin::users-permissions.user',
      receiver,
      { populate: ['friends'] }
    )

    if (receiverUser.friendPrivacy === 'nobody') {
      return ctx.forbidden('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –≤ –¥—Ä—É–∑—å—è')
    }

    if (receiverUser.friendPrivacy === 'friends_of_friends') {
      // Check if sender is friend of friend
      const mutualFriends = await checkMutualFriends(sender, receiver)
      if (mutualFriends.length === 0) {
        return ctx.forbidden('–í—ã –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∑–∞–ø—Ä–æ—Å—ã —Ç–æ–ª—å–∫–æ –¥—Ä—É–∑—å—è–º –¥—Ä—É–∑–µ–π')
      }
    }

    // Create request
    const request = await strapi.entityService.create('api::friend-request.friend-request', {
      data: { sender, receiver, message, status: 'pending' },
      populate: ['sender', 'receiver'],
    })

    return request
  },
}
```

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –º–∏–≥—Ä–∞—Ü–∏–∏

### Backend (Strapi)

- [ ] –°–æ–∑–¥–∞—Ç—å Content Type `FriendRequest`
- [ ] –°–æ–∑–¥–∞—Ç—å Content Type `Friendship`
- [ ] –°–æ–∑–¥–∞—Ç—å Content Type `FriendActivity`
- [ ] –°–æ–∑–¥–∞—Ç—å Content Type `BlockedUser`
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è –≤ User (totalFriends, isOnline, lastSeen, privacy settings)
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å relations –º–µ–∂–¥—É Content Types
- [ ] –°–æ–∑–¥–∞—Ç—å hooks –¥–ª—è FriendRequest (beforeCreate, afterCreate, afterUpdate)
- [ ] –°–æ–∑–¥–∞—Ç—å hooks –¥–ª—è Friendship (afterCreate, afterDelete)
- [ ] –°–æ–∑–¥–∞—Ç—å custom controllers –¥–ª—è –≤—Å–µ—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∞–ª–≥–æ—Ä–∏—Ç–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –¥—Ä—É–∑–µ–π
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å WebSocket —Å–µ—Ä–≤–µ—Ä –¥–ª—è real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
- [ ] –°–æ–∑–¥–∞—Ç—å middleware –¥–ª—è rate limiting
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É privacy settings
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å cron job –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å email/push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

### Frontend (React)

- [ ] –°–æ–∑–¥–∞—Ç—å `src/api/friends.ts` —Å API –∫–ª–∏–µ–Ω—Ç–æ–º
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `FriendsPage.tsx` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è useQuery/useMutation
- [ ] –°–æ–∑–¥–∞—Ç—å Skeleton –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –¥–ª—è loading states
- [ ] –î–æ–±–∞–≤–∏—Ç—å error handling –∏ toast notifications
- [ ] –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å WebSocket –¥–ª—è real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
- [ ] –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏
- [ ] –°–æ–∑–¥–∞—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- [ ] –î–æ–±–∞–≤–∏—Ç—å –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–ª—è –º—É—Ç–∞—Ü–∏–π
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Å–∫—Ä–æ–ª–ª –¥–ª—è —Å–ø–∏—Å–∫–æ–≤
- [ ] –î–æ–±–∞–≤–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É –¥—Ä—É–∑–µ–π
- [ ] –°–æ–∑–¥–∞—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –æ–Ω–ª–∞–π–Ω —Å—Ç–∞—Ç—É—Å–∞ –≤–µ–∑–¥–µ, –≥–¥–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
- [ ] –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤

### Testing

- [ ] –ù–∞–ø–∏—Å–∞—Ç—å unit —Ç–µ—Å—Ç—ã –¥–ª—è API functions
- [ ] –ù–∞–ø–∏—Å–∞—Ç—å integration —Ç–µ—Å—Ç—ã –¥–ª—è friend request flow
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å privacy settings
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å rate limiting
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- [ ] –ü—Ä–æ–≤–µ—Å—Ç–∏ E2E —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ–≥–æ flow

### Deployment

- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å environment variables –¥–ª—è WebSocket URL
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å CORS –¥–ª—è WebSocket
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å scaling –¥–ª—è WebSocket connections
- [ ] –°–æ–∑–¥–∞—Ç—å backup strategy –¥–ª—è friendship data
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å monitoring –¥–ª—è WebSocket connections
- [ ] –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å database queries (indexes –Ω–∞ sender, receiver, user, friend)
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å caching –¥–ª—è friend lists –∏ suggestions

### Cleanup

- [ ] –£–¥–∞–ª–∏—Ç—å `frontend-react/src/data/friendsMockData.ts`
- [ ] –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∏–º–ø–æ—Ä—Ç—ã mock data –∏–∑ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- [ ] –£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ñ–∞–π–ª (`FRIENDS_INTEGRATION_GUIDE.md`) –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### 1. –ì—Ä—É–ø–ø—ã –¥—Ä—É–∑–µ–π

–°–æ–∑–¥–∞—Ç—å Content Type `FriendGroup` –¥–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –¥—Ä—É–∑–µ–π –≤ –≥—Ä—É–ø–ø—ã:

```typescript
{
  name: string
  description: text
  user: relation (User, many-to-one)
  friends: relation (Friendship, many-to-many)
  color: string // Hex color for visual distinction
  icon: string // Icon name
}
```

### 2. –°–æ–≤–º–µ—Å—Ç–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å

–û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Å–æ–≤–º–µ—Å—Ç–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –¥—Ä—É–∑–µ–π:
- –°–æ–≤–º–µ—Å—Ç–Ω—ã–µ –∫—É—Ä—Å—ã
- –û–±—â–∏–µ –∏–Ω—Ç–µ—Ä–µ—Å—ã
- –°–æ–≤–º–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã

### 3. –†–µ–π—Ç–∏–Ω–≥ –¥—Ä—É–∑–µ–π

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–π—Ç–∏–Ω–≥ –¥—Ä—É–∑–µ–π –Ω–∞ –æ—Å–Ω–æ–≤–µ:
- –ß–∞—Å—Ç–æ—Ç—ã –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
- –û–±—â–∏—Ö –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤
- –í–∑–∞–∏–º–Ω—ã—Ö –ª–∞–π–∫–æ–≤/–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤

### 4. –ò–º–ø–æ—Ä—Ç –¥—Ä—É–∑–µ–π

–ò–º–ø–æ—Ä—Ç –¥—Ä—É–∑–µ–π –∏–∑ —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç–µ–π:
- GitHub
- Twitter
- LinkedIn

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2025-02-20

**–ê–≤—Ç–æ—Ä:** AI Assistant (Claude Sonnet 4.5)

**–í–µ—Ä—Å–∏—è:** 1.0.0

