{
  "version": 3,
  "sources": ["../keystone.ts", "../schemas/User.ts", "../src/access-control.ts", "../schemas/Article.ts", "../src/lib/logger.ts", "../src/lib/notifications.ts", "../schemas/Comment.ts", "../schemas/ArticleReaction.ts", "../schemas/CommentReaction.ts", "../schemas/Bookmark.ts", "../schemas/Follow.ts", "../schemas/Notification.ts", "../schemas/index.ts", "../src/auth/auth.ts", "../src/middlewares/index.ts", "../src/lib/redis.ts", "../src/auth/oauth-handler.ts", "../src/auth/passport.ts", "../src/lib/security-logger.ts", "../src/graphql/reactions.ts"],
  "sourcesContent": ["/**\n * KeystoneJS configuration\n * \u0413\u043B\u0430\u0432\u043D\u044B\u0439 \u0444\u0430\u0439\u043B \u043A\u043E\u043D\u0444\u0438\u0433\u0443\u0440\u0430\u0446\u0438\u0438 \u043F\u0440\u0438\u043B\u043E\u0436\u0435\u043D\u0438\u044F\n */\n// \u0417\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u043C \u043F\u0435\u0440\u0435\u043C\u0435\u043D\u043D\u044B\u0435 \u043E\u043A\u0440\u0443\u0436\u0435\u043D\u0438\u044F \u041F\u0415\u0420\u0412\u042B\u041C \u0434\u0435\u043B\u043E\u043C, \u0434\u043E \u0432\u0441\u0435\u0445 \u0438\u043C\u043F\u043E\u0440\u0442\u043E\u0432\nimport 'dotenv/config';\n\nimport { config } from '@keystone-6/core';\nimport { lists } from './schemas';\nimport { withAuth, session } from './src/auth/auth';\nimport { extendExpressApp } from './src/middlewares';\nimport { extendGraphqlSchema } from './src/graphql/reactions';\nimport logger from './src/lib/logger';\nimport { logAdminAccessDenied, logAdminAccessGranted } from './src/lib/security-logger';\n\nconst databaseURL = process.env.DATABASE_URL || 'file:./.tmp/data.db';\n\n// \u041F\u0440\u043E\u0432\u0435\u0440\u043A\u0430 \u0441\u0438\u043B\u044B SESSION_SECRET \u043F\u0440\u0438 \u0441\u0442\u0430\u0440\u0442\u0435\nconst sessionSecret = process.env.SESSION_SECRET;\nif (!sessionSecret || sessionSecret.length < 32) {\n  logger.error('\u274C SECURITY WARNING: SESSION_SECRET is too short or missing!');\n  logger.error('   SESSION_SECRET must be at least 32 characters long.');\n  logger.error('   Generate a secure secret: openssl rand -base64 64');\n  if (process.env.NODE_ENV === 'production') {\n    logger.error('   Application will not start in production with weak SESSION_SECRET.');\n    process.exit(1);\n  } else {\n    logger.warn('   \u26A0\uFE0F  Using default secret in development (NOT SECURE FOR PRODUCTION)');\n  }\n} else {\n  logger.info('\u2705 SESSION_SECRET is secure (length: ' + sessionSecret.length + ' characters)');\n}\n\nexport default withAuth(\n  config({\n    db: {\n      provider: 'sqlite',\n      url: databaseURL,\n      useMigrations: true,\n      idField: { kind: 'autoincrement' },\n    },\n    lists,\n    session,\n    graphql: {\n      path: '/api/graphql',\n      apolloConfig: {\n        introspection: process.env.NODE_ENV === 'development',\n      },\n      extendGraphqlSchema,\n    },\n    server: {\n      port: parseInt(process.env.PORT || '1337', 10),\n      extendExpressApp,\n      cors: {\n        origin: [\n          process.env.FRONTEND_URL || 'http://localhost:5173',\n          process.env.PUBLIC_URL || 'http://localhost:1337',\n        ],\n        credentials: true,\n      },\n    },\n    ui: {\n      isAccessAllowed: async (context) => {\n        // \u041F\u043E\u043B\u0443\u0447\u0430\u0435\u043C IP \u0430\u0434\u0440\u0435\u0441 \u0438\u0437 \u043A\u043E\u043D\u0442\u0435\u043A\u0441\u0442\u0430 \u0437\u0430\u043F\u0440\u043E\u0441\u0430 (\u0435\u0441\u043B\u0438 \u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D)\n        const req = (context as any).req;\n        const ip = req?.ip || req?.connection?.remoteAddress || 'unknown';\n        const userAgent = req?.get?.('user-agent') || 'unknown';\n\n        // \u0415\u0441\u043B\u0438 \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044C \u043D\u0435 \u0430\u0432\u0442\u043E\u0440\u0438\u0437\u043E\u0432\u0430\u043D - KeystoneJS \u0430\u0432\u0442\u043E\u043C\u0430\u0442\u0438\u0447\u0435\u0441\u043A\u0438 \u043F\u043E\u043A\u0430\u0436\u0435\u0442 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443 \u0432\u0445\u043E\u0434\u0430\n        // \u041D\u0430 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0435 \u0432\u0445\u043E\u0434\u0430 \u043C\u043E\u0436\u043D\u043E \u0437\u0430\u0440\u0435\u0433\u0438\u0441\u0442\u0440\u0438\u0440\u043E\u0432\u0430\u0442\u044C\u0441\u044F (\u0435\u0441\u043B\u0438 \u0431\u0430\u0437\u0430 \u043F\u0443\u0441\u0442\u0430\u044F) \u0438\u043B\u0438 \u0432\u043E\u0439\u0442\u0438\n        if (!context.session?.itemId) {\n          logAdminAccessDenied(ip, undefined, 'Not authenticated', userAgent);\n          return false; // KeystoneJS \u043F\u043E\u043A\u0430\u0436\u0435\u0442 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443 signin/signup\n        }\n\n        // \u0415\u0441\u043B\u0438 \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044C \u0430\u0432\u0442\u043E\u0440\u0438\u0437\u043E\u0432\u0430\u043D - \u043F\u0440\u043E\u0432\u0435\u0440\u044F\u0435\u043C \u0440\u043E\u043B\u044C\n        const sessionData = context.session.data as any;\n        const userRole = sessionData?.role;\n        const userId = context.session.itemId;\n        const email = sessionData?.email || 'unknown';\n\n        // \u0414\u043E\u0441\u0442\u0443\u043F \u043A Admin UI \u0442\u043E\u043B\u044C\u043A\u043E \u0434\u043B\u044F \u0430\u0434\u043C\u0438\u043D\u043E\u0432\n        if (userRole !== 'admin') {\n          logAdminAccessDenied(ip, String(userId), `User role is '${userRole}', not 'admin'`, userAgent);\n          return false; // \u041D\u0435 \u0430\u0434\u043C\u0438\u043D\u044B \u043D\u0435 \u043C\u043E\u0433\u0443\u0442 \u043F\u043E\u043B\u0443\u0447\u0438\u0442\u044C \u0434\u043E\u0441\u0442\u0443\u043F \u043A Admin UI\n        }\n\n        // \u041B\u043E\u0433\u0438\u0440\u0443\u0435\u043C \u0443\u0441\u043F\u0435\u0448\u043D\u044B\u0439 \u0434\u043E\u0441\u0442\u0443\u043F \u043A Admin UI\n        logAdminAccessGranted(ip, String(userId), email, userAgent);\n        return true; // \u0410\u0434\u043C\u0438\u043D\u044B \u0438\u043C\u0435\u044E\u0442 \u043F\u043E\u043B\u043D\u044B\u0439 \u0434\u043E\u0441\u0442\u0443\u043F\n      },\n    },\n  })\n);\n\n", "/**\n * User schema\n * \u0420\u0430\u0441\u0448\u0438\u0440\u0435\u043D\u0438\u0435 \u0432\u0441\u0442\u0440\u043E\u0435\u043D\u043D\u043E\u0439 \u0441\u0445\u0435\u043C\u044B \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u0435\u0439 KeystoneJS\n */\nimport { list } from '@keystone-6/core';\nimport { text, relationship, select, timestamp, checkbox, password } from '@keystone-6/core/fields';\nimport { accessControl } from '../src/access-control';\nimport logger from '../src/lib/logger';\n\nexport const User = list({\n  access: accessControl.User,\n  hooks: {\n    // \u0412\u0410\u0416\u041D\u041E: \u0410\u0432\u0442\u043E\u043C\u0430\u0442\u0438\u0447\u0435\u0441\u043A\u043E\u0435 \u043D\u0430\u0437\u043D\u0430\u0447\u0435\u043D\u0438\u0435 \u0440\u043E\u043B\u0438 'admin' \u0423\u0411\u0420\u0410\u041D\u041E \u0438\u0437 \u0441\u043E\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0439 \u0431\u0435\u0437\u043E\u043F\u0430\u0441\u043D\u043E\u0441\u0442\u0438\n    // \u0420\u043E\u043B\u044C 'admin' \u043C\u043E\u0436\u0435\u0442 \u0431\u044B\u0442\u044C \u043D\u0430\u0437\u043D\u0430\u0447\u0435\u043D\u0430 \u0422\u041E\u041B\u042C\u041A\u041E \u0447\u0435\u0440\u0435\u0437 \u0437\u0430\u0449\u0438\u0449\u0435\u043D\u043D\u044B\u0439 endpoint /api/setup/initial\n    // \u0438\u043B\u0438 \u0432\u0440\u0443\u0447\u043D\u0443\u044E \u0441\u0443\u0449\u0435\u0441\u0442\u0432\u0443\u044E\u0449\u0438\u043C \u0430\u0434\u043C\u0438\u043D\u0438\u0441\u0442\u0440\u0430\u0442\u043E\u0440\u043E\u043C \u0447\u0435\u0440\u0435\u0437 Admin UI\n    resolveInput: async ({ resolvedData, operation, context }) => {\n      if (operation === 'create') {\n        // \u0415\u0441\u043B\u0438 \u0440\u043E\u043B\u044C \u043D\u0435 \u0443\u043A\u0430\u0437\u0430\u043D\u0430 - \u0443\u0441\u0442\u0430\u043D\u0430\u0432\u043B\u0438\u0432\u0430\u0435\u043C 'user' \u043F\u043E \u0443\u043C\u043E\u043B\u0447\u0430\u043D\u0438\u044E\n        // \u041D\u0418\u041A\u041E\u0413\u0414\u0410 \u043D\u0435 \u043D\u0430\u0437\u043D\u0430\u0447\u0430\u0435\u043C 'admin' \u0430\u0432\u0442\u043E\u043C\u0430\u0442\u0438\u0447\u0435\u0441\u043A\u0438 \u0447\u0435\u0440\u0435\u0437 GraphQL API\n        if (!resolvedData.role) {\n          resolvedData.role = 'user';\n        }\n        \n        // \u0414\u043B\u044F \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u044B\u0445 \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u0435\u0439 (\u043D\u0435 OAuth) \u043F\u0430\u0440\u043E\u043B\u044C \u043E\u0431\u044F\u0437\u0430\u0442\u0435\u043B\u0435\u043D\n        if (!resolvedData.provider || resolvedData.provider === 'local') {\n          if (!resolvedData.password) {\n            throw new Error('Password is required for local users');\n          }\n        }\n      }\n      return resolvedData;\n    },\n  },\n  fields: {\n    name: text({ validation: { isRequired: true } }),\n    email: text({\n      validation: { isRequired: true },\n      isIndexed: 'unique',\n    }),\n    password: password({\n      // Password \u043E\u0431\u044F\u0437\u0430\u0442\u0435\u043B\u0435\u043D \u0434\u043B\u044F \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u044B\u0445 \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u0435\u0439\n      // \u0414\u043B\u044F OAuth \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u0435\u0439 \u043C\u043E\u0436\u043D\u043E \u043E\u0441\u0442\u0430\u0432\u0438\u0442\u044C \u043F\u0443\u0441\u0442\u044B\u043C\n      validation: { isRequired: false },\n      // KeystoneJS \u0430\u0432\u0442\u043E\u043C\u0430\u0442\u0438\u0447\u0435\u0441\u043A\u0438 \u0445\u0435\u0448\u0438\u0440\u0443\u0435\u0442 \u043F\u0430\u0440\u043E\u043B\u044C \u043F\u0440\u0438 \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u0438\u0438\n    }),\n    username: text({\n      validation: { isRequired: true, length: { min: 3, max: 50 } },\n      isIndexed: 'unique',\n    }),\n    bio: text(),\n    avatar: text(), // URL \u0441\u0442\u0440\u043E\u043A\u0438 (\u043E\u0442 imgBB \u0438\u043B\u0438 Cloudinary)\n    coverImage: text(), // URL \u0441\u0442\u0440\u043E\u043A\u0438 (\u043E\u0442 imgBB \u0438\u043B\u0438 Cloudinary)\n    provider: select({\n      type: 'string',\n      options: [\n        { label: 'Local', value: 'local' },\n        { label: 'Google', value: 'google' },\n      ],\n      defaultValue: 'local',\n    }),\n    confirmed: checkbox({\n      defaultValue: false,\n    }),\n    blocked: checkbox({\n      defaultValue: false,\n    }),\n    role: select({\n      type: 'string',\n      options: [\n        { label: 'User', value: 'user' },\n        { label: 'Admin', value: 'admin' },\n      ],\n      defaultValue: 'user',\n      validation: { isRequired: true },\n    }),\n    articles: relationship({\n      ref: 'Article.author',\n      many: true,\n    }),\n    comments: relationship({\n      ref: 'Comment.author',\n      many: true,\n    }),\n    articleReactions: relationship({\n      ref: 'ArticleReaction.user',\n      many: true,\n    }),\n    commentReactions: relationship({\n      ref: 'CommentReaction.user',\n      many: true,\n    }),\n    bookmarks: relationship({\n      ref: 'Bookmark.user',\n      many: true,\n    }),\n    following: relationship({\n      ref: 'Follow.follower',\n      many: true,\n    }),\n    followers: relationship({\n      ref: 'Follow.following',\n      many: true,\n    }),\n    notifications: relationship({\n      ref: 'Notification.user',\n      many: true,\n    }),\n    createdAt: timestamp({\n      defaultValue: { kind: 'now' },\n    }),\n    updatedAt: timestamp({\n      defaultValue: { kind: 'now' },\n    }),\n  },\n});\n\n", "/**\n * Access control rules (RBAC) \u0434\u043B\u044F \u0432\u0441\u0435\u0445 \u0441\u0445\u0435\u043C\n * \u041E\u043F\u0440\u0435\u0434\u0435\u043B\u044F\u0435\u0442 \u043A\u0442\u043E \u043C\u043E\u0436\u0435\u0442 \u0447\u0438\u0442\u0430\u0442\u044C, \u0441\u043E\u0437\u0434\u0430\u0432\u0430\u0442\u044C, \u043E\u0431\u043D\u043E\u0432\u043B\u044F\u0442\u044C \u0438 \u0443\u0434\u0430\u043B\u044F\u0442\u044C \u0434\u0430\u043D\u043D\u044B\u0435\n */\n\n/**\n * \u041F\u0440\u043E\u0432\u0435\u0440\u043A\u0430, \u044F\u0432\u043B\u044F\u0435\u0442\u0441\u044F \u043B\u0438 \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044C \u0432\u043B\u0430\u0434\u0435\u043B\u044C\u0446\u0435\u043C \u0437\u0430\u043F\u0438\u0441\u0438\n */\nfunction isOwner({ session, item }: { session?: any; item: any }) {\n  if (!session?.itemId) return false;\n  return String(item.author?.id || item.author) === String(session.itemId);\n}\n\n/**\n * \u041F\u0440\u043E\u0432\u0435\u0440\u043A\u0430, \u044F\u0432\u043B\u044F\u0435\u0442\u0441\u044F \u043B\u0438 \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044C \u0432\u043B\u0430\u0434\u0435\u043B\u044C\u0446\u0435\u043C \u0440\u0435\u0430\u043A\u0446\u0438\u0438\n */\nfunction isReactionOwner({ session, item }: { session?: any; item: any }) {\n  if (!session?.itemId) return false;\n  if (!item) return false; // \u0417\u0430\u0449\u0438\u0442\u0430 \u043E\u0442 undefined\n  return String(item.user?.id || item.user) === String(session.itemId);\n}\n\n/**\n * \u041F\u0440\u043E\u0432\u0435\u0440\u043A\u0430, \u044F\u0432\u043B\u044F\u0435\u0442\u0441\u044F \u043B\u0438 \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044C \u0432\u043B\u0430\u0434\u0435\u043B\u044C\u0446\u0435\u043C \u043A\u043E\u043C\u043C\u0435\u043D\u0442\u0430\u0440\u0438\u044F\n */\nfunction isCommentOwner({ session, item }: { session?: any; item: any }) {\n  if (!session?.itemId) {\n    return false;\n  }\n  if (!item) {\n    return false; // \u0417\u0430\u0449\u0438\u0442\u0430 \u043E\u0442 undefined\n  }\n  \n  try {\n    // \u0418\u0441\u043F\u043E\u043B\u044C\u0437\u0443\u0435\u043C authorId \u043D\u0430\u043F\u0440\u044F\u043C\u0443\u044E \u0438\u0437 Prisma (\u0431\u044B\u0441\u0442\u0440\u0435\u0435 \u0438 \u043D\u0430\u0434\u0435\u0436\u043D\u0435\u0435)\n    // Fallback \u043D\u0430 item.author?.id \u0438\u043B\u0438 item.author \u0435\u0441\u043B\u0438 authorId \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u043E\n    const authorId = item.authorId ?? item.author?.id ?? item.author;\n    if (!authorId) {\n      return false;\n    }\n    \n    return String(authorId) === String(session.itemId);\n  } catch (error) {\n    return false;\n  }\n}\n\n/**\n * \u041F\u0440\u043E\u0432\u0435\u0440\u043A\u0430, \u044F\u0432\u043B\u044F\u0435\u0442\u0441\u044F \u043B\u0438 \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044C \u0432\u043B\u0430\u0434\u0435\u043B\u044C\u0446\u0435\u043C \u0441\u0442\u0430\u0442\u044C\u0438\n */\nfunction isArticleOwner({ session, item }: { session?: any; item: any }) {\n  if (!session?.itemId) return false;\n  if (!item) return false; // \u0417\u0430\u0449\u0438\u0442\u0430 \u043E\u0442 undefined\n  \n  // \u0418\u0441\u043F\u043E\u043B\u044C\u0437\u0443\u0435\u043C authorId \u043D\u0430\u043F\u0440\u044F\u043C\u0443\u044E \u0438\u0437 Prisma (\u0431\u044B\u0441\u0442\u0440\u0435\u0435 \u0438 \u043D\u0430\u0434\u0435\u0436\u043D\u0435\u0435)\n  // Fallback \u043D\u0430 item.author?.id \u0438\u043B\u0438 item.author \u0435\u0441\u043B\u0438 authorId \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u043E\n  const authorId = item.authorId ?? item.author?.id ?? item.author;\n  if (!authorId) {\n    return false;\n  }\n  \n  return String(authorId) === String(session.itemId);\n}\n\nexport const accessControl = {\n  User: {\n    operation: {\n      query: () => {\n        // \u041F\u0443\u0431\u043B\u0438\u0447\u043D\u044B\u0435 \u0434\u0430\u043D\u043D\u044B\u0435 \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u0435\u0439 \u0434\u043E\u0441\u0442\u0443\u043F\u043D\u044B \u0432\u0441\u0435\u043C\n        // \u041F\u043E\u043B\u043D\u044B\u0435 \u0434\u0430\u043D\u043D\u044B\u0435 \u043A\u043E\u043D\u0442\u0440\u043E\u043B\u0438\u0440\u0443\u044E\u0442\u0441\u044F \u0447\u0435\u0440\u0435\u0437 filter\n        return true;\n      },\n      create: () => {\n        // \u0420\u0435\u0433\u0438\u0441\u0442\u0440\u0430\u0446\u0438\u044F \u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u0432\u0441\u0435\u043C:\n        // 1. \u0427\u0435\u0440\u0435\u0437 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443 \u0432\u0445\u043E\u0434\u0430 Admin UI (\u0435\u0441\u043B\u0438 \u0431\u0430\u0437\u0430 \u043F\u0443\u0441\u0442\u0430\u044F) - KeystoneJS \u0430\u0432\u0442\u043E\u043C\u0430\u0442\u0438\u0447\u0435\u0441\u043A\u0438 \u043F\u043E\u043A\u0430\u0436\u0435\u0442 \u0444\u043E\u0440\u043C\u0443 \u0440\u0435\u0433\u0438\u0441\u0442\u0440\u0430\u0446\u0438\u0438\n        // 2. \u0427\u0435\u0440\u0435\u0437 GraphQL API (\u0434\u043B\u044F \u043F\u0443\u0431\u043B\u0438\u0447\u043D\u043E\u0439 \u0440\u0435\u0433\u0438\u0441\u0442\u0440\u0430\u0446\u0438\u0438 \u043D\u0430 \u0441\u0430\u0439\u0442\u0435)\n        // \n        // \u0412\u0410\u0416\u041D\u041E: \u0420\u043E\u043B\u044C 'admin' \u041D\u0415 \u043D\u0430\u0437\u043D\u0430\u0447\u0430\u0435\u0442\u0441\u044F \u0430\u0432\u0442\u043E\u043C\u0430\u0442\u0438\u0447\u0435\u0441\u043A\u0438 \u0447\u0435\u0440\u0435\u0437 GraphQL API\n        // \u041F\u0435\u0440\u0432\u044B\u0439 \u0430\u0434\u043C\u0438\u043D\u0438\u0441\u0442\u0440\u0430\u0442\u043E\u0440 \u0441\u043E\u0437\u0434\u0430\u0435\u0442\u0441\u044F \u0422\u041E\u041B\u042C\u041A\u041E \u0447\u0435\u0440\u0435\u0437 \u0437\u0430\u0449\u0438\u0449\u0435\u043D\u043D\u044B\u0439 endpoint /api/setup/initial\n        // \u0441 \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u043D\u0438\u0435\u043C Prisma \u0442\u0440\u0430\u043D\u0437\u0430\u043A\u0446\u0438\u0438 \u0434\u043B\u044F \u0437\u0430\u0449\u0438\u0442\u044B \u043E\u0442 race conditions\n        return true;\n      },\n      update: ({ session, item }: { session?: any; item: any }) => {\n        // \u041E\u0431\u043D\u043E\u0432\u043B\u044F\u0442\u044C \u043C\u043E\u0436\u043D\u043E \u0442\u043E\u043B\u044C\u043A\u043E \u0441\u0432\u043E\u0439 \u043F\u0440\u043E\u0444\u0438\u043B\u044C \u0438\u043B\u0438 \u0430\u0434\u043C\u0438\u043D\u044B \u043C\u043E\u0433\u0443\u0442 \u043E\u0431\u043D\u043E\u0432\u043B\u044F\u0442\u044C \u0432\u0441\u0435\u0445\n        if (!session?.itemId) return false;\n        const sessionData = session.data as any;\n        if (sessionData?.role === 'admin') return true; // \u0410\u0434\u043C\u0438\u043D\u044B \u043C\u043E\u0433\u0443\u0442 \u043E\u0431\u043D\u043E\u0432\u043B\u044F\u0442\u044C \u0432\u0441\u0435\u0445\n        return String(item.id) === String(session.itemId); // \u041E\u0431\u044B\u0447\u043D\u044B\u0435 \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u0438 - \u0442\u043E\u043B\u044C\u043A\u043E \u0441\u0432\u043E\u0439 \u043F\u0440\u043E\u0444\u0438\u043B\u044C\n      },\n      delete: ({ session, item }: { session?: any; item: any }) => {\n        // \u0423\u0434\u0430\u043B\u044F\u0442\u044C \u043C\u043E\u0436\u0435\u0442 \u0442\u043E\u043B\u044C\u043A\u043E \u0430\u0434\u043C\u0438\u043D\n        if (!session?.itemId) return false;\n        const sessionData = session.data as any;\n        return sessionData?.role === 'admin';\n      },\n    },\n    filter: {\n      query: ({ session }: { session?: any }) => {\n        // \u041F\u0443\u0431\u043B\u0438\u0447\u043D\u044B\u0435 \u0434\u0430\u043D\u043D\u044B\u0435 \u0434\u043E\u0441\u0442\u0443\u043F\u043D\u044B \u0432\u0441\u0435\u043C\n        // \u041F\u043E\u043B\u043D\u044B\u0435 \u0434\u0430\u043D\u043D\u044B\u0435 - \u0442\u043E\u043B\u044C\u043A\u043E \u0430\u0434\u043C\u0438\u043D\u0430\u043C\n        if (!session?.itemId) return true;\n        const sessionData = session.data as any;\n        if (sessionData?.role === 'admin') return true; // \u0410\u0434\u043C\u0438\u043D\u044B \u0432\u0438\u0434\u044F\u0442 \u0432\u0441\u0435\n        return true; // \u041F\u0443\u0431\u043B\u0438\u0447\u043D\u044B\u0435 \u0434\u0430\u043D\u043D\u044B\u0435 \u0434\u043B\u044F \u0432\u0441\u0435\u0445\n      },\n    },\n  },\n\n  Article: {\n    operation: {\n      query: () => true, // \u0427\u0442\u0435\u043D\u0438\u0435 \u0441\u0442\u0430\u0442\u0435\u0439 - \u043F\u0443\u0431\u043B\u0438\u0447\u043D\u043E (\u0444\u0438\u043B\u044C\u0442\u0440 \u043E\u0433\u0440\u0430\u043D\u0438\u0447\u0438\u0442 \u0434\u043E\u0441\u0442\u0443\u043F)\n      create: ({ session }: { session?: any }) => {\n        // \u0421\u043E\u0437\u0434\u0430\u0432\u0430\u0442\u044C \u0441\u0442\u0430\u0442\u044C\u0438 \u043C\u043E\u0433\u0443\u0442 \u0442\u043E\u043B\u044C\u043A\u043E \u0430\u0432\u0442\u043E\u0440\u0438\u0437\u043E\u0432\u0430\u043D\u043D\u044B\u0435\n        return !!session?.itemId;\n      },\n      update: ({ session }: { session?: any }) => {\n        // \u0423\u043F\u0440\u043E\u0449\u0435\u043D\u043E: \u043F\u0440\u043E\u0432\u0435\u0440\u044F\u0435\u043C \u0442\u043E\u043B\u044C\u043A\u043E \u0430\u0432\u0442\u043E\u0440\u0438\u0437\u0430\u0446\u0438\u044E, \u0432\u043B\u0430\u0434\u0435\u043B\u044C\u0446\u0430 \u043F\u0440\u043E\u0432\u0435\u0440\u044F\u0435\u043C \u0447\u0435\u0440\u0435\u0437 filter\n        return !!session?.itemId;\n      },\n      delete: ({ session }: { session?: any }) => {\n        // \u0423\u043F\u0440\u043E\u0449\u0435\u043D\u043E: \u043F\u0440\u043E\u0432\u0435\u0440\u044F\u0435\u043C \u0442\u043E\u043B\u044C\u043A\u043E \u0430\u0432\u0442\u043E\u0440\u0438\u0437\u0430\u0446\u0438\u044E, \u0432\u043B\u0430\u0434\u0435\u043B\u044C\u0446\u0430 \u043F\u0440\u043E\u0432\u0435\u0440\u044F\u0435\u043C \u0447\u0435\u0440\u0435\u0437 filter\n        return !!session?.itemId;\n      },\n    },\n    filter: {\n      query: ({ session }: { session?: any }) => {\n        // \u041F\u0443\u0431\u043B\u0438\u0447\u043D\u044B\u0435 \u0432\u0438\u0434\u044F\u0442 \u0442\u043E\u043B\u044C\u043A\u043E \u043E\u043F\u0443\u0431\u043B\u0438\u043A\u043E\u0432\u0430\u043D\u043D\u044B\u0435 \u0441\u0442\u0430\u0442\u044C\u0438\n        if (!session?.itemId) {\n          return {\n            publishedAt: { not: null },\n          };\n        }\n        // \u0410\u0432\u0442\u043E\u0440\u0438\u0437\u043E\u0432\u0430\u043D\u043D\u044B\u0435 \u0432\u0438\u0434\u044F\u0442 \u043E\u043F\u0443\u0431\u043B\u0438\u043A\u043E\u0432\u0430\u043D\u043D\u044B\u0435 + \u0441\u0432\u043E\u0438 \u0447\u0435\u0440\u043D\u043E\u0432\u0438\u043A\u0438\n        return {\n          OR: [\n            { publishedAt: { not: null } },\n            { author: { id: { equals: session.itemId } } },\n          ],\n        };\n      },\n      update: ({ session }: { session?: any }) => {\n        // \u041E\u0431\u043D\u043E\u0432\u043B\u044F\u0442\u044C \u043C\u043E\u0436\u0435\u0442 \u0442\u043E\u043B\u044C\u043A\u043E \u0430\u0432\u0442\u043E\u0440 \u0441\u0442\u0430\u0442\u044C\u0438\n        if (!session?.itemId) return false;\n        return {\n          author: { id: { equals: session.itemId } },\n        };\n      },\n      delete: ({ session }: { session?: any }) => {\n        // \u0423\u0434\u0430\u043B\u044F\u0442\u044C \u043C\u043E\u0436\u0435\u0442 \u0442\u043E\u043B\u044C\u043A\u043E \u0430\u0432\u0442\u043E\u0440 \u0441\u0442\u0430\u0442\u044C\u0438\n        if (!session?.itemId) return false;\n        return {\n          author: { id: { equals: session.itemId } },\n        };\n      },\n    },\n  },\n\n  Comment: {\n    operation: {\n      query: () => true, // \u0427\u0442\u0435\u043D\u0438\u0435 \u043A\u043E\u043C\u043C\u0435\u043D\u0442\u0430\u0440\u0438\u0435\u0432 - \u043F\u0443\u0431\u043B\u0438\u0447\u043D\u043E\n      create: ({ session }: { session?: any }) => {\n        // \u0421\u043E\u0437\u0434\u0430\u0432\u0430\u0442\u044C \u043A\u043E\u043C\u043C\u0435\u043D\u0442\u0430\u0440\u0438\u0438 \u043C\u043E\u0433\u0443\u0442 \u0442\u043E\u043B\u044C\u043A\u043E \u0430\u0432\u0442\u043E\u0440\u0438\u0437\u043E\u0432\u0430\u043D\u043D\u044B\u0435\n        return !!session?.itemId;\n      },\n      update: ({ session }: { session?: any }) => {\n        // \u0420\u0430\u0437\u0440\u0435\u0448\u0430\u0435\u043C \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u0435, \u043D\u043E \u0444\u0438\u043B\u044C\u0442\u0440 \u043E\u0433\u0440\u0430\u043D\u0438\u0447\u0438\u0442 \u0434\u043E\u0441\u0442\u0443\u043F \u0442\u043E\u043B\u044C\u043A\u043E \u043A \u0441\u0432\u043E\u0438\u043C \u043A\u043E\u043C\u043C\u0435\u043D\u0442\u0430\u0440\u0438\u044F\u043C\n        return !!session?.itemId;\n      },\n      delete: ({ session }: { session?: any }) => {\n        // \u0420\u0430\u0437\u0440\u0435\u0448\u0430\u0435\u043C \u0443\u0434\u0430\u043B\u0435\u043D\u0438\u0435, \u043D\u043E \u0444\u0438\u043B\u044C\u0442\u0440 \u043E\u0433\u0440\u0430\u043D\u0438\u0447\u0438\u0442 \u0434\u043E\u0441\u0442\u0443\u043F \u0442\u043E\u043B\u044C\u043A\u043E \u043A \u0441\u0432\u043E\u0438\u043C \u043A\u043E\u043C\u043C\u0435\u043D\u0442\u0430\u0440\u0438\u044F\u043C\n        return !!session?.itemId;\n      },\n    },\n    filter: {\n      query: () => true, // \u0412\u0441\u0435 \u0432\u0438\u0434\u044F\u0442 \u0432\u0441\u0435 \u043A\u043E\u043C\u043C\u0435\u043D\u0442\u0430\u0440\u0438\u0438\n      update: ({ session }: { session?: any }) => {\n        // \u041E\u0431\u043D\u043E\u0432\u043B\u044F\u0442\u044C \u043C\u043E\u0436\u043D\u043E \u0442\u043E\u043B\u044C\u043A\u043E \u0441\u0432\u043E\u0438 \u043A\u043E\u043C\u043C\u0435\u043D\u0442\u0430\u0440\u0438\u0438\n        if (!session?.itemId) return false;\n        return {\n          author: { id: { equals: session.itemId } },\n        };\n      },\n      delete: ({ session }: { session?: any }) => {\n        // \u0423\u0434\u0430\u043B\u044F\u0442\u044C \u043C\u043E\u0436\u043D\u043E \u0442\u043E\u043B\u044C\u043A\u043E \u0441\u0432\u043E\u0438 \u043A\u043E\u043C\u043C\u0435\u043D\u0442\u0430\u0440\u0438\u0438\n        if (!session?.itemId) return false;\n        return {\n          author: { id: { equals: session.itemId } },\n        };\n      },\n    },\n  },\n\n  ArticleReaction: {\n    operation: {\n      query: () => true, // \u0427\u0442\u0435\u043D\u0438\u0435 \u0440\u0435\u0430\u043A\u0446\u0438\u0439 - \u043F\u0443\u0431\u043B\u0438\u0447\u043D\u043E\n      create: ({ session }: { session?: any }) => {\n        // \u0421\u043E\u0437\u0434\u0430\u0432\u0430\u0442\u044C \u0440\u0435\u0430\u043A\u0446\u0438\u0438 \u043C\u043E\u0433\u0443\u0442 \u0442\u043E\u043B\u044C\u043A\u043E \u0430\u0432\u0442\u043E\u0440\u0438\u0437\u043E\u0432\u0430\u043D\u043D\u044B\u0435\n        return !!session?.itemId;\n      },\n      update: ({ session, item }: { session?: any; item: any }) => {\n        // \u041E\u0431\u043D\u043E\u0432\u043B\u044F\u0442\u044C \u043C\u043E\u0436\u0435\u0442 \u0442\u043E\u043B\u044C\u043A\u043E \u0432\u043B\u0430\u0434\u0435\u043B\u0435\u0446 \u0440\u0435\u0430\u043A\u0446\u0438\u0438\n        return isReactionOwner({ session, item });\n      },\n      delete: ({ session, item }: { session?: any; item: any }) => {\n        // \u0423\u0434\u0430\u043B\u044F\u0442\u044C \u043C\u043E\u0436\u0435\u0442 \u0442\u043E\u043B\u044C\u043A\u043E \u0432\u043B\u0430\u0434\u0435\u043B\u0435\u0446 \u0440\u0435\u0430\u043A\u0446\u0438\u0438\n        return isReactionOwner({ session, item });\n      },\n    },\n    filter: {\n      query: () => true, // \u0412\u0441\u0435 \u0432\u0438\u0434\u044F\u0442 \u0432\u0441\u0435 \u0440\u0435\u0430\u043A\u0446\u0438\u0438\n    },\n  },\n\n  CommentReaction: {\n    operation: {\n      query: () => true, // \u0427\u0442\u0435\u043D\u0438\u0435 \u0440\u0435\u0430\u043A\u0446\u0438\u0439 - \u043F\u0443\u0431\u043B\u0438\u0447\u043D\u043E\n      create: ({ session }: { session?: any }) => {\n        // \u0421\u043E\u0437\u0434\u0430\u0432\u0430\u0442\u044C \u0440\u0435\u0430\u043A\u0446\u0438\u0438 \u043C\u043E\u0433\u0443\u0442 \u0442\u043E\u043B\u044C\u043A\u043E \u0430\u0432\u0442\u043E\u0440\u0438\u0437\u043E\u0432\u0430\u043D\u043D\u044B\u0435\n        return !!session?.itemId;\n      },\n      update: ({ session, item }: { session?: any; item: any }) => {\n        // \u041E\u0431\u043D\u043E\u0432\u043B\u044F\u0442\u044C \u043C\u043E\u0436\u0435\u0442 \u0442\u043E\u043B\u044C\u043A\u043E \u0432\u043B\u0430\u0434\u0435\u043B\u0435\u0446 \u0440\u0435\u0430\u043A\u0446\u0438\u0438\n        return isReactionOwner({ session, item });\n      },\n      delete: ({ session, item }: { session?: any; item: any }) => {\n        // \u0423\u0434\u0430\u043B\u044F\u0442\u044C \u043C\u043E\u0436\u0435\u0442 \u0442\u043E\u043B\u044C\u043A\u043E \u0432\u043B\u0430\u0434\u0435\u043B\u0435\u0446 \u0440\u0435\u0430\u043A\u0446\u0438\u0438\n        return isReactionOwner({ session, item });\n      },\n    },\n    filter: {\n      query: () => true, // \u0412\u0441\u0435 \u0432\u0438\u0434\u044F\u0442 \u0432\u0441\u0435 \u0440\u0435\u0430\u043A\u0446\u0438\u0438\n    },\n  },\n\n  Bookmark: {\n    operation: {\n      query: ({ session }: { session?: any }) => {\n        // \u0427\u0438\u0442\u0430\u0442\u044C \u0437\u0430\u043A\u043B\u0430\u0434\u043A\u0438 \u043C\u043E\u0436\u0435\u0442 \u0442\u043E\u043B\u044C\u043A\u043E \u0432\u043B\u0430\u0434\u0435\u043B\u0435\u0446\n        return !!session?.itemId;\n      },\n      create: ({ session }: { session?: any }) => {\n        // \u0421\u043E\u0437\u0434\u0430\u0432\u0430\u0442\u044C \u0437\u0430\u043A\u043B\u0430\u0434\u043A\u0438 \u043C\u043E\u0433\u0443\u0442 \u0442\u043E\u043B\u044C\u043A\u043E \u0430\u0432\u0442\u043E\u0440\u0438\u0437\u043E\u0432\u0430\u043D\u043D\u044B\u0435\n        return !!session?.itemId;\n      },\n      update: () => false, // \u0417\u0430\u043A\u043B\u0430\u0434\u043A\u0438 \u043D\u0435\u043B\u044C\u0437\u044F \u043E\u0431\u043D\u043E\u0432\u043B\u044F\u0442\u044C\n      delete: ({ session, item }: { session?: any; item: any }) => {\n        // \u0423\u0434\u0430\u043B\u044F\u0442\u044C \u043C\u043E\u0436\u0435\u0442 \u0442\u043E\u043B\u044C\u043A\u043E \u0432\u043B\u0430\u0434\u0435\u043B\u0435\u0446 \u0437\u0430\u043A\u043B\u0430\u0434\u043A\u0438\n        if (!session?.itemId) return false;\n        if (!item) return false;\n        return String(item.user?.id || item.user) === String(session.itemId);\n      },\n    },\n    filter: {\n      query: ({ session }: { session?: any }) => {\n        // \u041F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044C \u0432\u0438\u0434\u0438\u0442 \u0442\u043E\u043B\u044C\u043A\u043E \u0441\u0432\u043E\u0438 \u0437\u0430\u043A\u043B\u0430\u0434\u043A\u0438\n        if (!session?.itemId) return false;\n        return {\n          user: { id: { equals: session.itemId } },\n        };\n      },\n    },\n  },\n\n  Follow: {\n    operation: {\n      query: () => true, // \u0427\u0442\u0435\u043D\u0438\u0435 \u043F\u043E\u0434\u043F\u0438\u0441\u043E\u043A - \u043F\u0443\u0431\u043B\u0438\u0447\u043D\u043E\n      create: ({ session }: { session?: any }) => {\n        // \u0421\u043E\u0437\u0434\u0430\u0432\u0430\u0442\u044C \u043F\u043E\u0434\u043F\u0438\u0441\u043A\u0438 \u043C\u043E\u0433\u0443\u0442 \u0442\u043E\u043B\u044C\u043A\u043E \u0430\u0432\u0442\u043E\u0440\u0438\u0437\u043E\u0432\u0430\u043D\u043D\u044B\u0435\n        return !!session?.itemId;\n      },\n      update: () => false, // \u041F\u043E\u0434\u043F\u0438\u0441\u043A\u0438 \u043D\u0435\u043B\u044C\u0437\u044F \u043E\u0431\u043D\u043E\u0432\u043B\u044F\u0442\u044C\n      delete: ({ session, item }: { session?: any; item: any }) => {\n        // \u0423\u0434\u0430\u043B\u044F\u0442\u044C \u043C\u043E\u0436\u0435\u0442 \u0442\u043E\u043B\u044C\u043A\u043E \u0432\u043B\u0430\u0434\u0435\u043B\u0435\u0446 \u043F\u043E\u0434\u043F\u0438\u0441\u043A\u0438 (follower)\n        if (!session?.itemId) return false;\n        if (!item) return false;\n        return String(item.follower?.id || item.follower) === String(session.itemId);\n      },\n    },\n    filter: {\n      query: () => true, // \u0412\u0441\u0435 \u0432\u0438\u0434\u044F\u0442 \u0432\u0441\u0435 \u043F\u043E\u0434\u043F\u0438\u0441\u043A\u0438\n    },\n  },\n\n  Notification: {\n    operation: {\n      query: ({ session }: { session?: any }) => {\n        // \u0427\u0438\u0442\u0430\u0442\u044C \u0443\u0432\u0435\u0434\u043E\u043C\u043B\u0435\u043D\u0438\u044F \u043C\u043E\u0433\u0443\u0442 \u0442\u043E\u043B\u044C\u043A\u043E \u0430\u0432\u0442\u043E\u0440\u0438\u0437\u043E\u0432\u0430\u043D\u043D\u044B\u0435\n        return !!session?.itemId;\n      },\n      create: () => false, // \u0423\u0432\u0435\u0434\u043E\u043C\u043B\u0435\u043D\u0438\u044F \u0441\u043E\u0437\u0434\u0430\u044E\u0442\u0441\u044F \u0442\u043E\u043B\u044C\u043A\u043E \u0441\u0438\u0441\u0442\u0435\u043C\u043E\u0439 \u0447\u0435\u0440\u0435\u0437 hooks\n      update: ({ session }: { session?: any }) => {\n        // \u041E\u0431\u043D\u043E\u0432\u043B\u044F\u0442\u044C \u043C\u043E\u0436\u0435\u0442 \u0442\u043E\u043B\u044C\u043A\u043E \u0430\u0432\u0442\u043E\u0440\u0438\u0437\u043E\u0432\u0430\u043D\u043D\u044B\u0439 \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044C\n        // filter.update \u0443\u0436\u0435 \u0433\u0430\u0440\u0430\u043D\u0442\u0438\u0440\u0443\u0435\u0442, \u0447\u0442\u043E \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044C \u043C\u043E\u0436\u0435\u0442 \u043E\u0431\u043D\u043E\u0432\u043B\u044F\u0442\u044C \u0442\u043E\u043B\u044C\u043A\u043E \u0441\u0432\u043E\u0438 \u0443\u0432\u0435\u0434\u043E\u043C\u043B\u0435\u043D\u0438\u044F\n        // \u0420\u0430\u0437\u0440\u0435\u0448\u0430\u0435\u043C \u043E\u0431\u043D\u043E\u0432\u043B\u044F\u0442\u044C \u0442\u043E\u043B\u044C\u043A\u043E isRead \u0438 readAt\n        return !!session?.itemId;\n      },\n      delete: ({ session }: { session?: any }) => {\n        // \u0423\u0434\u0430\u043B\u044F\u0442\u044C \u043C\u043E\u0436\u0435\u0442 \u0442\u043E\u043B\u044C\u043A\u043E \u0430\u0432\u0442\u043E\u0440\u0438\u0437\u043E\u0432\u0430\u043D\u043D\u044B\u0439 \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044C\n        // filter.delete \u0443\u0436\u0435 \u0433\u0430\u0440\u0430\u043D\u0442\u0438\u0440\u0443\u0435\u0442, \u0447\u0442\u043E \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044C \u043C\u043E\u0436\u0435\u0442 \u0443\u0434\u0430\u043B\u044F\u0442\u044C \u0442\u043E\u043B\u044C\u043A\u043E \u0441\u0432\u043E\u0438 \u0443\u0432\u0435\u0434\u043E\u043C\u043B\u0435\u043D\u0438\u044F\n        return !!session?.itemId;\n      },\n    },\n    filter: {\n      query: ({ session }: { session?: any }) => {\n        // \u041F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044C \u0432\u0438\u0434\u0438\u0442 \u0442\u043E\u043B\u044C\u043A\u043E \u0441\u0432\u043E\u0438 \u0443\u0432\u0435\u0434\u043E\u043C\u043B\u0435\u043D\u0438\u044F\n        if (!session?.itemId) return false;\n        return {\n          user: { id: { equals: session.itemId } },\n        };\n      },\n      update: ({ session }: { session?: any }) => {\n        // \u041E\u0431\u043D\u043E\u0432\u043B\u044F\u0442\u044C \u043C\u043E\u0436\u043D\u043E \u0442\u043E\u043B\u044C\u043A\u043E \u0441\u0432\u043E\u0438 \u0443\u0432\u0435\u0434\u043E\u043C\u043B\u0435\u043D\u0438\u044F\n        if (!session?.itemId) return false;\n        return {\n          user: { id: { equals: session.itemId } },\n        };\n      },\n      delete: ({ session }: { session?: any }) => {\n        // \u0423\u0434\u0430\u043B\u044F\u0442\u044C \u043C\u043E\u0436\u043D\u043E \u0442\u043E\u043B\u044C\u043A\u043E \u0441\u0432\u043E\u0438 \u0443\u0432\u0435\u0434\u043E\u043C\u043B\u0435\u043D\u0438\u044F\n        if (!session?.itemId) return false;\n        return {\n          user: { id: { equals: session.itemId } },\n        };\n      },\n    },\n  },\n};\n\n", "/**\n * Article schema\n * \u0421\u0442\u0430\u0442\u044C\u0438 \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u0435\u0439 \u0441 \u043F\u043E\u0434\u0434\u0435\u0440\u0436\u043A\u043E\u0439 draftAndPublish\n */\nimport { list } from '@keystone-6/core';\nimport { text, relationship, integer, select, timestamp, json, virtual } from '@keystone-6/core/fields';\nimport { graphql } from '@keystone-6/core';\nimport { document } from '@keystone-6/fields-document';\nimport { accessControl } from '../src/access-control';\nimport logger from '../src/lib/logger';\nimport { createNotification } from '../src/lib/notifications';\n\nexport const Article = list({\n  access: accessControl.Article,\n  hooks: {\n    resolveInput: async ({ resolvedData, operation, context, inputData }) => {\n      // \u0410\u0432\u0442\u043E\u043C\u0430\u0442\u0438\u0447\u0435\u0441\u043A\u0438 \u0443\u0441\u0442\u0430\u043D\u0430\u0432\u043B\u0438\u0432\u0430\u0435\u043C \u0430\u0432\u0442\u043E\u0440\u0430 \u0438\u0437 \u0441\u0435\u0441\u0441\u0438\u0438 \u043F\u0440\u0438 \u0441\u043E\u0437\u0434\u0430\u043D\u0438\u0438 \u0441\u0442\u0430\u0442\u044C\u0438\n      if (operation === 'create') {\n        const session = context.session;\n        logger.info(`[Article] resolveInput create: session.itemId=${session?.itemId}, inputData.author=${JSON.stringify(inputData?.author)}, resolvedData.author=${JSON.stringify(resolvedData?.author)}`);\n        \n        if (!session?.itemId) {\n          logger.error('[Article] Attempted to create article without authentication');\n          throw new Error('Authentication required to create an article');\n        }\n        \n        // \u0412\u0441\u0435\u0433\u0434\u0430 \u0443\u0441\u0442\u0430\u043D\u0430\u0432\u043B\u0438\u0432\u0430\u0435\u043C \u0430\u0432\u0442\u043E\u0440\u0430 \u0438\u0437 \u0441\u0435\u0441\u0441\u0438\u0438 \u043F\u0440\u0438 \u0441\u043E\u0437\u0434\u0430\u043D\u0438\u0438\n        // \u042D\u0442\u043E \u0433\u0430\u0440\u0430\u043D\u0442\u0438\u0440\u0443\u0435\u0442, \u0447\u0442\u043E \u0441\u0442\u0430\u0442\u044C\u044F \u0432\u0441\u0435\u0433\u0434\u0430 \u0438\u043C\u0435\u0435\u0442 \u0430\u0432\u0442\u043E\u0440\u0430\n        // \u041F\u0440\u0435\u043E\u0431\u0440\u0430\u0437\u0443\u0435\u043C userId \u0432 \u0447\u0438\u0441\u043B\u043E, \u0442\u0430\u043A \u043A\u0430\u043A Prisma \u043E\u0436\u0438\u0434\u0430\u0435\u0442 Int \u0434\u043B\u044F ID\n        let userId: string | number = session.itemId;\n        if (typeof userId === 'string') {\n          const parsedId = parseInt(userId, 10);\n          if (!isNaN(parsedId)) {\n            userId = parsedId;\n          } else {\n            logger.error(`[Article] Invalid session.itemId format (string, not parsable to int): ${session.itemId}`);\n            throw new Error('Invalid user ID format');\n          }\n        } else if (typeof userId !== 'number') {\n          logger.error(`[Article] Invalid session.itemId type (not string or number): ${typeof session.itemId}`);\n          throw new Error('Invalid user ID type');\n        }\n\n        resolvedData.author = { connect: { id: userId } };\n        logger.info(`[Article] Auto-setting author from session: userId=${userId}, author=${JSON.stringify(resolvedData.author)}`);\n      }\n      return resolvedData;\n    },\n    afterOperation: async ({ operation, item, context, originalItem }) => {\n      // \u0421\u043E\u0437\u0434\u0430\u0435\u043C \u0443\u0432\u0435\u0434\u043E\u043C\u043B\u0435\u043D\u0438\u044F \u0442\u043E\u043B\u044C\u043A\u043E \u043F\u0440\u0438 \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u0438 \u0441\u0442\u0430\u0442\u044C\u0438 (\u043F\u0443\u0431\u043B\u0438\u043A\u0430\u0446\u0438\u044F)\n      if (operation === 'update' && item) {\n        try {\n          // \u041F\u043E\u043B\u0443\u0447\u0430\u0435\u043C \u0442\u0435\u043A\u0443\u0449\u0443\u044E \u0438 \u043F\u0440\u0435\u0434\u044B\u0434\u0443\u0449\u0443\u044E \u0432\u0435\u0440\u0441\u0438\u0438 \u0441\u0442\u0430\u0442\u044C\u0438\n          const currentArticle = await context.query.Article.findOne({\n            where: { id: item.id },\n            query: `\n              id\n              publishedAt\n              author {\n                id\n              }\n            `,\n          });\n\n          if (!currentArticle || !currentArticle.author) {\n            logger.warn(`[Article] afterOperation: Article or author not found: articleId=${item.id}`);\n            return;\n          }\n\n          // \u041F\u0440\u043E\u0432\u0435\u0440\u044F\u0435\u043C, \u0447\u0442\u043E \u0441\u0442\u0430\u0442\u044C\u044F \u0431\u044B\u043B\u0430 \u0442\u043E\u043B\u044C\u043A\u043E \u0447\u0442\u043E \u043E\u043F\u0443\u0431\u043B\u0438\u043A\u043E\u0432\u0430\u043D\u0430 (publishedAt \u0438\u0437\u043C\u0435\u043D\u0438\u043B\u0441\u044F \u0441 null \u043D\u0430 \u0437\u043D\u0430\u0447\u0435\u043D\u0438\u0435)\n          const wasPublished = currentArticle.publishedAt !== null;\n          const wasPreviouslyPublished = originalItem?.publishedAt !== null;\n\n          if (wasPublished && !wasPreviouslyPublished) {\n            // \u0421\u0442\u0430\u0442\u044C\u044F \u0442\u043E\u043B\u044C\u043A\u043E \u0447\u0442\u043E \u043E\u043F\u0443\u0431\u043B\u0438\u043A\u043E\u0432\u0430\u043D\u0430 - \u0443\u0432\u0435\u0434\u043E\u043C\u043B\u044F\u0435\u043C \u0432\u0441\u0435\u0445 \u043F\u043E\u0434\u043F\u0438\u0441\u0447\u0438\u043A\u043E\u0432 \u0430\u0432\u0442\u043E\u0440\u0430\n            logger.debug(`[Article] afterOperation: Article published, finding followers:`, {\n              articleId: currentArticle.id,\n              authorId: currentArticle.author.id,\n            });\n\n            const followers = await context.query.Follow.findMany({\n              where: {\n                following: { id: { equals: String(currentArticle.author.id) } },\n              },\n              query: `\n                id\n                follower {\n                  id\n                }\n              `,\n            });\n\n            logger.debug(`[Article] afterOperation: Found ${followers.length} followers`);\n\n            // \u0421\u043E\u0437\u0434\u0430\u0435\u043C \u0443\u0432\u0435\u0434\u043E\u043C\u043B\u0435\u043D\u0438\u044F \u0434\u043B\u044F \u0432\u0441\u0435\u0445 \u043F\u043E\u0434\u043F\u0438\u0441\u0447\u0438\u043A\u043E\u0432\n            for (const follow of followers) {\n              if (follow.follower?.id) {\n                await createNotification(context, {\n                  type: 'article_published',\n                  userId: follow.follower.id,\n                  actorId: currentArticle.author.id,\n                  articleId: currentArticle.id,\n                });\n              }\n            }\n\n            logger.info(`[Article] afterOperation: Created ${followers.length} notifications for article publication`);\n          }\n        } catch (error: any) {\n          logger.error(`[Article] afterOperation: Failed to create notifications:`, {\n            error: error.message,\n            stack: error.stack,\n            articleId: item.id,\n          });\n        }\n      }\n    },\n  },\n  fields: {\n    title: text({\n      validation: { isRequired: true, length: { min: 10, max: 200 } },\n      isIndexed: true,\n    }),\n    content: document({\n      formatting: true,\n      dividers: true,\n      links: true,\n      layouts: [\n        [1, 1],\n        [1, 1, 1],\n      ],\n    }),\n    excerpt: text({\n      validation: { isRequired: true, length: { max: 500 } },\n    }),\n    author: relationship({\n      ref: 'User.articles',\n      many: false,\n      validation: { isRequired: true },\n    }),\n    tags: json(),\n    difficulty: select({\n      type: 'string',\n      options: [\n        { label: 'Easy', value: 'easy' },\n        { label: 'Medium', value: 'medium' },\n        { label: 'Hard', value: 'hard' },\n      ],\n      defaultValue: 'medium',\n      validation: { isRequired: true },\n    }),\n    previewImage: text(), // URL \u0441\u0442\u0440\u043E\u043A\u0438 (\u043E\u0442 imgBB \u0438\u043B\u0438 Cloudinary)\n    likes_count: integer({\n      defaultValue: 0,\n      validation: { min: 0 },\n    }),\n    dislikes_count: integer({\n      defaultValue: 0,\n      validation: { min: 0 },\n    }),\n    views: integer({\n      defaultValue: 0,\n      validation: { min: 0 },\n    }),\n    comments: relationship({\n      ref: 'Comment.article',\n      many: true,\n    }),\n    reactions: relationship({\n      ref: 'ArticleReaction.article',\n      many: true,\n    }),\n    bookmarks: relationship({\n      ref: 'Bookmark.article',\n      many: true,\n    }),\n    userReaction: virtual({\n      field: graphql.field({\n        type: graphql.String,\n        async resolve(item, args, context) {\n          const session = context.session;\n          if (!session?.itemId) {\n            return null;\n          }\n\n          const userId = session.itemId;\n          const articleId = item.id;\n\n          if (!articleId) {\n            return null;\n          }\n\n          try {\n            // \u041D\u0430\u0445\u043E\u0434\u0438\u043C \u0440\u0435\u0430\u043A\u0446\u0438\u044E \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044F\n            const reaction = await context.query.ArticleReaction.findMany({\n              where: {\n                article: { id: { equals: String(articleId) } },\n                user: { id: { equals: userId } },\n              },\n              query: 'reaction',\n              take: 1,\n            });\n\n            return reaction.length > 0 ? reaction[0].reaction : null;\n          } catch (error) {\n            // \u041B\u043E\u0433\u0438\u0440\u0443\u0435\u043C \u043E\u0448\u0438\u0431\u043A\u0443, \u043D\u043E \u043D\u0435 \u0432\u044B\u0431\u0440\u0430\u0441\u044B\u0432\u0430\u0435\u043C \u0438\u0441\u043A\u043B\u044E\u0447\u0435\u043D\u0438\u0435\n            logger.error('Failed to get userReaction for article:', error);\n            return null;\n          }\n        },\n      }),\n    }),\n    publishedAt: timestamp(),\n    createdAt: timestamp({\n      defaultValue: { kind: 'now' },\n    }),\n    updatedAt: timestamp({\n      defaultValue: { kind: 'now' },\n    }),\n  },\n});\n\n", "/**\n * Winston logger utility\n * \u0421\u0442\u0440\u0443\u043A\u0442\u0443\u0440\u0438\u0440\u043E\u0432\u0430\u043D\u043D\u043E\u0435 \u043B\u043E\u0433\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u0435 \u0434\u043B\u044F \u0432\u0441\u0435\u0433\u043E \u043F\u0440\u0438\u043B\u043E\u0436\u0435\u043D\u0438\u044F\n */\nimport winston from 'winston';\nimport DailyRotateFile from 'winston-daily-rotate-file';\n\nconst logFormat = winston.format.combine(\n  winston.format.timestamp({ format: 'YYYY-MM-DD HH:mm:ss' }),\n  winston.format.errors({ stack: true }),\n  winston.format.splat(),\n  winston.format.json()\n);\n\nconst consoleFormat = winston.format.combine(\n  winston.format.colorize(),\n  winston.format.timestamp({ format: 'YYYY-MM-DD HH:mm:ss' }),\n  winston.format.printf(({ timestamp, level, message, ...meta }) => {\n    let msg = `${timestamp} [${level}]: ${message}`;\n    if (Object.keys(meta).length > 0) {\n      msg += ` ${JSON.stringify(meta)}`;\n    }\n    return msg;\n  })\n);\n\n// Daily rotate file transport \u0434\u043B\u044F \u043B\u043E\u0433\u043E\u0432\nconst fileRotateTransport = new DailyRotateFile({\n  filename: 'logs/application-%DATE%.log',\n  datePattern: 'YYYY-MM-DD',\n  maxSize: '20m',\n  maxFiles: '14d',\n  format: logFormat,\n});\n\nconst errorFileRotateTransport = new DailyRotateFile({\n  filename: 'logs/error-%DATE%.log',\n  datePattern: 'YYYY-MM-DD',\n  level: 'error',\n  maxSize: '20m',\n  maxFiles: '30d',\n  format: logFormat,\n});\n\nexport const logger = winston.createLogger({\n  level: process.env.LOG_LEVEL || (process.env.NODE_ENV === 'production' ? 'info' : 'debug'),\n  format: logFormat,\n  defaultMeta: { service: 'keystonejs-backend' },\n  transports: [\n    fileRotateTransport,\n    errorFileRotateTransport,\n    new winston.transports.Console({\n      format: consoleFormat,\n    }),\n  ],\n  exceptionHandlers: [\n    new winston.transports.File({ filename: 'logs/exceptions.log' }),\n  ],\n  rejectionHandlers: [\n    new winston.transports.File({ filename: 'logs/rejections.log' }),\n  ],\n});\n\n// \u0421\u043E\u0437\u0434\u0430\u0435\u043C \u0434\u0438\u0440\u0435\u043A\u0442\u043E\u0440\u0438\u044E \u0434\u043B\u044F \u043B\u043E\u0433\u043E\u0432 \u0435\u0441\u043B\u0438 \u0435\u0451 \u043D\u0435\u0442\nimport { existsSync, mkdirSync } from 'fs';\nif (!existsSync('logs')) {\n  mkdirSync('logs', { recursive: true });\n}\n\nexport default logger;\n\n", "/**\n * \u0423\u0442\u0438\u043B\u0438\u0442\u044B \u0434\u043B\u044F \u0441\u043E\u0437\u0434\u0430\u043D\u0438\u044F \u0443\u0432\u0435\u0434\u043E\u043C\u043B\u0435\u043D\u0438\u0439\n */\nimport logger from './logger';\n\nexport type NotificationType = \n  | 'comment' \n  | 'comment_reply' \n  | 'follow' \n  | 'article_published' \n  | 'article_like' \n  | 'comment_like';\n\nexport interface CreateNotificationData {\n  type: NotificationType;\n  userId: string | number;\n  actorId: string | number;\n  articleId?: string | number;\n  commentId?: string | number;\n  metadata?: Record<string, any>;\n}\n\n/**\n * \u041F\u0440\u043E\u0432\u0435\u0440\u044F\u0435\u0442, \u0441\u0443\u0449\u0435\u0441\u0442\u0432\u0443\u0435\u0442 \u043B\u0438 \u0443\u0436\u0435 \u0443\u0432\u0435\u0434\u043E\u043C\u043B\u0435\u043D\u0438\u0435 \u0441 \u0442\u0430\u043A\u0438\u043C\u0438 \u0436\u0435 \u043F\u0430\u0440\u0430\u043C\u0435\u0442\u0440\u0430\u043C\u0438\n * @param context KeystoneJS context\n * @param data \u0414\u0430\u043D\u043D\u044B\u0435 \u0434\u043B\u044F \u043F\u0440\u043E\u0432\u0435\u0440\u043A\u0438\n * @param timeWindowMs \u0412\u0440\u0435\u043C\u0435\u043D\u043D\u043E\u0435 \u043E\u043A\u043D\u043E \u0434\u043B\u044F \u043F\u0440\u043E\u0432\u0435\u0440\u043A\u0438 \u0434\u0443\u0431\u043B\u0438\u043A\u0430\u0442\u043E\u0432 (\u043F\u043E \u0443\u043C\u043E\u043B\u0447\u0430\u043D\u0438\u044E 1 \u0447\u0430\u0441)\n * @returns true, \u0435\u0441\u043B\u0438 \u0434\u0443\u0431\u043B\u0438\u043A\u0430\u0442 \u043D\u0430\u0439\u0434\u0435\u043D\n */\nasync function hasDuplicateNotification(\n  context: any,\n  data: CreateNotificationData,\n  timeWindowMs: number = 60 * 60 * 1000 // 1 \u0447\u0430\u0441 \u043F\u043E \u0443\u043C\u043E\u043B\u0447\u0430\u043D\u0438\u044E\n): Promise<boolean> {\n  try {\n    const userId = String(data.userId);\n    const actorId = String(data.actorId);\n    const cutoffTime = new Date(Date.now() - timeWindowMs);\n\n    // \u0421\u0442\u0440\u043E\u0438\u043C \u0444\u0438\u043B\u044C\u0442\u0440 \u0432 \u0437\u0430\u0432\u0438\u0441\u0438\u043C\u043E\u0441\u0442\u0438 \u043E\u0442 \u0442\u0438\u043F\u0430 \u0443\u0432\u0435\u0434\u043E\u043C\u043B\u0435\u043D\u0438\u044F\n    const where: any = {\n      user: { id: { equals: userId } },\n      actor: { id: { equals: actorId } },\n      type: { equals: data.type },\n      createdAt: { gte: cutoffTime.toISOString() }, // \u041F\u0440\u043E\u0432\u0435\u0440\u044F\u0435\u043C \u0442\u043E\u043B\u044C\u043A\u043E \u0437\u0430 \u043F\u043E\u0441\u043B\u0435\u0434\u043D\u0438\u0439 \u0447\u0430\u0441\n    };\n\n    // \u0414\u043B\u044F \u043B\u0430\u0439\u043A\u043E\u0432 \u043F\u0440\u043E\u0432\u0435\u0440\u044F\u0435\u043C \u0442\u0430\u043A\u0436\u0435 \u043F\u043E\u0440\u043E\u0433 \u0432 metadata\n    if (data.type === 'article_like' || data.type === 'comment_like') {\n      if (data.articleId) {\n        where.article = { id: { equals: String(data.articleId) } };\n      }\n      if (data.commentId) {\n        where.comment = { id: { equals: String(data.commentId) } };\n      }\n      // \u0414\u043B\u044F \u043B\u0430\u0439\u043A\u043E\u0432 \u043F\u0440\u043E\u0432\u0435\u0440\u044F\u0435\u043C \u0442\u0430\u043A\u0436\u0435 threshold \u0432 metadata\n      if (data.metadata?.threshold) {\n        // \u0418\u0449\u0435\u043C \u0443\u0432\u0435\u0434\u043E\u043C\u043B\u0435\u043D\u0438\u044F \u0441 \u0442\u0430\u043A\u0438\u043C \u0436\u0435 \u043F\u043E\u0440\u043E\u0433\u043E\u043C\n        const existingNotifications = await context.sudo().query.Notification.findMany({\n          where: {\n            user: { id: { equals: userId } },\n            actor: { id: { equals: actorId } },\n            type: { equals: data.type },\n            createdAt: { gte: cutoffTime.toISOString() },\n            ...(data.articleId ? { article: { id: { equals: String(data.articleId) } } } : {}),\n            ...(data.commentId ? { comment: { id: { equals: String(data.commentId) } } } : {}),\n          },\n          query: 'id metadata',\n        });\n\n        // \u041F\u0440\u043E\u0432\u0435\u0440\u044F\u0435\u043C, \u0435\u0441\u0442\u044C \u043B\u0438 \u0443\u0432\u0435\u0434\u043E\u043C\u043B\u0435\u043D\u0438\u0435 \u0441 \u0442\u0430\u043A\u0438\u043C \u0436\u0435 \u043F\u043E\u0440\u043E\u0433\u043E\u043C\n        return existingNotifications.some(\n          (notif: any) => notif.metadata?.threshold === data.metadata?.threshold\n        );\n      }\n      // \u0415\u0441\u043B\u0438 \u043D\u0435\u0442 threshold \u0432 metadata, \u043F\u0440\u043E\u0434\u043E\u043B\u0436\u0430\u0435\u043C \u043E\u0431\u044B\u0447\u043D\u0443\u044E \u043F\u0440\u043E\u0432\u0435\u0440\u043A\u0443\n    } else if (data.type === 'comment' || data.type === 'comment_reply') {\n      // \u0414\u043B\u044F \u043A\u043E\u043C\u043C\u0435\u043D\u0442\u0430\u0440\u0438\u0435\u0432 \u043F\u0440\u043E\u0432\u0435\u0440\u044F\u0435\u043C articleId \u0438 commentId\n      if (data.articleId) {\n        where.article = { id: { equals: String(data.articleId) } };\n      }\n      if (data.commentId) {\n        where.comment = { id: { equals: String(data.commentId) } };\n      }\n    } else if (data.type === 'follow') {\n      // \u0414\u043B\u044F \u043F\u043E\u0434\u043F\u0438\u0441\u043E\u043A \u043F\u0440\u043E\u0432\u0435\u0440\u044F\u0435\u043C \u0442\u043E\u043B\u044C\u043A\u043E actor \u0438 user (\u0431\u0435\u0437 article/comment)\n      // \u041D\u0438\u0447\u0435\u0433\u043E \u0434\u043E\u043F\u043E\u043B\u043D\u0438\u0442\u0435\u043B\u044C\u043D\u043E\u0433\u043E \u043D\u0435 \u0434\u043E\u0431\u0430\u0432\u043B\u044F\u0435\u043C\n    }\n\n    const existing = await context.sudo().query.Notification.findMany({\n      where,\n      query: 'id',\n      take: 1,\n    });\n\n    return existing.length > 0;\n  } catch (error: any) {\n    logger.error(`[hasDuplicateNotification] Error checking for duplicates:`, {\n      error: error.message,\n      data,\n    });\n    // \u0412 \u0441\u043B\u0443\u0447\u0430\u0435 \u043E\u0448\u0438\u0431\u043A\u0438 \u0432\u043E\u0437\u0432\u0440\u0430\u0449\u0430\u0435\u043C false, \u0447\u0442\u043E\u0431\u044B \u043D\u0435 \u0431\u043B\u043E\u043A\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u043E\u0437\u0434\u0430\u043D\u0438\u0435 \u0443\u0432\u0435\u0434\u043E\u043C\u043B\u0435\u043D\u0438\u044F\n    return false;\n  }\n}\n\n/**\n * \u0421\u043E\u0437\u0434\u0430\u0435\u0442 \u0443\u0432\u0435\u0434\u043E\u043C\u043B\u0435\u043D\u0438\u0435 \u0434\u043B\u044F \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044F \u0441 \u043F\u0440\u043E\u0432\u0435\u0440\u043A\u043E\u0439 \u043D\u0430 \u0434\u0443\u0431\u043B\u0438\u043A\u0430\u0442\u044B\n * @param context KeystoneJS context\n * @param data \u0414\u0430\u043D\u043D\u044B\u0435 \u0434\u043B\u044F \u0441\u043E\u0437\u0434\u0430\u043D\u0438\u044F \u0443\u0432\u0435\u0434\u043E\u043C\u043B\u0435\u043D\u0438\u044F\n * @param skipDuplicateCheck \u041F\u0440\u043E\u043F\u0443\u0441\u0442\u0438\u0442\u044C \u043F\u0440\u043E\u0432\u0435\u0440\u043A\u0443 \u0434\u0443\u0431\u043B\u0438\u043A\u0430\u0442\u043E\u0432 (\u0434\u043B\u044F \u0441\u043B\u0443\u0447\u0430\u0435\u0432, \u043A\u043E\u0433\u0434\u0430 \u043F\u0440\u043E\u0432\u0435\u0440\u043A\u0430 \u0443\u0436\u0435 \u0432\u044B\u043F\u043E\u043B\u043D\u0435\u043D\u0430)\n */\nexport async function createNotification(\n  context: any,\n  data: CreateNotificationData,\n  skipDuplicateCheck: boolean = false\n): Promise<void> {\n  try {\n    // \u041D\u043E\u0440\u043C\u0430\u043B\u0438\u0437\u0443\u0435\u043C ID \u0432 \u0441\u0442\u0440\u043E\u043A\u0438 \u0434\u043B\u044F KeystoneJS\n    const userId = String(data.userId);\n    const actorId = String(data.actorId);\n\n    // \u041D\u0435 \u0441\u043E\u0437\u0434\u0430\u0435\u043C \u0443\u0432\u0435\u0434\u043E\u043C\u043B\u0435\u043D\u0438\u0435, \u0435\u0441\u043B\u0438 \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044C \u0443\u0432\u0435\u0434\u043E\u043C\u043B\u044F\u0435\u0442 \u0441\u0430\u043C \u0441\u0435\u0431\u044F\n    if (userId === actorId) {\n      logger.debug(`[createNotification] Skipping self-notification: userId=${userId}, type=${data.type}`);\n      return;\n    }\n\n    // \u041F\u0440\u043E\u0432\u0435\u0440\u044F\u0435\u043C \u043D\u0430 \u0434\u0443\u0431\u043B\u0438\u043A\u0430\u0442\u044B (\u0435\u0441\u043B\u0438 \u043D\u0435 \u043F\u0440\u043E\u043F\u0443\u0449\u0435\u043D\u0430 \u043F\u0440\u043E\u0432\u0435\u0440\u043A\u0430)\n    if (!skipDuplicateCheck) {\n      const hasDuplicate = await hasDuplicateNotification(context, data);\n      if (hasDuplicate) {\n        logger.debug(`[createNotification] Duplicate notification found, skipping:`, {\n          type: data.type,\n          userId,\n          actorId,\n          articleId: data.articleId,\n          commentId: data.commentId,\n        });\n        return;\n      }\n    }\n\n    const notificationData: any = {\n      user: { connect: { id: userId } },\n      actor: { connect: { id: actorId } },\n      type: data.type,\n      isRead: false,\n    };\n\n    if (data.articleId) {\n      notificationData.article = { connect: { id: String(data.articleId) } };\n    }\n\n    if (data.commentId) {\n      notificationData.comment = { connect: { id: String(data.commentId) } };\n    }\n\n    if (data.metadata) {\n      notificationData.metadata = data.metadata;\n    }\n\n    logger.debug(`[createNotification] Creating notification:`, {\n      type: data.type,\n      userId,\n      actorId,\n      articleId: data.articleId,\n      commentId: data.commentId,\n    });\n\n    await context.sudo().query.Notification.createOne({\n      data: notificationData,\n    });\n\n    logger.info(`[createNotification] Notification created successfully: type=${data.type}, userId=${userId}, actorId=${actorId}`);\n  } catch (error: any) {\n    logger.error(`[createNotification] Failed to create notification:`, {\n      error: error.message,\n      stack: error.stack,\n      data,\n    });\n    // \u041D\u0435 \u0432\u044B\u0431\u0440\u0430\u0441\u044B\u0432\u0430\u0435\u043C \u043E\u0448\u0438\u0431\u043A\u0443, \u0447\u0442\u043E\u0431\u044B \u043D\u0435 \u043F\u0440\u0435\u0440\u044B\u0432\u0430\u0442\u044C \u043E\u0441\u043D\u043E\u0432\u043D\u043E\u0439 \u043F\u0440\u043E\u0446\u0435\u0441\u0441\n  }\n}\n\n/**\n * \u041F\u0440\u043E\u0432\u0435\u0440\u044F\u0435\u0442, \u043D\u0443\u0436\u043D\u043E \u043B\u0438 \u0441\u043E\u0437\u0434\u0430\u0442\u044C \u0443\u0432\u0435\u0434\u043E\u043C\u043B\u0435\u043D\u0438\u0435 \u043E \u043B\u0430\u0439\u043A\u0435 \u043D\u0430 \u043E\u0441\u043D\u043E\u0432\u0435 \u043F\u043E\u0440\u043E\u0433\u043E\u0432\n * @param currentCount \u0422\u0435\u043A\u0443\u0449\u0435\u0435 \u043A\u043E\u043B\u0438\u0447\u0435\u0441\u0442\u0432\u043E \u043B\u0430\u0439\u043A\u043E\u0432\n * @param previousCount \u041F\u0440\u0435\u0434\u044B\u0434\u0443\u0449\u0435\u0435 \u043A\u043E\u043B\u0438\u0447\u0435\u0441\u0442\u0432\u043E \u043B\u0430\u0439\u043A\u043E\u0432\n * @param thresholds \u041C\u0430\u0441\u0441\u0438\u0432 \u043F\u043E\u0440\u043E\u0433\u043E\u0432 \u0434\u043B\u044F \u0443\u0432\u0435\u0434\u043E\u043C\u043B\u0435\u043D\u0438\u0439\n * @returns \u041F\u043E\u0440\u043E\u0433, \u043A\u043E\u0442\u043E\u0440\u044B\u0439 \u0431\u044B\u043B \u0434\u043E\u0441\u0442\u0438\u0433\u043D\u0443\u0442, \u0438\u043B\u0438 null\n */\nexport function shouldNotifyAboutLike(\n  currentCount: number,\n  previousCount: number,\n  thresholds: number[]\n): number | null {\n  // \u0415\u0441\u043B\u0438 \u044D\u0442\u043E \u043F\u0435\u0440\u0432\u044B\u0439 \u043B\u0430\u0439\u043A (previousCount === 0 \u0438 currentCount === 1)\n  if (previousCount === 0 && currentCount === 1) {\n    return 1;\n  }\n\n  // \u041F\u0440\u043E\u0432\u0435\u0440\u044F\u0435\u043C, \u043F\u0435\u0440\u0435\u0441\u0435\u043A \u043B\u0438 \u0441\u0447\u0435\u0442\u0447\u0438\u043A \u043E\u0434\u0438\u043D \u0438\u0437 \u043F\u043E\u0440\u043E\u0433\u043E\u0432\n  for (const threshold of thresholds) {\n    if (previousCount < threshold && currentCount >= threshold) {\n      return threshold;\n    }\n  }\n\n  return null;\n}\n\n", "/**\n * Comment schema\n * \u041A\u043E\u043C\u043C\u0435\u043D\u0442\u0430\u0440\u0438\u0438 \u043A \u0441\u0442\u0430\u0442\u044C\u044F\u043C \u0441 \u043F\u043E\u0434\u0434\u0435\u0440\u0436\u043A\u043E\u0439 \u0432\u043B\u043E\u0436\u0435\u043D\u043D\u044B\u0445 \u043E\u0442\u0432\u0435\u0442\u043E\u0432\n */\nimport { list } from '@keystone-6/core';\nimport { text, relationship, integer, timestamp, virtual } from '@keystone-6/core/fields';\nimport { graphql } from '@keystone-6/core';\nimport { accessControl } from '../src/access-control';\nimport logger from '../src/lib/logger';\nimport { createNotification } from '../src/lib/notifications';\n\nexport const Comment = list({\n  access: accessControl.Comment,\n  hooks: {\n    resolveInput: async ({ resolvedData, operation, context, inputData }) => {\n      // \u0410\u0432\u0442\u043E\u043C\u0430\u0442\u0438\u0447\u0435\u0441\u043A\u0438 \u0443\u0441\u0442\u0430\u043D\u0430\u0432\u043B\u0438\u0432\u0430\u0435\u043C \u0430\u0432\u0442\u043E\u0440\u0430 \u0438\u0437 \u0441\u0435\u0441\u0441\u0438\u0438 \u043F\u0440\u0438 \u0441\u043E\u0437\u0434\u0430\u043D\u0438\u0438 \u043A\u043E\u043C\u043C\u0435\u043D\u0442\u0430\u0440\u0438\u044F\n      if (operation === 'create') {\n        const session = context.session;\n        logger.info(`[Comment] resolveInput create: session.itemId=${session?.itemId}, inputData.author=${JSON.stringify(inputData?.author)}, resolvedData.author=${JSON.stringify(resolvedData?.author)}`);\n        \n        if (!session?.itemId) {\n          logger.error('[Comment] Attempted to create comment without authentication');\n          throw new Error('Authentication required to create a comment');\n        }\n        \n        // \u0412\u0441\u0435\u0433\u0434\u0430 \u0443\u0441\u0442\u0430\u043D\u0430\u0432\u043B\u0438\u0432\u0430\u0435\u043C \u0430\u0432\u0442\u043E\u0440\u0430 \u0438\u0437 \u0441\u0435\u0441\u0441\u0438\u0438 \u043F\u0440\u0438 \u0441\u043E\u0437\u0434\u0430\u043D\u0438\u0438\n        // \u042D\u0442\u043E \u0433\u0430\u0440\u0430\u043D\u0442\u0438\u0440\u0443\u0435\u0442, \u0447\u0442\u043E \u043A\u043E\u043C\u043C\u0435\u043D\u0442\u0430\u0440\u0438\u0439 \u0432\u0441\u0435\u0433\u0434\u0430 \u0438\u043C\u0435\u0435\u0442 \u0430\u0432\u0442\u043E\u0440\u0430\n        // \u041F\u0440\u0435\u043E\u0431\u0440\u0430\u0437\u0443\u0435\u043C userId \u0432 \u0447\u0438\u0441\u043B\u043E, \u0442\u0430\u043A \u043A\u0430\u043A Prisma \u043E\u0436\u0438\u0434\u0430\u0435\u0442 Int \u0434\u043B\u044F ID\n        const userId = typeof session.itemId === 'string' \n          ? parseInt(session.itemId, 10) \n          : Number(session.itemId);\n        if (isNaN(userId)) {\n          logger.error(`[Comment] Invalid userId: ${session.itemId}`);\n          throw new Error('Invalid user ID in session');\n        }\n        resolvedData.author = { connect: { id: userId } };\n        logger.info(`[Comment] Auto-setting author from session: userId=${userId} (type: ${typeof userId}), author=${JSON.stringify(resolvedData.author)}`);\n      }\n      return resolvedData;\n    },\n    afterOperation: async ({ operation, item, context, originalItem }) => {\n      // \u0421\u043E\u0437\u0434\u0430\u0435\u043C \u0443\u0432\u0435\u0434\u043E\u043C\u043B\u0435\u043D\u0438\u044F \u0442\u043E\u043B\u044C\u043A\u043E \u043F\u0440\u0438 \u0441\u043E\u0437\u0434\u0430\u043D\u0438\u0438 \u043A\u043E\u043C\u043C\u0435\u043D\u0442\u0430\u0440\u0438\u044F\n      if (operation === 'create' && item) {\n        try {\n          // \u041F\u043E\u043B\u0443\u0447\u0430\u0435\u043C \u043F\u043E\u043B\u043D\u044B\u0435 \u0434\u0430\u043D\u043D\u044B\u0435 \u043A\u043E\u043C\u043C\u0435\u043D\u0442\u0430\u0440\u0438\u044F \u0441 \u043E\u0442\u043D\u043E\u0448\u0435\u043D\u0438\u044F\u043C\u0438\n          const comment = await context.query.Comment.findOne({\n            where: { id: item.id },\n            query: `\n              id\n              author {\n                id\n              }\n              article {\n                id\n                author {\n                  id\n                }\n              }\n              parent {\n                id\n                author {\n                  id\n                }\n              }\n            `,\n          });\n\n          if (!comment || !comment.author) {\n            logger.warn(`[Comment] afterOperation: Comment or author not found: commentId=${item.id}`);\n            return;\n          }\n\n          const commentAuthorId = comment.author.id;\n          const articleId = comment.article?.id;\n          const articleAuthorId = comment.article?.author?.id;\n          const parentCommentId = comment.parent?.id;\n          const parentAuthorId = comment.parent?.author?.id;\n\n          logger.debug(`[Comment] afterOperation: Creating notifications for comment:`, {\n            commentId: comment.id,\n            commentAuthorId,\n            articleId,\n            articleAuthorId,\n            parentCommentId,\n            parentAuthorId,\n          });\n\n          // \u0415\u0441\u043B\u0438 \u0435\u0441\u0442\u044C \u0440\u043E\u0434\u0438\u0442\u0435\u043B\u044C\u0441\u043A\u0438\u0439 \u043A\u043E\u043C\u043C\u0435\u043D\u0442\u0430\u0440\u0438\u0439 - \u0443\u0432\u0435\u0434\u043E\u043C\u043B\u044F\u0435\u043C \u0430\u0432\u0442\u043E\u0440\u0430 \u0440\u043E\u0434\u0438\u0442\u0435\u043B\u044C\u0441\u043A\u043E\u0433\u043E \u043A\u043E\u043C\u043C\u0435\u043D\u0442\u0430\u0440\u0438\u044F\n          if (parentCommentId && parentAuthorId) {\n            await createNotification(context, {\n              type: 'comment_reply',\n              userId: parentAuthorId,\n              actorId: commentAuthorId,\n              articleId,\n              commentId: parentCommentId,\n            }, false); // \u041F\u0440\u043E\u0432\u0435\u0440\u043A\u0430 \u0434\u0443\u0431\u043B\u0438\u043A\u0430\u0442\u043E\u0432 \u0432\u043A\u043B\u044E\u0447\u0435\u043D\u0430\n          } else if (articleId && articleAuthorId) {\n            // \u0415\u0441\u043B\u0438 \u043D\u0435\u0442 \u0440\u043E\u0434\u0438\u0442\u0435\u043B\u044C\u0441\u043A\u043E\u0433\u043E \u043A\u043E\u043C\u043C\u0435\u043D\u0442\u0430\u0440\u0438\u044F - \u0443\u0432\u0435\u0434\u043E\u043C\u043B\u044F\u0435\u043C \u0430\u0432\u0442\u043E\u0440\u0430 \u0441\u0442\u0430\u0442\u044C\u0438\n            await createNotification(context, {\n              type: 'comment',\n              userId: articleAuthorId,\n              actorId: commentAuthorId,\n              articleId,\n              commentId: comment.id,\n            }, false); // \u041F\u0440\u043E\u0432\u0435\u0440\u043A\u0430 \u0434\u0443\u0431\u043B\u0438\u043A\u0430\u0442\u043E\u0432 \u0432\u043A\u043B\u044E\u0447\u0435\u043D\u0430\n          }\n        } catch (error: any) {\n          logger.error(`[Comment] afterOperation: Failed to create notifications:`, {\n            error: error.message,\n            stack: error.stack,\n            commentId: item.id,\n          });\n        }\n      }\n    },\n  },\n  fields: {\n    text: text({\n      validation: { isRequired: true, length: { min: 1, max: 10000 } },\n    }),\n    article: relationship({\n      ref: 'Article.comments',\n      many: false,\n      validation: { isRequired: true },\n    }),\n    author: relationship({\n      ref: 'User.comments',\n      many: false,\n      validation: { isRequired: true },\n    }),\n    parent: relationship({\n      ref: 'Comment',\n      many: false,\n    }),\n    likes_count: integer({\n      defaultValue: 0,\n      validation: { min: 0 },\n    }),\n    dislikes_count: integer({\n      defaultValue: 0,\n      validation: { min: 0 },\n    }),\n    reactions: relationship({\n      ref: 'CommentReaction.comment',\n      many: true,\n    }),\n    userReaction: virtual({\n      field: graphql.field({\n        type: graphql.String,\n        async resolve(item, args, context) {\n          const session = context.session;\n          if (!session?.itemId) {\n            return null;\n          }\n\n          const userId = session.itemId;\n          const commentId = item.id;\n\n          if (!commentId) {\n            return null;\n          }\n\n          try {\n            // \u041D\u0430\u0445\u043E\u0434\u0438\u043C \u0440\u0435\u0430\u043A\u0446\u0438\u044E \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044F\n            const reaction = await context.query.CommentReaction.findMany({\n              where: {\n                comment: { id: { equals: String(commentId) } },\n                user: { id: { equals: userId } },\n              },\n              query: 'reaction',\n              take: 1,\n            });\n\n            return reaction.length > 0 ? reaction[0].reaction : null;\n          } catch (error) {\n            // \u041B\u043E\u0433\u0438\u0440\u0443\u0435\u043C \u043E\u0448\u0438\u0431\u043A\u0443, \u043D\u043E \u043D\u0435 \u0432\u044B\u0431\u0440\u0430\u0441\u044B\u0432\u0430\u0435\u043C \u0438\u0441\u043A\u043B\u044E\u0447\u0435\u043D\u0438\u0435\n            logger.error('Failed to get userReaction for comment:', error);\n            return null;\n          }\n        },\n      }),\n    }),\n    createdAt: timestamp({\n      defaultValue: { kind: 'now' },\n    }),\n    updatedAt: timestamp({\n      defaultValue: { kind: 'now' },\n    }),\n  },\n});\n\n", "/**\n * ArticleReaction schema\n * \u0420\u0435\u0430\u043A\u0446\u0438\u0438 \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u0435\u0439 \u043D\u0430 \u0441\u0442\u0430\u0442\u044C\u0438 (like/dislike)\n */\nimport { list } from '@keystone-6/core';\nimport { relationship, select, timestamp } from '@keystone-6/core/fields';\nimport { accessControl } from '../src/access-control';\n\nexport const ArticleReaction = list({\n  access: accessControl.ArticleReaction,\n  fields: {\n    article: relationship({\n      ref: 'Article.reactions',\n      many: false,\n      validation: { isRequired: true },\n    }),\n    user: relationship({\n      ref: 'User.articleReactions',\n      many: false,\n      validation: { isRequired: true },\n    }),\n    reaction: select({\n      type: 'string',\n      options: [\n        { label: 'Like', value: 'like' },\n        { label: 'Dislike', value: 'dislike' },\n      ],\n      validation: { isRequired: true },\n    }),\n    createdAt: timestamp({\n      defaultValue: { kind: 'now' },\n    }),\n  },\n});\n\n", "/**\n * CommentReaction schema\n * \u0420\u0435\u0430\u043A\u0446\u0438\u0438 \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u0435\u0439 \u043D\u0430 \u043A\u043E\u043C\u043C\u0435\u043D\u0442\u0430\u0440\u0438\u0438 (like/dislike)\n */\nimport { list } from '@keystone-6/core';\nimport { relationship, select, timestamp } from '@keystone-6/core/fields';\nimport { accessControl } from '../src/access-control';\n\nexport const CommentReaction = list({\n  access: accessControl.CommentReaction,\n  fields: {\n    comment: relationship({\n      ref: 'Comment.reactions',\n      many: false,\n      validation: { isRequired: true },\n    }),\n    user: relationship({\n      ref: 'User.commentReactions',\n      many: false,\n      validation: { isRequired: true },\n    }),\n    reaction: select({\n      type: 'string',\n      options: [\n        { label: 'Like', value: 'like' },\n        { label: 'Dislike', value: 'dislike' },\n      ],\n      validation: { isRequired: true },\n    }),\n    createdAt: timestamp({\n      defaultValue: { kind: 'now' },\n    }),\n  },\n});\n\n", "/**\n * Bookmark schema\n * \u0417\u0430\u043A\u043B\u0430\u0434\u043A\u0438 \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u0435\u0439 \u043D\u0430 \u0441\u0442\u0430\u0442\u044C\u0438\n */\nimport { list } from '@keystone-6/core';\nimport { relationship, timestamp } from '@keystone-6/core/fields';\nimport { accessControl } from '../src/access-control';\nimport logger from '../src/lib/logger';\n\nexport const Bookmark = list({\n  access: accessControl.Bookmark,\n  hooks: {\n    resolveInput: async ({ resolvedData, operation, context, inputData }) => {\n      // \u0410\u0432\u0442\u043E\u043C\u0430\u0442\u0438\u0447\u0435\u0441\u043A\u0438 \u0443\u0441\u0442\u0430\u043D\u0430\u0432\u043B\u0438\u0432\u0430\u0435\u043C \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044F \u0438\u0437 \u0441\u0435\u0441\u0441\u0438\u0438 \u043F\u0440\u0438 \u0441\u043E\u0437\u0434\u0430\u043D\u0438\u0438 \u0437\u0430\u043A\u043B\u0430\u0434\u043A\u0438\n      if (operation === 'create') {\n        const session = context.session;\n        logger.info(`[Bookmark] resolveInput create: session.itemId=${session?.itemId}, inputData.user=${JSON.stringify(inputData?.user)}, resolvedData.user=${JSON.stringify(resolvedData?.user)}`);\n        \n        if (!session?.itemId) {\n          logger.error('[Bookmark] Attempted to create bookmark without authentication');\n          throw new Error('Authentication required to create a bookmark');\n        }\n        \n        // \u0412\u0441\u0435\u0433\u0434\u0430 \u0443\u0441\u0442\u0430\u043D\u0430\u0432\u043B\u0438\u0432\u0430\u0435\u043C \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044F \u0438\u0437 \u0441\u0435\u0441\u0441\u0438\u0438 \u043F\u0440\u0438 \u0441\u043E\u0437\u0434\u0430\u043D\u0438\u0438\n        let userId: string | number = session.itemId;\n        if (typeof userId === 'string') {\n          const parsedId = parseInt(userId, 10);\n          if (!isNaN(parsedId)) {\n            userId = parsedId;\n          } else {\n            logger.error(`[Bookmark] Invalid session.itemId format (string, not parsable to int): ${session.itemId}`);\n            throw new Error('Invalid user ID format');\n          }\n        } else if (typeof userId !== 'number') {\n          logger.error(`[Bookmark] Invalid session.itemId type (not string or number): ${typeof session.itemId}`);\n          throw new Error('Invalid user ID type');\n        }\n\n        resolvedData.user = { connect: { id: userId } };\n        logger.info(`[Bookmark] Auto-setting user from session: userId=${userId}, user=${JSON.stringify(resolvedData.user)}`);\n      }\n      return resolvedData;\n    },\n  },\n  fields: {\n    user: relationship({\n      ref: 'User.bookmarks',\n      many: false,\n      validation: { isRequired: true },\n    }),\n    article: relationship({\n      ref: 'Article.bookmarks',\n      many: false,\n      validation: { isRequired: true },\n    }),\n    createdAt: timestamp({\n      defaultValue: { kind: 'now' },\n    }),\n  },\n});\n\n", "/**\n * Follow schema\n * \u041F\u043E\u0434\u043F\u0438\u0441\u043A\u0438 \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u0435\u0439 \u0434\u0440\u0443\u0433 \u043D\u0430 \u0434\u0440\u0443\u0433\u0430\n */\nimport { list } from '@keystone-6/core';\nimport { relationship, timestamp } from '@keystone-6/core/fields';\nimport { accessControl } from '../src/access-control';\nimport logger from '../src/lib/logger';\nimport { createNotification } from '../src/lib/notifications';\n\nexport const Follow = list({\n  access: accessControl.Follow,\n  hooks: {\n    resolveInput: async ({ resolvedData, operation, context, inputData }) => {\n      // \u0410\u0432\u0442\u043E\u043C\u0430\u0442\u0438\u0447\u0435\u0441\u043A\u0438 \u0443\u0441\u0442\u0430\u043D\u0430\u0432\u043B\u0438\u0432\u0430\u0435\u043C follower \u0438\u0437 \u0441\u0435\u0441\u0441\u0438\u0438 \u043F\u0440\u0438 \u0441\u043E\u0437\u0434\u0430\u043D\u0438\u0438 \u043F\u043E\u0434\u043F\u0438\u0441\u043A\u0438\n      if (operation === 'create') {\n        const session = context.session;\n        logger.info(`[Follow] resolveInput create: session.itemId=${session?.itemId}, inputData.follower=${JSON.stringify(inputData?.follower)}, resolvedData.follower=${JSON.stringify(resolvedData?.follower)}`);\n        \n        if (!session?.itemId) {\n          logger.error('[Follow] Attempted to create follow without authentication');\n          throw new Error('Authentication required to create a follow');\n        }\n        \n        // \u0412\u0441\u0435\u0433\u0434\u0430 \u0443\u0441\u0442\u0430\u043D\u0430\u0432\u043B\u0438\u0432\u0430\u0435\u043C follower \u0438\u0437 \u0441\u0435\u0441\u0441\u0438\u0438 \u043F\u0440\u0438 \u0441\u043E\u0437\u0434\u0430\u043D\u0438\u0438\n        let userId: string | number = session.itemId;\n        if (typeof userId === 'string') {\n          const parsedId = parseInt(userId, 10);\n          if (!isNaN(parsedId)) {\n            userId = parsedId;\n          } else {\n            logger.error(`[Follow] Invalid session.itemId format (string, not parsable to int): ${session.itemId}`);\n            throw new Error('Invalid user ID format');\n          }\n        } else if (typeof userId !== 'number') {\n          logger.error(`[Follow] Invalid session.itemId type (not string or number): ${typeof session.itemId}`);\n          throw new Error('Invalid user ID type');\n        }\n\n        resolvedData.follower = { connect: { id: userId } };\n        logger.info(`[Follow] Auto-setting follower from session: userId=${userId}, follower=${JSON.stringify(resolvedData.follower)}`);\n      }\n      return resolvedData;\n    },\n    afterOperation: async ({ operation, item, context }) => {\n      // \u0421\u043E\u0437\u0434\u0430\u0435\u043C \u0443\u0432\u0435\u0434\u043E\u043C\u043B\u0435\u043D\u0438\u0435 \u0442\u043E\u043B\u044C\u043A\u043E \u043F\u0440\u0438 \u0441\u043E\u0437\u0434\u0430\u043D\u0438\u0438 \u043F\u043E\u0434\u043F\u0438\u0441\u043A\u0438\n      if (operation === 'create' && item) {\n        try {\n          // \u041F\u043E\u043B\u0443\u0447\u0430\u0435\u043C \u043F\u043E\u043B\u043D\u044B\u0435 \u0434\u0430\u043D\u043D\u044B\u0435 \u043F\u043E\u0434\u043F\u0438\u0441\u043A\u0438 \u0441 \u043E\u0442\u043D\u043E\u0448\u0435\u043D\u0438\u044F\u043C\u0438\n          const follow = await context.query.Follow.findOne({\n            where: { id: item.id },\n            query: `\n              id\n              follower {\n                id\n              }\n              following {\n                id\n              }\n            `,\n          });\n\n          if (!follow || !follow.follower || !follow.following) {\n            logger.warn(`[Follow] afterOperation: Follow or relationships not found: followId=${item.id}`);\n            return;\n          }\n\n          const followerId = follow.follower.id;\n          const followingId = follow.following.id;\n\n          logger.debug(`[Follow] afterOperation: Creating notification for follow:`, {\n            followId: follow.id,\n            followerId,\n            followingId,\n          });\n\n          // \u0423\u0432\u0435\u0434\u043E\u043C\u043B\u044F\u0435\u043C \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044F, \u043D\u0430 \u043A\u043E\u0442\u043E\u0440\u043E\u0433\u043E \u043F\u043E\u0434\u043F\u0438\u0441\u0430\u043B\u0438\u0441\u044C\n          // \u041F\u0440\u043E\u0432\u0435\u0440\u043A\u0430 \u0434\u0443\u0431\u043B\u0438\u043A\u0430\u0442\u043E\u0432 \u043F\u0440\u0435\u0434\u043E\u0442\u0432\u0440\u0430\u0442\u0438\u0442 \u0441\u043E\u0437\u0434\u0430\u043D\u0438\u0435 \u0443\u0432\u0435\u0434\u043E\u043C\u043B\u0435\u043D\u0438\u044F \u043F\u0440\u0438 \u043F\u043E\u0432\u0442\u043E\u0440\u043D\u043E\u0439 \u043F\u043E\u0434\u043F\u0438\u0441\u043A\u0435\n          await createNotification(context, {\n            type: 'follow',\n            userId: followingId,\n            actorId: followerId,\n          }, false); // \u041F\u0440\u043E\u0432\u0435\u0440\u043A\u0430 \u0434\u0443\u0431\u043B\u0438\u043A\u0430\u0442\u043E\u0432 \u0432\u043A\u043B\u044E\u0447\u0435\u043D\u0430\n        } catch (error: any) {\n          logger.error(`[Follow] afterOperation: Failed to create notification:`, {\n            error: error.message,\n            stack: error.stack,\n            followId: item.id,\n          });\n        }\n      }\n    },\n  },\n  fields: {\n    follower: relationship({\n      ref: 'User.following',\n      many: false,\n      validation: { isRequired: true },\n    }),\n    following: relationship({\n      ref: 'User.followers',\n      many: false,\n      validation: { isRequired: true },\n    }),\n    createdAt: timestamp({\n      defaultValue: { kind: 'now' },\n    }),\n  },\n});\n\n", "/**\n * Notification schema\n * \u0423\u0432\u0435\u0434\u043E\u043C\u043B\u0435\u043D\u0438\u044F \u0434\u043B\u044F \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u0435\u0439 \u043E \u0440\u0430\u0437\u043B\u0438\u0447\u043D\u044B\u0445 \u0441\u043E\u0431\u044B\u0442\u0438\u044F\u0445\n */\nimport { list } from '@keystone-6/core';\nimport { relationship, select, checkbox, timestamp, json } from '@keystone-6/core/fields';\nimport { accessControl } from '../src/access-control';\nimport logger from '../src/lib/logger';\n\nexport const Notification = list({\n  access: accessControl.Notification,\n  hooks: {\n    afterOperation: async ({ operation, item, context, originalItem }) => {\n      // \u041B\u043E\u0433\u0438\u0440\u0443\u0435\u043C \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u0435 \u0443\u0432\u0435\u0434\u043E\u043C\u043B\u0435\u043D\u0438\u044F \u0434\u043B\u044F \u043E\u0442\u043B\u0430\u0434\u043A\u0438\n      if (operation === 'update' && item) {\n        logger.info(`[Notification] afterOperation update:`, {\n          notificationId: item.id,\n          isRead: item.isRead,\n          readAt: item.readAt,\n          originalIsRead: originalItem?.isRead,\n        });\n      }\n    },\n  },\n  fields: {\n    user: relationship({\n      ref: 'User.notifications',\n      many: false,\n      validation: { isRequired: true },\n      isIndexed: true,\n    }),\n    type: select({\n      type: 'string',\n      options: [\n        { label: 'Comment', value: 'comment' },\n        { label: 'Comment Reply', value: 'comment_reply' },\n        { label: 'Follow', value: 'follow' },\n        { label: 'Article Published', value: 'article_published' },\n        { label: 'Article Like', value: 'article_like' },\n        { label: 'Comment Like', value: 'comment_like' },\n      ],\n      validation: { isRequired: true },\n      isIndexed: true,\n    }),\n    actor: relationship({\n      ref: 'User',\n      many: false,\n      validation: { isRequired: true },\n    }),\n    article: relationship({\n      ref: 'Article',\n      many: false,\n    }),\n    comment: relationship({\n      ref: 'Comment',\n      many: false,\n    }),\n    isRead: checkbox({\n      defaultValue: false,\n      isIndexed: true,\n    }),\n    readAt: timestamp(),\n    metadata: json(),\n    createdAt: timestamp({\n      defaultValue: { kind: 'now' },\n      isIndexed: true,\n    }),\n  },\n});\n\n", "/**\n * \u042D\u043A\u0441\u043F\u043E\u0440\u0442 \u0432\u0441\u0435\u0445 \u0441\u0445\u0435\u043C \u0434\u0430\u043D\u043D\u044B\u0445\n */\nimport { User } from './User';\nimport { Article } from './Article';\nimport { Comment } from './Comment';\nimport { ArticleReaction } from './ArticleReaction';\nimport { CommentReaction } from './CommentReaction';\nimport { Bookmark } from './Bookmark';\nimport { Follow } from './Follow';\nimport { Notification } from './Notification';\n\nexport const lists = {\n  User,\n  Article,\n  Comment,\n  ArticleReaction,\n  CommentReaction,\n  Bookmark,\n  Follow,\n  Notification,\n};\n\n", "/**\n * KeystoneJS authentication configuration\n * \u0418\u0441\u043F\u043E\u043B\u044C\u0437\u0443\u0435\u0442 \u0432\u0441\u0442\u0440\u043E\u0435\u043D\u043D\u0443\u044E \u0430\u0443\u0442\u0435\u043D\u0442\u0438\u0444\u0438\u043A\u0430\u0446\u0438\u044E KeystoneJS\n */\nimport { statelessSessions } from '@keystone-6/core/session';\nimport { createAuth } from '@keystone-6/auth';\nimport logger from '../lib/logger';\n\n// Stateless sessions \u0441 JWT\n// \u0412\u0410\u0416\u041D\u041E: \u0418\u043C\u044F cookie \u0434\u043E\u043B\u0436\u043D\u043E \u0441\u043E\u0432\u043F\u0430\u0434\u0430\u0442\u044C \u0441 \u0442\u0435\u043C, \u0447\u0442\u043E \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u0443\u0435\u0442\u0441\u044F \u0432 /api/auth/oauth/session\nexport const session = statelessSessions({\n  secret: process.env.SESSION_SECRET || 'change-me-in-production',\n  maxAge: 7 * 24 * 60 * 60, // 7 \u0434\u043D\u0435\u0439\n  // \u042F\u0432\u043D\u043E \u0443\u043A\u0430\u0437\u044B\u0432\u0430\u0435\u043C \u0438\u043C\u044F cookie \u0434\u043B\u044F \u0441\u043E\u0432\u043C\u0435\u0441\u0442\u0438\u043C\u043E\u0441\u0442\u0438\n  // \u041F\u043E \u0443\u043C\u043E\u043B\u0447\u0430\u043D\u0438\u044E KeystoneJS \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u0443\u0435\u0442 'keystonejs-session'\n});\n\n// \u0411\u0430\u0437\u043E\u0432\u0430\u044F \u0430\u0443\u0442\u0435\u043D\u0442\u0438\u0444\u0438\u043A\u0430\u0446\u0438\u044F \u0447\u0435\u0440\u0435\u0437 email/password\n// TODO: \u0418\u043D\u0442\u0435\u0433\u0440\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0441 Passport.js \u0434\u043B\u044F OAuth2\nconst { withAuth } = createAuth({\n  listKey: 'User',\n  identityField: 'email',\n  secretField: 'password',\n  sessionData: 'id email username role',\n  passwordResetLink: {\n    sendToken: async ({ itemId, identity, token, context }) => {\n      // TODO: \u0420\u0435\u0430\u043B\u0438\u0437\u043E\u0432\u0430\u0442\u044C \u043E\u0442\u043F\u0440\u0430\u0432\u043A\u0443 email \u0441 \u0442\u043E\u043A\u0435\u043D\u043E\u043C \u0441\u0431\u0440\u043E\u0441\u0430 \u043F\u0430\u0440\u043E\u043B\u044F\n      logger.info(`Password reset token for ${identity}: ${token}`);\n    },\n    tokensValidForMins: 60,\n  },\n  magicAuthLink: {\n    sendToken: async ({ itemId, identity, token, context }) => {\n      // TODO: \u0420\u0435\u0430\u043B\u0438\u0437\u043E\u0432\u0430\u0442\u044C \u043E\u0442\u043F\u0440\u0430\u0432\u043A\u0443 email \u0441 magic link\n      logger.info(`Magic auth token for ${identity}: ${token}`);\n    },\n    tokensValidForMins: 60,\n  },\n});\n\nlogger.info('\u2705 KeystoneJS authentication configured');\n\nexport { withAuth };\n\n", "/**\n * Express middleware configuration\n * \u041D\u0430\u0441\u0442\u0440\u043E\u0439\u043A\u0430 \u0432\u0441\u0435\u0445 middleware \u0432 \u043F\u0440\u0430\u0432\u0438\u043B\u044C\u043D\u043E\u043C \u043F\u043E\u0440\u044F\u0434\u043A\u0435\n */\nimport type { Express } from 'express';\nimport type { KeystoneContext } from '@keystone-6/core/types';\nimport express from 'express';\nimport helmet from 'helmet';\nimport cors from 'cors';\nimport compression from 'compression';\nimport rateLimit from 'express-rate-limit';\nimport expressSession from 'express-session';\nimport RedisStore from 'connect-redis';\nimport morgan from 'morgan';\nimport passport from 'passport';\nimport multer from 'multer';\nimport { getRedisClientWithFallback } from '../lib/redis';\nimport logger from '../lib/logger';\nimport { findOrCreateGoogleUser } from '../auth/oauth-handler';\nimport '../auth/passport'; // \u0418\u043D\u0438\u0446\u0438\u0430\u043B\u0438\u0437\u0430\u0446\u0438\u044F Passport.js\nimport { logRateLimitExceeded, logLoginAttempt } from '../lib/security-logger';\n\n// \u0421\u043E\u0445\u0440\u0430\u043D\u044F\u0435\u043C context \u0432 \u043C\u043E\u0434\u0443\u043B\u0435 \u0434\u043B\u044F \u0434\u043E\u0441\u0442\u0443\u043F\u0430 \u0438\u0437 OAuth handlers\nlet keystoneContext: KeystoneContext | null = null;\n\nexport function setKeystoneContext(context: KeystoneContext) {\n  keystoneContext = context;\n}\n\nexport async function extendExpressApp(\n  app: Express,\n  context?: KeystoneContext\n) {\n  // \u0421\u043E\u0445\u0440\u0430\u043D\u044F\u0435\u043C context \u0434\u043B\u044F \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u043D\u0438\u044F \u0432 OAuth handlers\n  if (context) {\n    setKeystoneContext(context);\n  }\n  \n  // \u041D\u0430\u0441\u0442\u0440\u0430\u0438\u0432\u0430\u0435\u043C multer \u0434\u043B\u044F \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0439 (\u0434\u043E\u043B\u0436\u0435\u043D \u0431\u044B\u0442\u044C \u043E\u043F\u0440\u0435\u0434\u0435\u043B\u0435\u043D \u0434\u043E \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u043D\u0438\u044F)\n  const upload = multer({\n    storage: multer.memoryStorage(), // \u0425\u0440\u0430\u043D\u0438\u043C \u0444\u0430\u0439\u043B \u0432 \u043F\u0430\u043C\u044F\u0442\u0438 \u0434\u043B\u044F \u043E\u0442\u043F\u0440\u0430\u0432\u043A\u0438 \u043D\u0430 ImgBB\n    limits: {\n      fileSize: 8 * 1024 * 1024, // 8MB \u043C\u0430\u043A\u0441\u0438\u043C\u0443\u043C\n    },\n    fileFilter: (req, file, cb) => {\n      // \u0412\u0430\u043B\u0438\u0434\u0430\u0446\u0438\u044F \u0442\u0438\u043F\u0430 \u0444\u0430\u0439\u043B\u0430\n      const allowedMimeTypes = [\n        'image/jpeg',\n        'image/jpg',\n        'image/png',\n        'image/gif',\n        'image/webp',\n      ];\n      \n      if (allowedMimeTypes.includes(file.mimetype)) {\n        cb(null, true);\n      } else {\n        cb(new Error(`Invalid file type: ${file.mimetype}. Allowed types: ${allowedMimeTypes.join(', ')}`));\n      }\n    },\n  });\n  \n  // 0. Body parser \u0434\u043B\u044F JSON (\u0434\u043E\u043B\u0436\u0435\u043D \u0431\u044B\u0442\u044C \u043F\u0435\u0440\u0432\u044B\u043C \u0434\u043B\u044F \u043F\u0430\u0440\u0441\u0438\u043D\u0433\u0430 \u0442\u0435\u043B\u0430 \u0437\u0430\u043F\u0440\u043E\u0441\u043E\u0432)\n  // \u0412\u0410\u0416\u041D\u041E: \u041D\u0435 \u043F\u0440\u0438\u043C\u0435\u043D\u044F\u0435\u043C body parser \u043A /api/upload/image, \u0442\u0430\u043A \u043A\u0430\u043A \u0442\u0430\u043C \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u0443\u0435\u0442\u0441\u044F multer\n  app.use((req, res, next) => {\n    // \u041F\u0440\u043E\u043F\u0443\u0441\u043A\u0430\u0435\u043C body parser \u0434\u043B\u044F multipart/form-data \u0437\u0430\u043F\u0440\u043E\u0441\u043E\u0432 (\u043E\u0431\u0440\u0430\u0431\u0430\u0442\u044B\u0432\u0430\u044E\u0442\u0441\u044F multer)\n    if (req.path === '/api/upload/image' && req.method === 'POST') {\n      return next();\n    }\n    express.json()(req, res, next);\n  });\n  \n  app.use((req, res, next) => {\n    // \u041F\u0440\u043E\u043F\u0443\u0441\u043A\u0430\u0435\u043C urlencoded parser \u0434\u043B\u044F multipart/form-data \u0437\u0430\u043F\u0440\u043E\u0441\u043E\u0432\n    if (req.path === '/api/upload/image' && req.method === 'POST') {\n      return next();\n    }\n    express.urlencoded({ extended: true })(req, res, next);\n  });\n\n  // 2. Helmet - Security headers\n  // \u0412 development \u043E\u0442\u043A\u043B\u044E\u0447\u0430\u0435\u043C CSP \u0434\u043B\u044F Admin UI (Next.js \u0442\u0440\u0435\u0431\u0443\u0435\u0442 unsafe-eval \u0434\u043B\u044F hot reload)\n  const isDevelopment = process.env.NODE_ENV === 'development';\n  app.use(\n    helmet({\n      contentSecurityPolicy: isDevelopment\n        ? false // \u041E\u0442\u043A\u043B\u044E\u0447\u0430\u0435\u043C CSP \u0432 development \u0434\u043B\u044F Admin UI\n        : {\n            directives: {\n              defaultSrc: [\"'self'\"],\n              styleSrc: [\"'self'\", \"'unsafe-inline'\"],\n              scriptSrc: [\n                \"'self'\",\n                \"'unsafe-inline'\",\n                \"'unsafe-eval'\", // \u0422\u0440\u0435\u0431\u0443\u0435\u0442\u0441\u044F \u0434\u043B\u044F Next.js\n              ],\n              imgSrc: [\"'self'\", 'data:', 'https:', 'http:'],\n              connectSrc: [\n                \"'self'\",\n                'https://oauth2.googleapis.com',\n                'https://www.googleapis.com',\n              ],\n            },\n          },\n      // \u0414\u043E\u043F\u043E\u043B\u043D\u0438\u0442\u0435\u043B\u044C\u043D\u044B\u0435 security headers\n      hsts: {\n        maxAge: 31536000, // 1 \u0433\u043E\u0434\n        includeSubDomains: true,\n        preload: true,\n      },\n      frameguard: {\n        action: 'deny', // \u0417\u0430\u043F\u0440\u0435\u0449\u0430\u0435\u043C \u0432\u0441\u0442\u0440\u0430\u0438\u0432\u0430\u043D\u0438\u0435 \u0432 iframe (\u0437\u0430\u0449\u0438\u0442\u0430 \u043E\u0442 clickjacking)\n      },\n      noSniff: true, // \u0417\u0430\u043F\u0440\u0435\u0449\u0430\u0435\u043C MIME type sniffing\n      xssFilter: true, // XSS \u0444\u0438\u043B\u044C\u0442\u0440\n      referrerPolicy: {\n        policy: 'strict-origin-when-cross-origin',\n      },\n    })\n  );\n\n  // 3. CORS\n  app.use(\n    cors({\n      origin: [\n        process.env.FRONTEND_URL || 'http://localhost:5173',\n        process.env.PUBLIC_URL || 'http://localhost:1337',\n      ],\n      credentials: true,\n      methods: ['GET', 'POST', 'PUT', 'PATCH', 'DELETE', 'OPTIONS'],\n    })\n  );\n\n  // 4. Compression\n  app.use(compression());\n\n  // 5. Rate limiting\n  const limiter = rateLimit({\n    windowMs: 15 * 60 * 1000, // 15 \u043C\u0438\u043D\u0443\u0442\n    max: 100, // \u043C\u0430\u043A\u0441\u0438\u043C\u0443\u043C 100 \u0437\u0430\u043F\u0440\u043E\u0441\u043E\u0432 \u0441 \u043E\u0434\u043D\u043E\u0433\u043E IP\n    message: 'Too many requests from this IP, please try again later.',\n    standardHeaders: true,\n    legacyHeaders: false,\n    skip: (req) => {\n      // \u041F\u0440\u043E\u043F\u0443\u0441\u043A\u0430\u0435\u043C GraphQL endpoint (\u043E\u043D \u0438\u043C\u0435\u0435\u0442 \u0441\u0432\u043E\u0438 \u043B\u0438\u043C\u0438\u0442\u0435\u0440\u044B)\n      return req.path === '/api/graphql';\n    },\n    handler: (req, res) => {\n      const ip = req.ip || req.connection?.remoteAddress || 'unknown';\n      const userAgent = req.get('user-agent') || 'unknown';\n      logRateLimitExceeded(ip, req.path, userAgent);\n      res.status(429).json({\n        error: 'Too many requests',\n        message: 'Too many requests from this IP, please try again later.',\n      });\n    },\n  });\n  app.use('/api/', limiter);\n\n  // \u0411\u043E\u043B\u0435\u0435 \u0441\u0442\u0440\u043E\u0433\u0438\u0439 \u043B\u0438\u043C\u0438\u0442 \u0434\u043B\u044F OAuth endpoints (\u0438\u043D\u0438\u0446\u0438\u0430\u0446\u0438\u044F OAuth)\n  // \u041D\u041E: \u0438\u0441\u043A\u043B\u044E\u0447\u0430\u0435\u043C /api/auth/oauth/session, \u0442\u0430\u043A \u043A\u0430\u043A \u044D\u0442\u043E \u0447\u0430\u0441\u0442\u044C \u0443\u0441\u043F\u0435\u0448\u043D\u043E\u0433\u043E OAuth flow\n  const oauthLimiter = rateLimit({\n    windowMs: 15 * 60 * 1000,\n    max: 10, // \u0423\u0432\u0435\u043B\u0438\u0447\u0438\u0432\u0430\u0435\u043C \u043B\u0438\u043C\u0438\u0442 \u0434\u043B\u044F OAuth flow\n    message: 'Too many OAuth attempts, please try again later.',\n    skip: (req) => {\n      // \u041F\u0440\u043E\u043F\u0443\u0441\u043A\u0430\u0435\u043C /api/auth/oauth/session, \u0442\u0430\u043A \u043A\u0430\u043A \u044D\u0442\u043E \u0447\u0430\u0441\u0442\u044C \u0443\u0441\u043F\u0435\u0448\u043D\u043E\u0433\u043E OAuth callback\n      // \u0438 \u0434\u043E\u043B\u0436\u043D\u043E \u0431\u044B\u0442\u044C \u0440\u0430\u0437\u0440\u0435\u0448\u0435\u043D\u043E \u043F\u043E\u0441\u043B\u0435 \u0443\u0441\u043F\u0435\u0448\u043D\u043E\u0439 \u0430\u0432\u0442\u043E\u0440\u0438\u0437\u0430\u0446\u0438\u0438\n      return req.path === '/api/auth/oauth/session';\n    },\n    handler: (req, res) => {\n      const ip = req.ip || req.connection?.remoteAddress || 'unknown';\n      const userAgent = req.get('user-agent') || 'unknown';\n      logRateLimitExceeded(ip, req.path, userAgent);\n      res.status(429).json({\n        error: 'Too many OAuth attempts',\n        message: 'Too many OAuth attempts, please try again later.',\n      });\n    },\n  });\n  app.use('/api/auth/', oauthLimiter);\n  app.use('/api/connect/', oauthLimiter);\n\n  // Rate limiting \u0434\u043B\u044F GraphQL\n  // \u0420\u0430\u0437\u0434\u0435\u043B\u044F\u0435\u043C \u043B\u0438\u043C\u0438\u0442\u044B \u0434\u043B\u044F \u043F\u043E\u043F\u044B\u0442\u043E\u043A \u0432\u0445\u043E\u0434\u0430 \u0438 \u043E\u0431\u044B\u0447\u043D\u044B\u0445 \u0437\u0430\u043F\u0440\u043E\u0441\u043E\u0432\n  const graphqlLoginLimiter = rateLimit({\n    windowMs: 15 * 60 * 1000, // 15 \u043C\u0438\u043D\u0443\u0442\n    max: 10, // \u043C\u0430\u043A\u0441\u0438\u043C\u0443\u043C 10 \u043F\u043E\u043F\u044B\u0442\u043E\u043A \u0432\u0445\u043E\u0434\u0430 \u0441 \u043E\u0434\u043D\u043E\u0433\u043E IP\n    message: 'Too many login attempts, please try again later.',\n    skip: (req) => {\n      // \u041F\u0440\u043E\u043F\u0443\u0441\u043A\u0430\u0435\u043C, \u0435\u0441\u043B\u0438 \u044D\u0442\u043E \u043D\u0435 \u0437\u0430\u043F\u0440\u043E\u0441 \u043D\u0430 \u0430\u0443\u0442\u0435\u043D\u0442\u0438\u0444\u0438\u043A\u0430\u0446\u0438\u044E\n      if (req.method !== 'POST' || !req.body) return true;\n      const query = req.body.query || '';\n      return !query.includes('authenticateUserWithPassword');\n    },\n    handler: (req, res) => {\n      const ip = req.ip || req.connection?.remoteAddress || 'unknown';\n      const userAgent = req.get('user-agent') || 'unknown';\n      logRateLimitExceeded(ip, '/api/graphql (login)', userAgent);\n      res.status(429).json({\n        error: 'Too many login attempts',\n        message: 'Too many login attempts from this IP, please try again later.',\n      });\n    },\n  });\n\n  // \u0411\u043E\u043B\u0435\u0435 \u043C\u044F\u0433\u043A\u0438\u0439 \u043B\u0438\u043C\u0438\u0442 \u0434\u043B\u044F \u043E\u0441\u0442\u0430\u043B\u044C\u043D\u044B\u0445 GraphQL \u0437\u0430\u043F\u0440\u043E\u0441\u043E\u0432 (Admin UI \u0434\u0435\u043B\u0430\u0435\u0442 \u043C\u043D\u043E\u0433\u043E \u0437\u0430\u043F\u0440\u043E\u0441\u043E\u0432)\n  const graphqlLimiter = rateLimit({\n    windowMs: 15 * 60 * 1000, // 15 \u043C\u0438\u043D\u0443\u0442\n    max: 500, // \u043C\u0430\u043A\u0441\u0438\u043C\u0443\u043C 500 GraphQL \u0437\u0430\u043F\u0440\u043E\u0441\u043E\u0432 \u0441 \u043E\u0434\u043D\u043E\u0433\u043E IP (Admin UI \u043C\u043E\u0436\u0435\u0442 \u0434\u0435\u043B\u0430\u0442\u044C \u043C\u043D\u043E\u0433\u043E \u0437\u0430\u043F\u0440\u043E\u0441\u043E\u0432)\n    message: 'Too many GraphQL requests, please try again later.',\n    skip: (req) => {\n      // \u041F\u0440\u043E\u043F\u0443\u0441\u043A\u0430\u0435\u043C \u0437\u0430\u043F\u0440\u043E\u0441\u044B \u043D\u0430 \u0430\u0443\u0442\u0435\u043D\u0442\u0438\u0444\u0438\u043A\u0430\u0446\u0438\u044E (\u043E\u043D\u0438 \u043E\u0431\u0440\u0430\u0431\u0430\u0442\u044B\u0432\u0430\u044E\u0442\u0441\u044F \u043E\u0442\u0434\u0435\u043B\u044C\u043D\u044B\u043C \u043B\u0438\u043C\u0438\u0442\u0435\u0440\u043E\u043C)\n      if (req.method !== 'POST' || !req.body) return false;\n      const query = req.body.query || '';\n      return query.includes('authenticateUserWithPassword');\n    },\n    handler: (req, res) => {\n      const ip = req.ip || req.connection?.remoteAddress || 'unknown';\n      const userAgent = req.get('user-agent') || 'unknown';\n      logRateLimitExceeded(ip, '/api/graphql', userAgent);\n      res.status(429).json({\n        error: 'Too many GraphQL requests',\n        message: 'Too many requests from this IP, please try again later.',\n      });\n    },\n  });\n\n  // \u041F\u0440\u0438\u043C\u0435\u043D\u044F\u0435\u043C \u043E\u0431\u0430 \u043B\u0438\u043C\u0438\u0442\u0435\u0440\u0430 \u043A GraphQL endpoint\n  app.use('/api/graphql', graphqlLoginLimiter);\n  app.use('/api/graphql', graphqlLimiter);\n  \n  // Middleware \u0434\u043B\u044F \u043B\u043E\u0433\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u044F cookie \u0432 GraphQL \u0437\u0430\u043F\u0440\u043E\u0441\u0430\u0445 (\u0442\u043E\u043B\u044C\u043A\u043E \u0432 development)\n  if (process.env.NODE_ENV === 'development') {\n    app.use('/api/graphql', (req, res, next) => {\n      const cookies = req.headers.cookie || '';\n      const keystoneCookie = cookies.split(';').find(c => c.trim().startsWith('keystonejs-session='));\n      if (keystoneCookie) {\n        const token = keystoneCookie.split('=')[1];\n        logger.debug(`GraphQL request with keystonejs-session cookie: ${token.substring(0, 30)}...`);\n        \n        // \u041F\u044B\u0442\u0430\u0435\u043C\u0441\u044F \u0434\u0435\u043A\u043E\u0434\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0442\u043E\u043A\u0435\u043D \u0434\u043B\u044F \u043F\u0440\u043E\u0432\u0435\u0440\u043A\u0438\n        try {\n          const jwt = require('jsonwebtoken');\n          const decoded = jwt.decode(token, { complete: false });\n          if (decoded) {\n            logger.debug('Decoded JWT payload:', JSON.stringify(decoded, null, 2));\n          }\n        } catch (error) {\n          logger.debug('Failed to decode JWT token:', error);\n        }\n      } else {\n        logger.debug('GraphQL request WITHOUT keystonejs-session cookie');\n      }\n      next();\n    });\n  }\n\n  // 6. Session store \u0441 Redis\n  const redisClient = await getRedisClientWithFallback();\n  const sessionStore = redisClient\n    ? new RedisStore({ client: redisClient, prefix: 'session:' })\n    : new expressSession.MemoryStore();\n\n  app.use(\n    expressSession({\n      store: sessionStore,\n      secret: process.env.SESSION_SECRET || 'change-me-in-production',\n      resave: false,\n      saveUninitialized: false,\n      cookie: {\n        secure: process.env.NODE_ENV === 'production',\n        httpOnly: true,\n        sameSite: 'lax',\n        maxAge: 7 * 24 * 60 * 60 * 1000, // 7 \u0434\u043D\u0435\u0439\n      },\n    })\n  );\n\n  // 7. Passport.js initialization\n  app.use(passport.initialize());\n  app.use(passport.session());\n\n  // 8. OAuth2 routes\n  // CSRF \u0437\u0430\u0449\u0438\u0442\u0430: \u0433\u0435\u043D\u0435\u0440\u0438\u0440\u0443\u0435\u043C state \u043F\u0430\u0440\u0430\u043C\u0435\u0442\u0440 \u0438 \u0441\u043E\u0445\u0440\u0430\u043D\u044F\u0435\u043C \u0432 session\n  app.get('/api/connect/google', async (req, res, next) => {\n    try {\n      // \u0413\u0435\u043D\u0435\u0440\u0438\u0440\u0443\u0435\u043C \u043A\u0440\u0438\u043F\u0442\u043E\u0433\u0440\u0430\u0444\u0438\u0447\u0435\u0441\u043A\u0438 \u0441\u0442\u043E\u0439\u043A\u0438\u0439 state \u0442\u043E\u043A\u0435\u043D \u0434\u043B\u044F CSRF \u0437\u0430\u0449\u0438\u0442\u044B\n      const crypto = require('crypto');\n      const state = crypto.randomBytes(32).toString('hex');\n      \n      // \u0421\u043E\u0445\u0440\u0430\u043D\u044F\u0435\u043C state \u0432 session \u0434\u043B\u044F \u043F\u0440\u043E\u0432\u0435\u0440\u043A\u0438 \u0432 callback\n      (req.session as any).oauthState = state;\n      \n      // \u0412\u0410\u0416\u041D\u041E: \u042F\u0432\u043D\u043E \u0441\u043E\u0445\u0440\u0430\u043D\u044F\u0435\u043C session \u043F\u0435\u0440\u0435\u0434 \u0440\u0435\u0434\u0438\u0440\u0435\u043A\u0442\u043E\u043C \u043D\u0430 Google\n      // \u042D\u0442\u043E \u0433\u0430\u0440\u0430\u043D\u0442\u0438\u0440\u0443\u0435\u0442, \u0447\u0442\u043E state \u0431\u0443\u0434\u0435\u0442 \u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D \u0432 callback\n      await new Promise<void>((resolve, reject) => {\n        (req.session as any).save((err: any) => {\n          if (err) {\n            logger.error('Failed to save session with oauthState:', err);\n            reject(err);\n          } else {\n            logger.debug('Session saved with oauthState:', state.substring(0, 20) + '...');\n            resolve();\n          }\n        });\n      });\n      \n      // \u041F\u0435\u0440\u0435\u0434\u0430\u0435\u043C state \u0432 Passport.js \u0434\u043B\u044F \u043E\u0442\u043F\u0440\u0430\u0432\u043A\u0438 \u0432 Google\n      passport.authenticate('google', {\n        scope: ['profile', 'email'],\n        state: state, // Google \u0432\u0435\u0440\u043D\u0435\u0442 \u044D\u0442\u043E\u0442 state \u0432 callback\n      })(req, res, next);\n    } catch (error) {\n      logger.error('OAuth initiation error:', error);\n      const frontendUrl = process.env.FRONTEND_URL || 'http://localhost:5173';\n      res.redirect(`${frontendUrl}/auth/callback?error=oauth_init_failed`);\n    }\n  });\n  \n  app.get(\n    '/api/connect/google/callback',\n    // CSRF \u0437\u0430\u0449\u0438\u0442\u0430: \u043F\u0440\u043E\u0432\u0435\u0440\u044F\u0435\u043C state \u043F\u0430\u0440\u0430\u043C\u0435\u0442\u0440 \u0414\u041E \u0432\u044B\u0437\u043E\u0432\u0430 passport.authenticate()\n    // Passport.js \u043C\u043E\u0436\u0435\u0442 \u0443\u0434\u0430\u043B\u0438\u0442\u044C state \u0438\u0437 query string \u043F\u043E\u0441\u043B\u0435 \u043E\u0431\u0440\u0430\u0431\u043E\u0442\u043A\u0438\n    (req, res, next) => {\n      const receivedState = req.query.state as string;\n      const savedState = (req.session as any)?.oauthState;\n      \n      logger.debug('OAuth callback state check:', {\n        received: receivedState?.substring(0, 20) + '...',\n        saved: savedState?.substring(0, 20) + '...',\n        sessionId: (req.session as any)?.id,\n        hasSession: !!req.session,\n      });\n      \n      if (!receivedState || !savedState || receivedState !== savedState) {\n        logger.error('OAuth callback: CSRF protection failed - invalid state parameter', {\n          received: receivedState,\n          saved: savedState,\n          ip: req.ip,\n          sessionId: (req.session as any)?.id,\n          hasSession: !!req.session,\n        });\n        const frontendUrl = process.env.FRONTEND_URL || 'http://localhost:5173';\n        return res.redirect(`${frontendUrl}/auth/callback?error=csrf_protection_failed`);\n      }\n      \n      // \u0423\u0434\u0430\u043B\u044F\u0435\u043C \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u043D\u043D\u044B\u0439 state \u0438\u0437 session \u043F\u0435\u0440\u0435\u0434 \u0432\u044B\u0437\u043E\u0432\u043E\u043C passport.authenticate\n      delete (req.session as any).oauthState;\n      \n      // \u041F\u0440\u043E\u0434\u043E\u043B\u0436\u0430\u0435\u043C \u043E\u0431\u0440\u0430\u0431\u043E\u0442\u043A\u0443 OAuth callback\n      next();\n    },\n    passport.authenticate('google', { failureRedirect: '/login?error=oauth_failed' }),\n    async (req, res) => {\n      try {\n        \n        // \u0418\u0441\u043F\u043E\u043B\u044C\u0437\u0443\u0435\u043C \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043D\u044B\u0439 context \u0438\u043B\u0438 \u043F\u0435\u0440\u0435\u0434\u0430\u043D\u043D\u044B\u0439 \u043F\u0430\u0440\u0430\u043C\u0435\u0442\u0440\n        const ctx = context || keystoneContext;\n        if (!ctx) {\n          logger.error('KeystoneJS context not available for OAuth callback');\n          const frontendUrl = process.env.FRONTEND_URL || 'http://localhost:5173';\n          return res.redirect(`${frontendUrl}/auth/callback?error=server_error`);\n        }\n\n        const user = req.user as any;\n        if (!user || !user.email) {\n          logger.error('OAuth callback: Invalid user data');\n          const frontendUrl = process.env.FRONTEND_URL || 'http://localhost:5173';\n          return res.redirect(`${frontendUrl}/auth/callback?error=invalid_user`);\n        }\n\n        // \u041D\u0430\u0445\u043E\u0434\u0438\u043C \u0438\u043B\u0438 \u0441\u043E\u0437\u0434\u0430\u0435\u043C \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044F \u0432 KeystoneJS\n        const keystoneUser = await findOrCreateGoogleUser(ctx, user);\n        if (!keystoneUser) {\n          logger.error('OAuth callback: Failed to create/find user');\n          const frontendUrl = process.env.FRONTEND_URL || 'http://localhost:5173';\n          return res.redirect(`${frontendUrl}/auth/callback?error=user_creation_failed`);\n        }\n\n        // \u0421\u043E\u0445\u0440\u0430\u043D\u044F\u0435\u043C userId \u0432 Express session \u0434\u043B\u044F \u043F\u043E\u0441\u043B\u0435\u0434\u0443\u044E\u0449\u0435\u0433\u043E \u0441\u043E\u0437\u0434\u0430\u043D\u0438\u044F KeystoneJS session\n        (req.session as any).oauthUserId = keystoneUser.id;\n        (req.session as any).oauthEmail = keystoneUser.email;\n        \n        // \u0420\u0435\u0434\u0438\u0440\u0435\u043A\u0442\u0438\u043C \u043D\u0430 frontend, \u043A\u043E\u0442\u043E\u0440\u044B\u0439 \u0432\u044B\u0437\u043E\u0432\u0435\u0442 GraphQL mutation \u0434\u043B\u044F \u0441\u043E\u0437\u0434\u0430\u043D\u0438\u044F session\n        const frontendUrl = process.env.FRONTEND_URL || 'http://localhost:5173';\n        res.redirect(`${frontendUrl}/auth/callback?oauth=success&userId=${keystoneUser.id}`);\n      } catch (error) {\n        logger.error('OAuth callback error:', error);\n        const frontendUrl = process.env.FRONTEND_URL || 'http://localhost:5173';\n        res.redirect(`${frontendUrl}/auth/callback?error=server_error`);\n      }\n    }\n  );\n\n  // 9. Initial setup endpoint - \u0441\u043E\u0437\u0434\u0430\u043D\u0438\u0435 \u043F\u0435\u0440\u0432\u043E\u0433\u043E \u0430\u0434\u043C\u0438\u043D\u0438\u0441\u0442\u0440\u0430\u0442\u043E\u0440\u0430\n  // \u0417\u0410\u0429\u0418\u0422\u0410 \u041E\u0422 RACE CONDITIONS: \u0418\u0441\u043F\u043E\u043B\u044C\u0437\u0443\u0435\u043C Prisma \u0442\u0440\u0430\u043D\u0437\u0430\u043A\u0446\u0438\u044E \u0434\u043B\u044F \u0430\u0442\u043E\u043C\u0430\u0440\u043D\u043E\u0439 \u043E\u043F\u0435\u0440\u0430\u0446\u0438\u0438\n  // \u0412\u0410\u041B\u0418\u0414\u0410\u0426\u0418\u042F: \u0418\u0441\u043F\u043E\u043B\u044C\u0437\u0443\u0435\u043C Zod \u0434\u043B\u044F \u0432\u0430\u043B\u0438\u0434\u0430\u0446\u0438\u0438 \u0432\u0445\u043E\u0434\u043D\u044B\u0445 \u0434\u0430\u043D\u043D\u044B\u0445\n  app.post('/api/setup/initial', async (req, res) => {\n    try {\n      const ctx = context || keystoneContext;\n      if (!ctx) {\n        return res.status(500).json({ error: 'KeystoneJS context not available' });\n      }\n\n      // \u0412\u0430\u043B\u0438\u0434\u0430\u0446\u0438\u044F \u0432\u0445\u043E\u0434\u043D\u044B\u0445 \u0434\u0430\u043D\u043D\u044B\u0445 \u0447\u0435\u0440\u0435\u0437 Zod (\u043A\u0430\u043A \u0442\u0440\u0435\u0431\u0443\u0435\u0442 text.text)\n      const { z } = await import('zod');\n      const setupSchema = z.object({\n        email: z.string().email('Invalid email format').min(5).max(255),\n        password: z.string().min(8, 'Password must be at least 8 characters').max(128),\n        username: z.string().min(3, 'Username must be at least 3 characters').max(30).regex(/^[a-zA-Z0-9_-]+$/, 'Username can only contain letters, numbers, underscores and hyphens'),\n        name: z.string().min(1, 'Name is required').max(100),\n      });\n\n      const validationResult = setupSchema.safeParse(req.body);\n      \n      if (!validationResult.success) {\n        const errors = validationResult.error.errors.map(err => ({\n          field: err.path.join('.'),\n          message: err.message,\n        }));\n        return res.status(400).json({ \n          error: 'Validation failed',\n          details: errors,\n        });\n      }\n\n      const { email, password, username, name } = validationResult.data;\n\n      // \u0418\u0421\u041F\u041E\u041B\u042C\u0417\u0423\u0415\u041C PRISMA \u0422\u0420\u0410\u041D\u0417\u0410\u041A\u0426\u0418\u042E \u0434\u043B\u044F \u0437\u0430\u0449\u0438\u0442\u044B \u043E\u0442 race conditions\n      // \u0412 SQLite \u0442\u0440\u0430\u043D\u0437\u0430\u043A\u0446\u0438\u044F \u0431\u043B\u043E\u043A\u0438\u0440\u0443\u0435\u0442 \u0431\u0430\u0437\u0443, \u043F\u0440\u0435\u0434\u043E\u0442\u0432\u0440\u0430\u0449\u0430\u044F \u043E\u0434\u043D\u043E\u0432\u0440\u0435\u043C\u0435\u043D\u043D\u043E\u0435 \u0441\u043E\u0437\u0434\u0430\u043D\u0438\u0435 \u043D\u0435\u0441\u043A\u043E\u043B\u044C\u043A\u0438\u0445 \u0430\u0434\u043C\u0438\u043D\u043E\u0432\n      const { PrismaClient } = await import('@prisma/client');\n      const prisma = new PrismaClient();\n\n      try {\n        // \u0410\u0442\u043E\u043C\u0430\u0440\u043D\u0430\u044F \u0442\u0440\u0430\u043D\u0437\u0430\u043A\u0446\u0438\u044F: \u043F\u0440\u043E\u0432\u0435\u0440\u043A\u0430 + \u0441\u043E\u0437\u0434\u0430\u043D\u0438\u0435\n        // \u0417\u0410\u0429\u0418\u0422\u0410 \u041E\u0422 RACE CONDITIONS: \u0442\u0440\u0430\u043D\u0437\u0430\u043A\u0446\u0438\u044F \u0431\u043B\u043E\u043A\u0438\u0440\u0443\u0435\u0442 \u0431\u0430\u0437\u0443, \u043F\u0440\u0435\u0434\u043E\u0442\u0432\u0440\u0430\u0449\u0430\u044F \u043E\u0434\u043D\u043E\u0432\u0440\u0435\u043C\u0435\u043D\u043D\u043E\u0435 \u0441\u043E\u0437\u0434\u0430\u043D\u0438\u0435\n        const admin = await prisma.$transaction(async (tx) => {\n          // \u041F\u0440\u043E\u0432\u0435\u0440\u044F\u0435\u043C, \u0435\u0441\u0442\u044C \u043B\u0438 \u0443\u0436\u0435 \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u0438 (\u0432\u043D\u0443\u0442\u0440\u0438 \u0442\u0440\u0430\u043D\u0437\u0430\u043A\u0446\u0438\u0438)\n          const existingUsers = await tx.user.findMany({ take: 1 });\n          \n          if (existingUsers.length > 0) {\n            throw new Error('Initial setup already completed. Users exist in database.');\n          }\n\n          // \u0425\u0435\u0448\u0438\u0440\u0443\u0435\u043C \u043F\u0430\u0440\u043E\u043B\u044C (KeystoneJS \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u0443\u0435\u0442 bcrypt)\n          const bcrypt = await import('bcryptjs');\n          const hashedPassword = await bcrypt.hash(password, 10);\n\n          // \u0421\u043E\u0437\u0434\u0430\u0435\u043C \u043F\u0435\u0440\u0432\u043E\u0433\u043E \u0430\u0434\u043C\u0438\u043D\u0438\u0441\u0442\u0440\u0430\u0442\u043E\u0440\u0430 (\u0432\u043D\u0443\u0442\u0440\u0438 \u0442\u0440\u0430\u043D\u0437\u0430\u043A\u0446\u0438\u0438)\n          // \u0412\u0410\u0416\u041D\u041E: \u0420\u043E\u043B\u044C 'admin' \u0443\u0441\u0442\u0430\u043D\u0430\u0432\u043B\u0438\u0432\u0430\u0435\u0442\u0441\u044F \u042F\u0412\u041D\u041E, \u0430 \u043D\u0435 \u0447\u0435\u0440\u0435\u0437 hook\n          const newAdmin = await tx.user.create({\n            data: {\n              email,\n              password: hashedPassword,\n              username,\n              name,\n              role: 'admin', // \u042F\u0432\u043D\u043E \u0443\u0441\u0442\u0430\u043D\u0430\u0432\u043B\u0438\u0432\u0430\u0435\u043C \u0440\u043E\u043B\u044C 'admin' (\u0431\u0435\u0437\u043E\u043F\u0430\u0441\u043D\u043E, \u0442.\u043A. \u0432\u043D\u0443\u0442\u0440\u0438 \u0442\u0440\u0430\u043D\u0437\u0430\u043A\u0446\u0438\u0438)\n              provider: 'local',\n              confirmed: true,\n              blocked: false,\n            },\n          });\n\n          return newAdmin;\n        }, {\n          isolationLevel: 'Serializable', // \u041C\u0430\u043A\u0441\u0438\u043C\u0430\u043B\u044C\u043D\u0430\u044F \u0438\u0437\u043E\u043B\u044F\u0446\u0438\u044F \u0434\u043B\u044F SQLite (\u0431\u043B\u043E\u043A\u0438\u0440\u0443\u0435\u0442 \u043A\u043E\u043D\u043A\u0443\u0440\u0435\u043D\u0442\u043D\u044B\u0435 \u0437\u0430\u043F\u0440\u043E\u0441\u044B)\n        });\n\n        logger.info(`\u2705 First admin created via initial setup endpoint: ${admin.email}`);\n\n        res.json({\n          success: true,\n          message: 'First admin created successfully',\n          user: {\n            id: admin.id,\n            email: admin.email,\n            username: admin.username,\n            name: admin.name,\n            role: admin.role,\n          },\n        });\n      } finally {\n        await prisma.$disconnect();\n      }\n    } catch (error: any) {\n      logger.error('Initial setup error:', error);\n      \n      // \u0415\u0441\u043B\u0438 \u043E\u0448\u0438\u0431\u043A\u0430 \u0441\u0432\u044F\u0437\u0430\u043D\u0430 \u0441 \u0442\u0435\u043C, \u0447\u0442\u043E \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u0438 \u0443\u0436\u0435 \u0441\u0443\u0449\u0435\u0441\u0442\u0432\u0443\u044E\u0442\n      if (error.message?.includes('already completed')) {\n        return res.status(400).json({ \n          error: 'Initial setup already completed',\n          message: error.message \n        });\n      }\n\n      res.status(500).json({ \n        error: 'Failed to create first admin',\n        message: error.message \n      });\n    }\n  });\n\n  // 10. OAuth session creation endpoint\n  // Frontend \u0432\u044B\u0437\u044B\u0432\u0430\u0435\u0442 \u044D\u0442\u043E\u0442 endpoint \u043F\u043E\u0441\u043B\u0435 OAuth callback \u0434\u043B\u044F \u0441\u043E\u0437\u0434\u0430\u043D\u0438\u044F KeystoneJS session\n  // \u0412\u0410\u0416\u041D\u041E: \u042D\u0442\u043E\u0442 endpoint \u0441\u043E\u0437\u0434\u0430\u0435\u0442 KeystoneJS session \u0434\u043B\u044F OAuth \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u0435\u0439\n  app.post('/api/auth/oauth/session', async (req, res) => {\n    try {\n      const ctx = context || keystoneContext;\n      if (!ctx) {\n        return res.status(500).json({ error: 'KeystoneJS context not available' });\n      }\n\n      const oauthUserId = (req.session as any)?.oauthUserId;\n      if (!oauthUserId) {\n        return res.status(400).json({ error: 'OAuth session not found' });\n      }\n\n      // \u041F\u043E\u043B\u0443\u0447\u0430\u0435\u043C \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044F\n      const user = await ctx.query.User.findOne({\n        where: { id: oauthUserId },\n        query: 'id email username role',\n      });\n\n      if (!user) {\n        return res.status(404).json({ error: 'User not found' });\n      }\n\n      // \u0421\u043E\u0437\u0434\u0430\u0435\u043C KeystoneJS session \u0434\u043B\u044F OAuth \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044F\n      // \u0418\u0441\u043F\u043E\u043B\u044C\u0437\u0443\u0435\u043C \u0432\u0441\u0442\u0440\u043E\u0435\u043D\u043D\u044B\u0439 \u043C\u0435\u0445\u0430\u043D\u0438\u0437\u043C KeystoneJS sessionStrategy.start()\n      // \u0432\u043C\u0435\u0441\u0442\u043E \u0440\u0443\u0447\u043D\u043E\u0433\u043E \u0441\u043E\u0437\u0434\u0430\u043D\u0438\u044F Iron \u0442\u043E\u043A\u0435\u043D\u0430\n      const userId = String(user.id);\n      const sessionData = {\n        id: userId,\n        email: user.email,\n        username: user.username,\n        role: user.role || 'user',\n      };\n      \n      try {\n        // \u0421\u043E\u0437\u0434\u0430\u0435\u043C \u043A\u043E\u043D\u0442\u0435\u043A\u0441\u0442 \u0441 Express response \u0434\u043B\u044F sessionStrategy\n        // sessionStrategy.start() \u0442\u0440\u0435\u0431\u0443\u0435\u0442 context.res \u0434\u043B\u044F \u0443\u0441\u0442\u0430\u043D\u043E\u0432\u043A\u0438 cookie\n        const sessionContext = {\n          ...ctx,\n          res: res, // Express response \u043E\u0431\u044A\u0435\u043A\u0442\n        } as any;\n        \n        // \u0418\u0441\u043F\u043E\u043B\u044C\u0437\u0443\u0435\u043C \u0432\u0441\u0442\u0440\u043E\u0435\u043D\u043D\u044B\u0439 \u043C\u0435\u0445\u0430\u043D\u0438\u0437\u043C KeystoneJS \u0434\u043B\u044F \u0441\u043E\u0437\u0434\u0430\u043D\u0438\u044F session\n        // \u042D\u0442\u043E \u0433\u0430\u0440\u0430\u043D\u0442\u0438\u0440\u0443\u0435\u0442 \u0441\u043E\u0432\u043C\u0435\u0441\u0442\u0438\u043C\u043E\u0441\u0442\u044C \u0441 \u043D\u0430\u0441\u0442\u0440\u043E\u0439\u043A\u0430\u043C\u0438 session \u0438\u0437 auth.ts\n        const sessionToken = await ctx.sessionStrategy.start({\n          context: sessionContext,\n          data: {\n            itemId: userId,\n            listKey: 'User',\n            data: sessionData,\n          },\n        });\n        \n        if (!sessionToken) {\n          logger.error('Session token is null or undefined after creation');\n          return res.status(500).json({ error: 'Failed to create session token' });\n        }\n        \n        logger.debug(`Session token created for user ${user.id}, token length: ${sessionToken.length}`);\n      } catch (error: any) {\n        logger.error('Error creating session token via sessionStrategy:', error);\n        logger.error('Error stack:', error.stack);\n        return res.status(500).json({ error: 'Failed to create session token', details: error.message });\n      }\n\n      logger.info(`\u2705 OAuth session created for user: ${user.email}`);\n\n      res.json({\n        success: true,\n        user: {\n          id: user.id,\n          email: user.email,\n          username: user.username,\n          role: user.role,\n        },\n      });\n\n      // \u041E\u0447\u0438\u0449\u0430\u0435\u043C \u0432\u0440\u0435\u043C\u0435\u043D\u043D\u044B\u0435 \u0434\u0430\u043D\u043D\u044B\u0435 \u0438\u0437 Express session\n      delete (req.session as any).oauthUserId;\n      delete (req.session as any).oauthEmail;\n    } catch (error) {\n      logger.error('OAuth session creation error:', error);\n      res.status(500).json({ error: 'Failed to create session' });\n    }\n  });\n\n  // 11. Image upload endpoint\n  // \u0417\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0439 \u0447\u0435\u0440\u0435\u0437 ImgBB API\n  // \u0412\u0410\u0416\u041D\u041E: multer \u0443\u0436\u0435 \u043D\u0430\u0441\u0442\u0440\u043E\u0435\u043D \u0432\u044B\u0448\u0435\n  app.post('/api/upload/image', upload.single('files'), async (req, res) => {\n    try {\n      logger.debug('Image upload request received:', {\n        method: req.method,\n        path: req.path,\n        hasFile: !!req.file,\n        cookies: req.headers.cookie ? 'present' : 'missing',\n        contentType: req.headers['content-type'],\n      });\n\n      // \u041F\u0440\u043E\u0432\u0435\u0440\u044F\u0435\u043C \u0430\u0443\u0442\u0435\u043D\u0442\u0438\u0444\u0438\u043A\u0430\u0446\u0438\u044E \u0447\u0435\u0440\u0435\u0437 KeystoneJS session\n      const ctx = context || keystoneContext;\n      if (!ctx) {\n        logger.error('KeystoneJS context not available for image upload', {\n          hasContext: !!context,\n          hasKeystoneContext: !!keystoneContext,\n        });\n        return res.status(500).json({ error: 'KeystoneJS context not available' });\n      }\n\n      if (!ctx.sessionStrategy) {\n        logger.error('KeystoneJS sessionStrategy not available', {\n          hasContext: !!ctx,\n          contextKeys: Object.keys(ctx || {}),\n        });\n        return res.status(500).json({ error: 'Session strategy not available' });\n      }\n      \n      logger.debug('KeystoneJS context available for image upload', {\n        hasSessionStrategy: !!ctx.sessionStrategy,\n        sessionStrategyType: typeof ctx.sessionStrategy,\n      });\n\n      // \u0421\u043E\u0437\u0434\u0430\u0435\u043C \u043A\u043E\u043D\u0442\u0435\u043A\u0441\u0442 \u0441 Express request \u0438 response \u0434\u043B\u044F sessionStrategy\n      // sessionStrategy.get() \u0442\u0440\u0435\u0431\u0443\u0435\u0442 context.req \u0434\u043B\u044F \u0447\u0442\u0435\u043D\u0438\u044F cookies\n      const sessionContext = {\n        ...ctx,\n        req: req,\n        res: res,\n      } as any;\n\n      // \u041F\u043E\u043B\u0443\u0447\u0430\u0435\u043C session \u0447\u0435\u0440\u0435\u0437 sessionStrategy\n      let sessionData;\n      try {\n        sessionData = await ctx.sessionStrategy.get({ context: sessionContext });\n        logger.debug('Image upload session check:', {\n          hasSession: !!sessionData,\n          itemId: sessionData?.itemId,\n          cookies: req.headers.cookie ? 'present' : 'missing',\n        });\n      } catch (sessionError: any) {\n        logger.error('Session check failed for image upload:', {\n          error: sessionError?.message,\n          stack: sessionError?.stack,\n          name: sessionError?.name,\n          cookies: req.headers.cookie ? 'present' : 'missing',\n        });\n        // \u0415\u0441\u043B\u0438 \u043E\u0448\u0438\u0431\u043A\u0430 \u043F\u0440\u0438 \u043F\u043E\u043B\u0443\u0447\u0435\u043D\u0438\u0438 \u0441\u0435\u0441\u0441\u0438\u0438, \u0432\u043E\u0437\u0432\u0440\u0430\u0449\u0430\u0435\u043C 401\n        return res.status(401).json({ \n          error: 'Authentication required',\n          details: process.env.NODE_ENV === 'development' ? sessionError?.message : undefined,\n        });\n      }\n\n      // \u041F\u0440\u043E\u0432\u0435\u0440\u044F\u0435\u043C, \u0447\u0442\u043E \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044C \u0430\u0443\u0442\u0435\u043D\u0442\u0438\u0444\u0438\u0446\u0438\u0440\u043E\u0432\u0430\u043D\n      if (!sessionData?.itemId) {\n        logger.warn('Image upload attempted without authentication', {\n          hasSession: !!sessionData,\n          cookies: req.headers.cookie ? 'present' : 'missing',\n        });\n        return res.status(401).json({ error: 'Authentication required' });\n      }\n      \n      logger.debug('Image upload request from authenticated user:', {\n        userId: sessionData.itemId,\n      });\n\n      if (!req.file) {\n        return res.status(400).json({ error: 'No file provided' });\n      }\n\n      const file = req.file;\n      \n      logger.debug('Image upload request:', {\n        filename: file.originalname,\n        mimetype: file.mimetype,\n        size: file.size,\n      });\n\n      // \u0412\u0430\u043B\u0438\u0434\u0430\u0446\u0438\u044F \u0440\u0430\u0437\u043C\u0435\u0440\u0430 \u0444\u0430\u0439\u043B\u0430\n      const maxFileSize = 8 * 1024 * 1024; // 8MB\n      if (file.size > maxFileSize) {\n        return res.status(400).json({ \n          error: `File size exceeds maximum allowed size of ${maxFileSize / 1024 / 1024}MB` \n        });\n      }\n\n      // \u041F\u043E\u043B\u0443\u0447\u0430\u0435\u043C API \u043A\u043B\u044E\u0447 ImgBB \u0438\u0437 \u043F\u0435\u0440\u0435\u043C\u0435\u043D\u043D\u044B\u0445 \u043E\u043A\u0440\u0443\u0436\u0435\u043D\u0438\u044F\n      const imgbbApiKey = process.env.IMGBB_API_KEY;\n      \n      if (!imgbbApiKey) {\n        logger.error('IMGBB_API_KEY not configured in environment variables');\n        // Fallback: \u0432\u043E\u0437\u0432\u0440\u0430\u0449\u0430\u0435\u043C \u0432\u0440\u0435\u043C\u0435\u043D\u043D\u044B\u0439 URL (\u0432 production \u043D\u0443\u0436\u043D\u043E \u043D\u0430\u0441\u0442\u0440\u043E\u0438\u0442\u044C ImgBB)\n        const publicUrl = process.env.PUBLIC_URL || 'http://localhost:1337';\n        const tempUrl = `${publicUrl}/uploads/${Date.now()}-${file.originalname}`;\n        \n        logger.warn('\u26A0\uFE0F ImgBB not configured, using temporary URL (not persisted)');\n        return res.json([{\n          id: Date.now().toString(),\n          url: tempUrl,\n          display_url: tempUrl,\n          delete_url: null,\n          size: file.size,\n          width: null,\n          height: null,\n          mime: file.mimetype,\n          name: file.originalname,\n        }]);\n      }\n\n      // \u041A\u043E\u043D\u0432\u0435\u0440\u0442\u0438\u0440\u0443\u0435\u043C \u0444\u0430\u0439\u043B \u0432 base64 \u0434\u043B\u044F ImgBB API\n      const base64Image = file.buffer.toString('base64');\n\n      // \u0417\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u043C \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435 \u0447\u0435\u0440\u0435\u0437 ImgBB API\n      const formData = new URLSearchParams();\n      formData.append('key', imgbbApiKey);\n      formData.append('image', base64Image);\n      \n      if (file.originalname) {\n        formData.append('name', file.originalname);\n      }\n\n      // \u041E\u0442\u043F\u0440\u0430\u0432\u043B\u044F\u0435\u043C \u0437\u0430\u043F\u0440\u043E\u0441 \u043A ImgBB API\n      const https = await import('https');\n      const timeoutMs = 30000; // 30 \u0441\u0435\u043A\u0443\u043D\u0434 \u0442\u0430\u0439\u043C\u0430\u0443\u0442\n      \n      try {\n        const imgbbResponse = await new Promise<{ statusCode: number; data: any }>((resolve, reject) => {\n          const requestBody = formData.toString();\n          let timeout: NodeJS.Timeout;\n          \n          timeout = setTimeout(() => {\n            reject(new Error('Request timeout'));\n          }, timeoutMs);\n          \n          const req = https.request(\n            {\n              hostname: 'api.imgbb.com',\n              path: '/1/upload',\n              method: 'POST',\n              headers: {\n                'Content-Type': 'application/x-www-form-urlencoded',\n                'Content-Length': Buffer.byteLength(requestBody),\n              },\n            },\n            (res) => {\n              let data = '';\n              \n              res.on('data', (chunk) => {\n                data += chunk;\n              });\n              \n              res.on('end', () => {\n                clearTimeout(timeout);\n                try {\n                  const jsonData = JSON.parse(data);\n                  resolve({\n                    statusCode: res.statusCode || 500,\n                    data: jsonData,\n                  });\n                } catch (parseError) {\n                  reject(new Error(`Failed to parse response: ${parseError}`));\n                }\n              });\n            }\n          );\n          \n          req.on('error', (error) => {\n            clearTimeout(timeout);\n            reject(error);\n          });\n          \n          req.on('timeout', () => {\n            req.destroy();\n            clearTimeout(timeout);\n            reject(new Error('Request timeout'));\n          });\n          \n          req.write(requestBody);\n          req.end();\n        });\n\n        if (imgbbResponse.statusCode < 200 || imgbbResponse.statusCode >= 300) {\n          const errorText = typeof imgbbResponse.data === 'string' \n            ? imgbbResponse.data \n            : JSON.stringify(imgbbResponse.data);\n          logger.error('ImgBB API error:', {\n            status: imgbbResponse.statusCode,\n            error: errorText,\n          });\n          return res.status(imgbbResponse.statusCode).json({ \n            error: 'Image upload failed',\n            details: process.env.NODE_ENV === 'development' ? errorText : undefined,\n          });\n        }\n\n        const imgbbData = imgbbResponse.data as {\n          success?: boolean;\n          data?: {\n            id?: string;\n            url?: string;\n            display_url?: string;\n            delete_url?: string;\n            size?: number;\n            width?: number;\n            height?: number;\n          };\n          error?: {\n            message?: string;\n            code?: number;\n          };\n        };\n\n        if (!imgbbData.success || !imgbbData.data) {\n          const errorMessage = imgbbData.error?.message || 'Unknown error';\n          logger.error('ImgBB upload failed:', errorMessage);\n          return res.status(400).json({ \n            error: 'Image upload failed',\n            details: process.env.NODE_ENV === 'development' ? errorMessage : undefined,\n          });\n        }\n\n        logger.info('\u2705 Image uploaded successfully to ImgBB:', {\n          url: imgbbData.data.url,\n          size: imgbbData.data.size,\n        });\n\n        // \u0412\u043E\u0437\u0432\u0440\u0430\u0449\u0430\u0435\u043C \u0434\u0430\u043D\u043D\u044B\u0435 \u0432 \u0444\u043E\u0440\u043C\u0430\u0442\u0435, \u0441\u043E\u0432\u043C\u0435\u0441\u0442\u0438\u043C\u043E\u043C \u0441 \u0444\u0440\u043E\u043D\u0442\u0435\u043D\u0434\u043E\u043C\n        res.json([{\n          id: imgbbData.data.id || Date.now().toString(),\n          url: imgbbData.data.url || imgbbData.data.display_url,\n          display_url: imgbbData.data.display_url,\n          delete_url: imgbbData.data.delete_url,\n          size: imgbbData.data.size || file.size,\n          width: imgbbData.data.width,\n          height: imgbbData.data.height,\n          mime: file.mimetype,\n          name: file.originalname,\n        }]);\n      } catch (uploadError: any) {\n        logger.error('Failed to upload image to ImgBB:', {\n          error: uploadError.message,\n          code: uploadError.code,\n          stack: uploadError.stack,\n        });\n        \n        // \u0412 development \u043F\u043E\u043A\u0430\u0437\u044B\u0432\u0430\u0435\u043C \u0434\u0435\u0442\u0430\u043B\u0438 \u043E\u0448\u0438\u0431\u043A\u0438\n        if (process.env.NODE_ENV === 'development') {\n          return res.status(500).json({ \n            error: 'Image upload failed',\n            details: uploadError.message || 'Unknown error',\n            code: uploadError.code,\n          });\n        }\n        \n        return res.status(500).json({ error: 'Image upload failed. Please try again.' });\n      }\n    } catch (error: any) {\n      logger.error('Image upload endpoint error:', {\n        error: error.message,\n        stack: error.stack,\n        name: error.name,\n        code: error.code,\n        type: typeof error,\n        keys: Object.keys(error || {}),\n      });\n      \n      // \u0415\u0441\u043B\u0438 \u044D\u0442\u043E \u043E\u0448\u0438\u0431\u043A\u0430 \u0430\u0443\u0442\u0435\u043D\u0442\u0438\u0444\u0438\u043A\u0430\u0446\u0438\u0438, \u0432\u043E\u0437\u0432\u0440\u0430\u0449\u0430\u0435\u043C 401\n      if (error.message?.includes('Authentication') || error.message?.includes('session')) {\n        return res.status(401).json({ \n          error: 'Authentication required',\n          details: process.env.NODE_ENV === 'development' ? error.message : undefined,\n        });\n      }\n      \n      res.status(500).json({ \n        error: 'Internal server error',\n        details: process.env.NODE_ENV === 'development' ? error.message : undefined,\n        code: process.env.NODE_ENV === 'development' ? error.code : undefined,\n      });\n    }\n  });\n\n  // 11. CSRF token endpoint (\u0434\u043B\u044F \u0441\u043E\u0432\u043C\u0435\u0441\u0442\u0438\u043C\u043E\u0441\u0442\u0438 \u0441 frontend)\n  // \u0412 KeystoneJS CSRF \u0437\u0430\u0449\u0438\u0442\u0430 \u0440\u0435\u0430\u043B\u0438\u0437\u043E\u0432\u0430\u043D\u0430 \u0447\u0435\u0440\u0435\u0437 session cookies\n  // \u042D\u0442\u043E\u0442 endpoint \u0432\u043E\u0437\u0432\u0440\u0430\u0449\u0430\u0435\u0442 \u043F\u0443\u0441\u0442\u043E\u0439 \u043E\u0442\u0432\u0435\u0442, \u0442\u0430\u043A \u043A\u0430\u043A CSRF \u0442\u043E\u043A\u0435\u043D \u043D\u0435 \u0442\u0440\u0435\u0431\u0443\u0435\u0442\u0441\u044F\n  app.get('/api/auth/csrf', (req, res) => {\n    // \u0412\u043E\u0437\u0432\u0440\u0430\u0449\u0430\u0435\u043C \u043F\u0443\u0441\u0442\u043E\u0439 CSRF \u0442\u043E\u043A\u0435\u043D \u0434\u043B\u044F \u0441\u043E\u0432\u043C\u0435\u0441\u0442\u0438\u043C\u043E\u0441\u0442\u0438\n    // \u0412 KeystoneJS CSRF \u0437\u0430\u0449\u0438\u0442\u0430 \u0440\u0435\u0430\u043B\u0438\u0437\u043E\u0432\u0430\u043D\u0430 \u0447\u0435\u0440\u0435\u0437 session cookies \u0438 state \u043F\u0430\u0440\u0430\u043C\u0435\u0442\u0440 \u0434\u043B\u044F OAuth\n    res.json({ csrfToken: null });\n  });\n\n  // 12. REST API \u0434\u043B\u044F \u0441\u0442\u0430\u0442\u0435\u0439 (\u0434\u043B\u044F \u0441\u043E\u0432\u043C\u0435\u0441\u0442\u0438\u043C\u043E\u0441\u0442\u0438 \u0441 frontend)\n  // \u0412\u0410\u0416\u041D\u041E: \u042D\u0442\u043E \u0432\u0440\u0435\u043C\u0435\u043D\u043D\u044B\u0439 endpoint \u0434\u043B\u044F \u0441\u043E\u0432\u043C\u0435\u0441\u0442\u0438\u043C\u043E\u0441\u0442\u0438. \u0412 \u0431\u0443\u0434\u0443\u0449\u0435\u043C \u043D\u0443\u0436\u043D\u043E \u043E\u0431\u043D\u043E\u0432\u0438\u0442\u044C frontend \u0434\u043B\u044F \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u043D\u0438\u044F GraphQL API\n  app.post('/api/articles', async (req, res) => {\n    try {\n      const ctx = context || keystoneContext;\n      if (!ctx) {\n        return res.status(500).json({ error: 'KeystoneJS context not available' });\n      }\n\n      // \u041F\u0440\u043E\u0432\u0435\u0440\u044F\u0435\u043C \u0430\u0443\u0442\u0435\u043D\u0442\u0438\u0444\u0438\u043A\u0430\u0446\u0438\u044E \u0447\u0435\u0440\u0435\u0437 KeystoneJS session\n      // \u0421\u043E\u0437\u0434\u0430\u0435\u043C \u043A\u043E\u043D\u0442\u0435\u043A\u0441\u0442 \u0441 req \u0434\u043B\u044F \u0447\u0442\u0435\u043D\u0438\u044F cookies\n      const sessionContext = {\n        ...ctx,\n        req: req,\n        res: res,\n      } as any;\n\n      // \u041F\u043E\u043B\u0443\u0447\u0430\u0435\u043C session \u0438\u0437 cookie \u0447\u0435\u0440\u0435\u0437 sessionStrategy\n      let sessionData;\n      try {\n        sessionData = await ctx.sessionStrategy.get({ context: sessionContext });\n      } catch (sessionError) {\n        logger.debug('Session check failed:', sessionError);\n        return res.status(401).json({ error: 'Invalid session' });\n      }\n\n      if (!sessionData || !sessionData.itemId) {\n        logger.warn('Article creation attempted without valid session');\n        return res.status(401).json({ error: 'Authentication required' });\n      }\n\n      const userId = sessionData.itemId;\n      const body = req.body?.data || req.body;\n\n      // \u0412\u0430\u043B\u0438\u0434\u0430\u0446\u0438\u044F \u0432\u0445\u043E\u0434\u043D\u044B\u0445 \u0434\u0430\u043D\u043D\u044B\u0445\n      if (!body.title || !body.content) {\n        return res.status(400).json({ error: 'Title and content are required' });\n      }\n\n      // \u041F\u0440\u0435\u043E\u0431\u0440\u0430\u0437\u0443\u0435\u043C content \u0438\u0437 HTML \u0441\u0442\u0440\u043E\u043A\u0438 \u0432 document format \u0434\u043B\u044F KeystoneJS\n      // \u0415\u0441\u043B\u0438 content \u0443\u0436\u0435 \u0432 \u0444\u043E\u0440\u043C\u0430\u0442\u0435 document, \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u0443\u0435\u043C \u0435\u0433\u043E \u043A\u0430\u043A \u0435\u0441\u0442\u044C\n      let contentDocument;\n      if (typeof body.content === 'string') {\n        // \u041F\u0440\u0435\u043E\u0431\u0440\u0430\u0437\u0443\u0435\u043C HTML \u0432 document format (ProseMirror/TipTap \u0444\u043E\u0440\u043C\u0430\u0442)\n        // \u041F\u0440\u043E\u0441\u0442\u043E\u0439 \u043F\u0430\u0440\u0441\u0435\u0440 HTML \u0434\u043B\u044F \u0431\u0430\u0437\u043E\u0432\u044B\u0445 \u0442\u0435\u0433\u043E\u0432\n        const htmlContent = body.content.trim();\n        \n        // \u0415\u0441\u043B\u0438 \u044D\u0442\u043E \u043F\u0443\u0441\u0442\u0430\u044F \u0441\u0442\u0440\u043E\u043A\u0430 \u0438\u043B\u0438 \u0442\u043E\u043B\u044C\u043A\u043E \u043F\u0440\u043E\u0431\u0435\u043B\u044B\n        if (!htmlContent || htmlContent === '<p></p>' || htmlContent === '<p><br></p>') {\n          contentDocument = {\n            type: 'doc',\n            content: [\n              {\n                type: 'paragraph',\n              },\n            ],\n          };\n        } else {\n          // \u041F\u0430\u0440\u0441\u0438\u043C HTML \u0432 document format\n          // \u0423\u0431\u0438\u0440\u0430\u0435\u043C \u043E\u0431\u0435\u0440\u0442\u043A\u0438 <p> \u0438 </p>, \u0435\u0441\u043B\u0438 \u043E\u043D\u0438 \u0435\u0441\u0442\u044C\n          let cleanHtml = htmlContent;\n          if (cleanHtml.startsWith('<p>') && cleanHtml.endsWith('</p>')) {\n            cleanHtml = cleanHtml.slice(3, -4);\n          }\n          \n          // \u0420\u0430\u0437\u0431\u0438\u0432\u0430\u0435\u043C \u043D\u0430 \u043F\u0430\u0440\u0430\u0433\u0440\u0430\u0444\u044B \u043F\u043E </p><p> \u0438\u043B\u0438 <br>\n          const paragraphs = cleanHtml.split(/<\\/p>\\s*<p>|<\\/p><p>/).filter(p => p.trim());\n          \n          if (paragraphs.length === 0) {\n            // \u0415\u0441\u043B\u0438 \u043D\u0435\u0442 \u043F\u0430\u0440\u0430\u0433\u0440\u0430\u0444\u043E\u0432, \u0441\u043E\u0437\u0434\u0430\u0435\u043C \u043E\u0434\u0438\u043D \u043F\u0443\u0441\u0442\u043E\u0439\n            contentDocument = {\n              type: 'doc',\n              content: [\n                {\n                  type: 'paragraph',\n                },\n              ],\n            };\n          } else {\n            // \u041F\u0440\u0435\u043E\u0431\u0440\u0430\u0437\u0443\u0435\u043C \u043A\u0430\u0436\u0434\u044B\u0439 \u043F\u0430\u0440\u0430\u0433\u0440\u0430\u0444\n            const content: any[] = [];\n            \n            for (const para of paragraphs) {\n              const cleanPara = para.replace(/^<p>|<\\/p>$/g, '').trim();\n              \n              if (!cleanPara) {\n                content.push({ type: 'paragraph' });\n                continue;\n              }\n              \n              // \u041F\u0440\u043E\u0441\u0442\u043E\u0435 \u043F\u0440\u0435\u043E\u0431\u0440\u0430\u0437\u043E\u0432\u0430\u043D\u0438\u0435: \u0443\u0431\u0438\u0440\u0430\u0435\u043C HTML \u0442\u0435\u0433\u0438 \u0438 \u0441\u043E\u0437\u0434\u0430\u0435\u043C \u0442\u0435\u043A\u0441\u0442\n              const textContent = cleanPara\n                .replace(/<br\\s*\\/?>/gi, '\\n')\n                .replace(/<[^>]*>/g, '')\n                .replace(/&nbsp;/g, ' ')\n                .replace(/&amp;/g, '&')\n                .replace(/&lt;/g, '<')\n                .replace(/&gt;/g, '>')\n                .replace(/&quot;/g, '\"')\n                .replace(/&#39;/g, \"'\");\n              \n              // \u0420\u0430\u0437\u0431\u0438\u0432\u0430\u0435\u043C \u043D\u0430 \u0441\u0442\u0440\u043E\u043A\u0438 \u0438 \u0441\u043E\u0437\u0434\u0430\u0435\u043C \u043F\u0430\u0440\u0430\u0433\u0440\u0430\u0444\u044B\n              const lines = textContent.split('\\n').filter(line => line.trim() || textContent.includes('\\n'));\n              \n              if (lines.length === 0) {\n                content.push({ type: 'paragraph' });\n              } else {\n                for (const line of lines) {\n                  if (line.trim()) {\n                    content.push({\n                      type: 'paragraph',\n                      content: [\n                        {\n                          type: 'text',\n                          text: line.trim(),\n                        },\n                      ],\n                    });\n                  } else {\n                    content.push({ type: 'paragraph' });\n                  }\n                }\n              }\n            }\n            \n            contentDocument = {\n              type: 'doc',\n              content: content.length > 0 ? content : [{ type: 'paragraph' }],\n            };\n          }\n        }\n      } else if (body.content && typeof body.content === 'object') {\n        // \u0415\u0441\u043B\u0438 \u0443\u0436\u0435 \u0432 \u0444\u043E\u0440\u043C\u0430\u0442\u0435 document, \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u0443\u0435\u043C \u043A\u0430\u043A \u0435\u0441\u0442\u044C\n        contentDocument = body.content;\n      } else {\n        // Fallback: \u043F\u0443\u0441\u0442\u043E\u0439 \u0434\u043E\u043A\u0443\u043C\u0435\u043D\u0442\n        contentDocument = {\n          type: 'doc',\n          content: [\n            {\n              type: 'paragraph',\n            },\n          ],\n        };\n      }\n\n      // \u0421\u043E\u0437\u0434\u0430\u0435\u043C \u0441\u0442\u0430\u0442\u044C\u044E \u0447\u0435\u0440\u0435\u0437 GraphQL API\n      const article = await ctx.sudo().query.Article.createOne({\n        data: {\n          title: body.title,\n          content: contentDocument,\n          excerpt: body.excerpt || null,\n          author: { connect: { id: userId } },\n          tags: body.tags || [],\n          difficulty: body.difficulty || 'medium',\n          previewImage: body.preview_image || null,\n          publishedAt: body.publishedAt || null,\n        },\n        query: 'id title content { document } excerpt author { id username avatar } tags difficulty previewImage likes_count dislikes_count views publishedAt createdAt updatedAt',\n      });\n\n      // \u041F\u0440\u0435\u043E\u0431\u0440\u0430\u0437\u0443\u0435\u043C \u0432 \u0444\u043E\u0440\u043C\u0430\u0442, \u0441\u043E\u0432\u043C\u0435\u0441\u0442\u0438\u043C\u044B\u0439 \u0441 frontend\n      const response = {\n        data: {\n          id: String(article.id),\n          attributes: {\n            title: article.title,\n            content: typeof article.content === 'object' && article.content.document \n              ? JSON.stringify(article.content.document)\n              : article.content,\n            excerpt: article.excerpt,\n            author: {\n              data: {\n                id: article.author.id,\n                attributes: {\n                  username: article.author.username,\n                  avatar: article.author.avatar,\n                },\n              },\n            },\n            tags: article.tags,\n            difficulty: article.difficulty,\n            preview_image: article.previewImage,\n            likes_count: article.likes_count,\n            dislikes_count: article.dislikes_count,\n            views: article.views,\n            publishedAt: article.publishedAt,\n            createdAt: article.createdAt,\n            updatedAt: article.updatedAt,\n          },\n        },\n      };\n\n      res.status(201).json(response);\n    } catch (error: any) {\n      logger.error('Failed to create article:', error);\n      res.status(500).json({ \n        error: 'Failed to create article',\n        details: process.env.NODE_ENV === 'development' ? error.message : undefined,\n      });\n    }\n  });\n\n  // \u041E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u0435 \u0441\u0442\u0430\u0442\u044C\u0438\n  app.put('/api/articles/:id', async (req, res) => {\n    try {\n      const ctx = context || keystoneContext;\n      if (!ctx) {\n        return res.status(500).json({ error: 'KeystoneJS context not available' });\n      }\n\n      // \u041F\u0440\u043E\u0432\u0435\u0440\u044F\u0435\u043C \u0430\u0443\u0442\u0435\u043D\u0442\u0438\u0444\u0438\u043A\u0430\u0446\u0438\u044E \u0447\u0435\u0440\u0435\u0437 KeystoneJS session\n      // \u0421\u043E\u0437\u0434\u0430\u0435\u043C \u043A\u043E\u043D\u0442\u0435\u043A\u0441\u0442 \u0441 req \u0434\u043B\u044F \u0447\u0442\u0435\u043D\u0438\u044F cookies\n      const sessionContext = {\n        ...ctx,\n        req: req,\n        res: res,\n      } as any;\n\n      // \u041F\u043E\u043B\u0443\u0447\u0430\u0435\u043C session \u0438\u0437 cookie \u0447\u0435\u0440\u0435\u0437 sessionStrategy\n      let sessionData;\n      try {\n        sessionData = await ctx.sessionStrategy.get({ context: sessionContext });\n      } catch (sessionError) {\n        logger.debug('Session check failed:', sessionError);\n        return res.status(401).json({ error: 'Invalid session' });\n      }\n\n      if (!sessionData || !sessionData.itemId) {\n        logger.warn('Article update attempted without valid session');\n        return res.status(401).json({ error: 'Authentication required' });\n      }\n\n      const articleId = req.params.id;\n      const body = req.body?.data || req.body;\n\n      // \u041F\u0440\u043E\u0432\u0435\u0440\u044F\u0435\u043C, \u0447\u0442\u043E \u0441\u0442\u0430\u0442\u044C\u044F \u043F\u0440\u0438\u043D\u0430\u0434\u043B\u0435\u0436\u0438\u0442 \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044E\n      const existingArticle = await ctx.query.Article.findOne({\n        where: { id: articleId },\n        query: 'id author { id }',\n      });\n\n      if (!existingArticle) {\n        return res.status(404).json({ error: 'Article not found' });\n      }\n\n      if (String(existingArticle.author.id) !== String(sessionData.itemId)) {\n        return res.status(403).json({ error: 'Forbidden' });\n      }\n\n      // \u041F\u0440\u0435\u043E\u0431\u0440\u0430\u0437\u0443\u0435\u043C content \u0438\u0437 HTML \u0441\u0442\u0440\u043E\u043A\u0438 \u0432 document format \u0434\u043B\u044F KeystoneJS\n      // \u0418\u0441\u043F\u043E\u043B\u044C\u0437\u0443\u0435\u043C \u0442\u0443 \u0436\u0435 \u043B\u043E\u0433\u0438\u043A\u0443, \u0447\u0442\u043E \u0438 \u043F\u0440\u0438 \u0441\u043E\u0437\u0434\u0430\u043D\u0438\u0438\n      let contentDocument;\n      if (typeof body.content === 'string') {\n        const htmlContent = body.content.trim();\n        \n        if (!htmlContent || htmlContent === '<p></p>' || htmlContent === '<p><br></p>') {\n          contentDocument = {\n            type: 'doc',\n            content: [{ type: 'paragraph' }],\n          };\n        } else {\n          let cleanHtml = htmlContent;\n          if (cleanHtml.startsWith('<p>') && cleanHtml.endsWith('</p>')) {\n            cleanHtml = cleanHtml.slice(3, -4);\n          }\n          \n          const paragraphs = cleanHtml.split(/<\\/p>\\s*<p>|<\\/p><p>/).filter(p => p.trim());\n          const content: any[] = [];\n          \n          for (const para of paragraphs) {\n            const cleanPara = para.replace(/^<p>|<\\/p>$/g, '').trim();\n            if (!cleanPara) {\n              content.push({ type: 'paragraph' });\n              continue;\n            }\n            \n            const textContent = cleanPara\n              .replace(/<br\\s*\\/?>/gi, '\\n')\n              .replace(/<[^>]*>/g, '')\n              .replace(/&nbsp;/g, ' ')\n              .replace(/&amp;/g, '&')\n              .replace(/&lt;/g, '<')\n              .replace(/&gt;/g, '>')\n              .replace(/&quot;/g, '\"')\n              .replace(/&#39;/g, \"'\");\n            \n            const lines = textContent.split('\\n').filter(line => line.trim() || textContent.includes('\\n'));\n            \n            if (lines.length === 0) {\n              content.push({ type: 'paragraph' });\n            } else {\n              for (const line of lines) {\n                if (line.trim()) {\n                  content.push({\n                    type: 'paragraph',\n                    content: [{ type: 'text', text: line.trim() }],\n                  });\n                } else {\n                  content.push({ type: 'paragraph' });\n                }\n              }\n            }\n          }\n          \n          contentDocument = {\n            type: 'doc',\n            content: content.length > 0 ? content : [{ type: 'paragraph' }],\n          };\n        }\n      } else if (body.content && typeof body.content === 'object') {\n        contentDocument = body.content;\n      } else {\n        contentDocument = {\n          type: 'doc',\n          content: [{ type: 'paragraph' }],\n        };\n      }\n\n      // \u041E\u0431\u043D\u043E\u0432\u043B\u044F\u0435\u043C \u0441\u0442\u0430\u0442\u044C\u044E\n      const updateData: any = {};\n      if (body.title) updateData.title = body.title;\n      if (contentDocument) updateData.content = contentDocument;\n      if (body.excerpt !== undefined) updateData.excerpt = body.excerpt;\n      if (body.tags) updateData.tags = body.tags;\n      if (body.difficulty) updateData.difficulty = body.difficulty;\n      if (body.preview_image !== undefined) updateData.previewImage = body.preview_image;\n      if (body.publishedAt !== undefined) updateData.publishedAt = body.publishedAt;\n\n      const article = await ctx.sudo().query.Article.updateOne({\n        where: { id: articleId },\n        data: updateData,\n        query: 'id title content { document } excerpt author { id username avatar } tags difficulty previewImage likes_count dislikes_count views publishedAt createdAt updatedAt',\n      });\n\n      // \u041F\u0440\u0435\u043E\u0431\u0440\u0430\u0437\u0443\u0435\u043C \u0432 \u0444\u043E\u0440\u043C\u0430\u0442, \u0441\u043E\u0432\u043C\u0435\u0441\u0442\u0438\u043C\u044B\u0439 \u0441 frontend\n      const response = {\n        data: {\n          id: String(article.id),\n          attributes: {\n            title: article.title,\n            content: typeof article.content === 'object' && article.content.document \n              ? JSON.stringify(article.content.document)\n              : article.content,\n            excerpt: article.excerpt,\n            author: {\n              data: {\n                id: article.author.id,\n                attributes: {\n                  username: article.author.username,\n                  avatar: article.author.avatar,\n                },\n              },\n            },\n            tags: article.tags,\n            difficulty: article.difficulty,\n            preview_image: article.previewImage,\n            likes_count: article.likes_count,\n            dislikes_count: article.dislikes_count,\n            views: article.views,\n            publishedAt: article.publishedAt,\n            createdAt: article.createdAt,\n            updatedAt: article.updatedAt,\n          },\n        },\n      };\n\n      res.json(response);\n    } catch (error: any) {\n      logger.error('Failed to update article:', error);\n      res.status(500).json({ \n        error: 'Failed to update article',\n        details: process.env.NODE_ENV === 'development' ? error.message : undefined,\n      });\n    }\n  });\n\n  // 13. GraphQL security logging middleware\n  // \u041B\u043E\u0433\u0438\u0440\u0443\u0435\u043C \u043F\u043E\u043F\u044B\u0442\u043A\u0438 \u0430\u0443\u0442\u0435\u043D\u0442\u0438\u0444\u0438\u043A\u0430\u0446\u0438\u0438 \u0447\u0435\u0440\u0435\u0437 GraphQL\n  app.use('/api/graphql', (req, res, next) => {\n    // \u041F\u0440\u043E\u0432\u0435\u0440\u044F\u0435\u043C, \u044F\u0432\u043B\u044F\u0435\u0442\u0441\u044F \u043B\u0438 \u044D\u0442\u043E \u0437\u0430\u043F\u0440\u043E\u0441\u043E\u043C \u043D\u0430 \u0430\u0443\u0442\u0435\u043D\u0442\u0438\u0444\u0438\u043A\u0430\u0446\u0438\u044E\n    if (req.method === 'POST' && req.body) {\n      const body = req.body;\n      const query = body.query || '';\n      \n      // \u041F\u0440\u043E\u0432\u0435\u0440\u044F\u0435\u043C \u043D\u0430\u043B\u0438\u0447\u0438\u0435 mutation authenticateUserWithPassword\n      if (query.includes('authenticateUserWithPassword')) {\n        const ip = req.ip || req.connection?.remoteAddress || 'unknown';\n        const userAgent = req.get('user-agent') || 'unknown';\n        \n        // \u0418\u0437\u0432\u043B\u0435\u043A\u0430\u0435\u043C email \u0438\u0437 \u043F\u0435\u0440\u0435\u043C\u0435\u043D\u043D\u044B\u0445 (\u0435\u0441\u043B\u0438 \u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D)\n        const variables = body.variables || {};\n        const email = variables.email || 'unknown';\n        \n        // \u041B\u043E\u0433\u0438\u0440\u0443\u0435\u043C \u043F\u043E\u043F\u044B\u0442\u043A\u0443 \u0432\u0445\u043E\u0434\u0430\n        logLoginAttempt(ip, email, userAgent);\n      }\n\n      // \u041B\u043E\u0433\u0438\u0440\u0443\u0435\u043C createArticle mutation \u0434\u043B\u044F \u043E\u0442\u043B\u0430\u0434\u043A\u0438\n      if (query.includes('createArticle') || query.includes('CreateArticle')) {\n        const variables = body.variables || {};\n        logger.info('[GraphQL] \u26A1 createArticle mutation request:', {\n          query: query.substring(0, 500),\n          variables: {\n            ...variables,\n            data: variables.data ? {\n              ...variables.data,\n              title: variables.data.title,\n              content: variables.data.content \n                ? (Array.isArray(variables.data.content) \n                    ? `[Array of ${variables.data.content.length} blocks, first: ${JSON.stringify(variables.data.content[0] || {}).substring(0, 300)}]` \n                    : typeof variables.data.content)\n                : 'undefined',\n              excerpt: variables.data.excerpt,\n              tags: variables.data.tags,\n              difficulty: variables.data.difficulty,\n              previewImage: variables.data.previewImage,\n              publishedAt: variables.data.publishedAt,\n            } : undefined,\n          },\n        });\n      }\n      \n      // \u041B\u043E\u0433\u0438\u0440\u0443\u0435\u043C \u0412\u0421\u0415 GraphQL \u0437\u0430\u043F\u0440\u043E\u0441\u044B \u0434\u043B\u044F \u043E\u0442\u043B\u0430\u0434\u043A\u0438 (\u0442\u043E\u043B\u044C\u043A\u043E \u0432 development)\n      if (process.env.NODE_ENV === 'development') {\n        const queryName = query.match(/(?:query|mutation)\\s+(\\w+)/)?.[1] || 'unknown';\n        const allVariables = body.variables || {};\n        logger.debug(`[GraphQL] Request: ${queryName}`, {\n          query: query.substring(0, 200),\n          hasVariables: !!allVariables && Object.keys(allVariables).length > 0,\n        });\n      }\n    }\n    next();\n  });\n\n  // 14. GraphQL error logging middleware\n  // \u041B\u043E\u0433\u0438\u0440\u0443\u0435\u043C \u043E\u0448\u0438\u0431\u043A\u0438 GraphQL \u043E\u0442\u0432\u0435\u0442\u043E\u0432\n  app.use('/api/graphql', (req, res, next) => {\n    const originalJson = res.json;\n    res.json = function (body: any) {\n      if (body && body.errors) {\n        logger.error('[GraphQL] GraphQL errors in response:', {\n          errors: body.errors,\n          path: req.path,\n          method: req.method,\n        });\n      }\n      return originalJson.call(this, body);\n    };\n    next();\n  });\n\n  // 15. HTTP request logging\n  app.use(\n    morgan('combined', {\n      stream: {\n        write: (message: string) => {\n          logger.info(message.trim());\n        },\n      },\n    })\n  );\n\n  // 16. Error handling middleware\n  app.use((err: any, req: any, res: any, next: any) => {\n    logger.error('Express error:', err);\n    res.status(err.status || 500).json({\n      error: {\n        message: err.message || 'Internal server error',\n        ...(process.env.NODE_ENV === 'development' && { stack: err.stack }),\n      },\n    });\n  });\n\n  logger.info('\u2705 Express middleware configured');\n}\n\n", "/**\n * Redis client \u0441 fallback \u043D\u0430 in-memory storage\n * \u0418\u0441\u043F\u043E\u043B\u044C\u0437\u0443\u0435\u0442\u0441\u044F \u0434\u043B\u044F \u043A\u0435\u0448\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u044F \u0438 \u0441\u0435\u0441\u0441\u0438\u0439\n */\nimport Redis from 'ioredis';\nimport logger from './logger';\n\nlet redisClient: Redis | null = null;\n\nexport function getRedisClient(): Redis {\n  if (redisClient) {\n    return redisClient;\n  }\n\n  const host = process.env.REDIS_HOST || 'localhost';\n  const port = parseInt(process.env.REDIS_PORT || '6379', 10);\n  const password = process.env.REDIS_PASSWORD || undefined;\n\n  redisClient = new Redis({\n    host,\n    port,\n    password,\n    retryStrategy: (times) => {\n      // \u041E\u0441\u0442\u0430\u043D\u0430\u0432\u043B\u0438\u0432\u0430\u0435\u043C \u043F\u043E\u043F\u044B\u0442\u043A\u0438 \u043F\u043E\u0441\u043B\u0435 3 \u043D\u0435\u0443\u0434\u0430\u0447\n      if (times > 3) {\n        logger.warn('Redis connection failed after 3 attempts, using in-memory fallback');\n        return null; // \u041E\u0441\u0442\u0430\u043D\u0430\u0432\u043B\u0438\u0432\u0430\u0435\u043C \u043F\u043E\u043F\u044B\u0442\u043A\u0438\n      }\n      const delay = Math.min(times * 50, 2000);\n      logger.warn(`Redis connection retry attempt ${times}, delay: ${delay}ms`);\n      return delay;\n    },\n    maxRetriesPerRequest: 3,\n    enableReadyCheck: true,\n    lazyConnect: true,\n    connectTimeout: 2000, // \u0422\u0430\u0439\u043C\u0430\u0443\u0442 \u043F\u043E\u0434\u043A\u043B\u044E\u0447\u0435\u043D\u0438\u044F 2 \u0441\u0435\u043A\u0443\u043D\u0434\u044B\n  });\n\n  redisClient.on('connect', () => {\n    logger.info('\u2705 Redis client connected');\n  });\n\n  redisClient.on('error', (error) => {\n    logger.error('\u274C Redis client error:', error);\n  });\n\n  redisClient.on('close', () => {\n    logger.warn('\u26A0\uFE0F Redis connection closed');\n  });\n\n  redisClient.on('reconnecting', () => {\n    logger.info('\uD83D\uDD04 Redis reconnecting...');\n  });\n\n  // Graceful shutdown\n  process.on('SIGTERM', async () => {\n    await redisClient?.quit();\n  });\n\n  process.on('SIGINT', async () => {\n    await redisClient?.quit();\n  });\n\n  return redisClient;\n}\n\n// Fallback \u0434\u043B\u044F development (\u0435\u0441\u043B\u0438 Redis \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D)\nexport async function getRedisClientWithFallback(): Promise<Redis | null> {\n  try {\n    const client = getRedisClient();\n    await client.ping();\n    return client;\n  } catch (error) {\n    logger.warn('\u26A0\uFE0F Redis unavailable, using in-memory fallback');\n    return null;\n  }\n}\n\n", "/**\n * OAuth2 handler \u0434\u043B\u044F \u0438\u043D\u0442\u0435\u0433\u0440\u0430\u0446\u0438\u0438 \u0441 KeystoneJS\n * \u0421\u043E\u0437\u0434\u0430\u0435\u0442 \u0438\u043B\u0438 \u043E\u0431\u043D\u043E\u0432\u043B\u044F\u0435\u0442 \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u0435\u0439 \u0432 \u0431\u0430\u0437\u0435 \u0434\u0430\u043D\u043D\u044B\u0445 \u0447\u0435\u0440\u0435\u0437 KeystoneJS context\n */\nimport type { KeystoneContext } from '@keystone-6/core/types';\nimport logger from '../lib/logger';\n\nexport interface GoogleProfile {\n  id: string;\n  email: string; // Email \u0443\u0436\u0435 \u0438\u0437\u0432\u043B\u0435\u0447\u0435\u043D \u0432 passport.ts\n  displayName: string;\n  avatar?: string;\n  provider: string;\n}\n\n/**\n * \u041D\u0430\u0439\u0442\u0438 \u0438\u043B\u0438 \u0441\u043E\u0437\u0434\u0430\u0442\u044C \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044F \u0447\u0435\u0440\u0435\u0437 Google OAuth\n */\nexport async function findOrCreateGoogleUser(\n  context: KeystoneContext,\n  profile: GoogleProfile\n): Promise<{ id: string; email: string; username: string; name: string; avatar?: string } | null> {\n  try {\n    const email = profile.email;\n    if (!email) {\n      logger.error('Google OAuth: No email in profile', { profile });\n      return null;\n    }\n\n    // \u0418\u0449\u0435\u043C \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044F \u043F\u043E email\n    // \u0418\u0441\u043F\u043E\u043B\u044C\u0437\u0443\u0435\u043C sudo() \u0434\u043B\u044F \u043E\u0431\u0445\u043E\u0434\u0430 access control \u043F\u0440\u0438 OAuth \u043E\u0431\u0440\u0430\u0431\u043E\u0442\u043A\u0435\n    const existingUser = await context.sudo().query.User.findMany({\n      where: { email: { equals: email } },\n      query: 'id email username name avatar provider confirmed',\n      take: 1,\n    });\n\n    if (existingUser.length > 0) {\n      const user = existingUser[0];\n      \n      // \u041E\u0431\u043D\u043E\u0432\u043B\u044F\u0435\u043C \u0434\u0430\u043D\u043D\u044B\u0435, \u0435\u0441\u043B\u0438 \u043E\u043D\u0438 \u0438\u0437\u043C\u0435\u043D\u0438\u043B\u0438\u0441\u044C\n      const updateData: any = {};\n      if (profile.displayName && user.name !== profile.displayName) {\n        updateData.name = profile.displayName;\n      }\n      if (profile.avatar && user.avatar !== profile.avatar) {\n        updateData.avatar = profile.avatar;\n      }\n      if (user.provider !== 'google') {\n        updateData.provider = 'google';\n      }\n      if (user.confirmed !== true) {\n        updateData.confirmed = true;\n      }\n\n      if (Object.keys(updateData).length > 0) {\n        // \u0418\u0441\u043F\u043E\u043B\u044C\u0437\u0443\u0435\u043C context.sudo() \u0434\u043B\u044F \u043E\u0431\u0445\u043E\u0434\u0430 access control \u043F\u0440\u0438 OAuth \u043E\u0431\u0440\u0430\u0431\u043E\u0442\u043A\u0435\n        // \u042D\u0442\u043E \u0431\u0435\u0437\u043E\u043F\u0430\u0441\u043D\u043E, \u0442\u0430\u043A \u043A\u0430\u043A \u043C\u044B \u043E\u0431\u043D\u043E\u0432\u043B\u044F\u0435\u043C \u0442\u043E\u043B\u044C\u043A\u043E \u043F\u0443\u0431\u043B\u0438\u0447\u043D\u044B\u0435 \u043F\u043E\u043B\u044F (name, avatar, provider)\n        await context.sudo().query.User.updateOne({\n          where: { id: user.id },\n          data: updateData,\n        });\n        logger.info(`Updated Google OAuth user: ${user.id}`);\n      }\n\n      return {\n        id: String(user.id),\n        email: user.email,\n        username: user.username,\n        name: user.name || profile.displayName,\n        avatar: user.avatar || profile.avatar,\n      };\n    }\n\n    // \u0421\u043E\u0437\u0434\u0430\u0435\u043C \u043D\u043E\u0432\u043E\u0433\u043E \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044F\n    // \u0413\u0435\u043D\u0435\u0440\u0438\u0440\u0443\u0435\u043C username \u0438\u0437 email \u0438\u043B\u0438 displayName\n    const baseUsername = profile.displayName\n      .toLowerCase()\n      .replace(/[^a-z0-9]/g, '')\n      .substring(0, 20) || email.split('@')[0].substring(0, 20);\n\n    let username = baseUsername;\n    let counter = 1;\n\n    // \u041F\u0440\u043E\u0432\u0435\u0440\u044F\u0435\u043C \u0443\u043D\u0438\u043A\u0430\u043B\u044C\u043D\u043E\u0441\u0442\u044C username\n    // \u0418\u0441\u043F\u043E\u043B\u044C\u0437\u0443\u0435\u043C sudo() \u0434\u043B\u044F \u043E\u0431\u0445\u043E\u0434\u0430 access control \u043F\u0440\u0438 OAuth \u043E\u0431\u0440\u0430\u0431\u043E\u0442\u043A\u0435\n    while (true) {\n      const existing = await context.sudo().query.User.findMany({\n        where: { username: { equals: username } },\n        take: 1,\n      });\n\n      if (existing.length === 0) {\n        break;\n      }\n\n      username = `${baseUsername}${counter}`;\n      counter++;\n      if (counter > 100) { // \u041E\u0433\u0440\u0430\u043D\u0438\u0447\u0435\u043D\u0438\u0435, \u0447\u0442\u043E\u0431\u044B \u0438\u0437\u0431\u0435\u0436\u0430\u0442\u044C \u0431\u0435\u0441\u043A\u043E\u043D\u0435\u0447\u043D\u043E\u0433\u043E \u0446\u0438\u043A\u043B\u0430\n        throw new Error('Could not generate unique username');\n      }\n    }\n\n    // \u0421\u043E\u0437\u0434\u0430\u0435\u043C \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044F\n    // \u0418\u0441\u043F\u043E\u043B\u044C\u0437\u0443\u0435\u043C sudo() \u0434\u043B\u044F \u043E\u0431\u0445\u043E\u0434\u0430 access control \u043F\u0440\u0438 OAuth \u043E\u0431\u0440\u0430\u0431\u043E\u0442\u043A\u0435\n    const newUser = await context.sudo().query.User.createOne({\n      data: {\n        email,\n        username,\n        name: profile.displayName,\n        avatar: profile.avatar || undefined,\n        provider: 'google',\n        confirmed: true,\n        blocked: false,\n        role: 'user', // \u041D\u043E\u0432\u044B\u0435 \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u0438 \u043F\u043E\u043B\u0443\u0447\u0430\u044E\u0442 \u0440\u043E\u043B\u044C 'user' \u043F\u043E \u0443\u043C\u043E\u043B\u0447\u0430\u043D\u0438\u044E\n        // password \u043D\u0435 \u0442\u0440\u0435\u0431\u0443\u0435\u0442\u0441\u044F \u0434\u043B\u044F OAuth \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u0435\u0439\n      },\n      query: 'id email username name avatar',\n    });\n\n    logger.info(`Created new Google OAuth user: ${newUser.id}`);\n\n    return {\n      id: String(newUser.id),\n      email: newUser.email,\n      username: newUser.username,\n      name: newUser.name || profile.displayName,\n      avatar: newUser.avatar || profile.avatar,\n    };\n  } catch (error) {\n    logger.error('Error in findOrCreateGoogleUser:', error);\n    return null;\n  }\n}\n\n\n", "/**\n * Passport.js configuration for OAuth2\n * \u041D\u0430\u0441\u0442\u0440\u043E\u0439\u043A\u0430 Google OAuth2 \u0441\u0442\u0440\u0430\u0442\u0435\u0433\u0438\u0438\n */\nimport passport from 'passport';\nimport { Strategy as GoogleStrategy } from 'passport-google-oauth20';\nimport { Strategy as JwtStrategy, ExtractJwt } from 'passport-jwt';\nimport logger from '../lib/logger';\n\n// Google OAuth2 Strategy\npassport.use(\n  new GoogleStrategy(\n    {\n      clientID: process.env.GOOGLE_CLIENT_ID || '',\n      clientSecret: process.env.GOOGLE_CLIENT_SECRET || '',\n      // \u0412\u0410\u0416\u041D\u041E: callbackURL \u0434\u043E\u043B\u0436\u0435\u043D \u0443\u043A\u0430\u0437\u044B\u0432\u0430\u0442\u044C \u043D\u0430 BACKEND, \u0430 \u043D\u0435 frontend!\n      // Google \u0431\u0443\u0434\u0435\u0442 \u0440\u0435\u0434\u0438\u0440\u0435\u043A\u0442\u0438\u0442\u044C \u043D\u0430 \u044D\u0442\u043E\u0442 URL \u043F\u043E\u0441\u043B\u0435 \u0430\u0432\u0442\u043E\u0440\u0438\u0437\u0430\u0446\u0438\u0438\n      callbackURL: process.env.GOOGLE_CALLBACK_URL || 'http://localhost:1337/api/connect/google/callback',\n    },\n    async (accessToken, refreshToken, profile, done) => {\n      try {\n        // \u041F\u0440\u043E\u0432\u0435\u0440\u044F\u0435\u043C \u043D\u0430\u043B\u0438\u0447\u0438\u0435 email (\u043E\u0431\u044F\u0437\u0430\u0442\u0435\u043B\u044C\u043D\u043E \u0434\u043B\u044F OAuth)\n        const email = profile.emails?.[0]?.value;\n        if (!email) {\n          logger.error('Google OAuth: No email in profile', {\n            profileId: profile.id,\n            emails: profile.emails,\n          });\n          return done(new Error('Email is required for OAuth authentication'), null);\n        }\n\n        logger.info(`Google OAuth callback: ${profile.id}, ${email}`);\n        \n        const userProfile = {\n          id: profile.id,\n          email: email, // \u0422\u0435\u043F\u0435\u0440\u044C \u0433\u0430\u0440\u0430\u043D\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u043D\u043E \u0435\u0441\u0442\u044C\n          displayName: profile.displayName,\n          avatar: profile.photos?.[0]?.value,\n          provider: 'google',\n        };\n        \n        return done(null, userProfile);\n      } catch (error) {\n        logger.error('Google OAuth error:', error);\n        return done(error, null);\n      }\n    }\n  )\n);\n\n// JWT Strategy \u0434\u043B\u044F API \u0430\u0443\u0442\u0435\u043D\u0442\u0438\u0444\u0438\u043A\u0430\u0446\u0438\u0438\npassport.use(\n  new JwtStrategy(\n    {\n      jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),\n      secretOrKey: process.env.JWT_SECRET || 'change-me-in-production',\n    },\n    async (payload, done) => {\n      try {\n        // TODO: \u041F\u0440\u043E\u0432\u0435\u0440\u0438\u0442\u044C \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044F \u0432 \u0431\u0430\u0437\u0435 \u0434\u0430\u043D\u043D\u044B\u0445 \u0447\u0435\u0440\u0435\u0437 KeystoneJS\n        // payload \u0441\u043E\u0434\u0435\u0440\u0436\u0438\u0442 { id, email, username } \u0438\u0437 JWT \u0442\u043E\u043A\u0435\u043D\u0430\n        \n        logger.info(`JWT authentication: ${payload.id}`);\n        \n        // \u0412\u0440\u0435\u043C\u0435\u043D\u043D\u0430\u044F \u0437\u0430\u0433\u043B\u0443\u0448\u043A\u0430\n        const user = {\n          id: payload.id,\n          email: payload.email,\n          username: payload.username,\n        };\n        \n        return done(null, user);\n      } catch (error) {\n        logger.error('JWT authentication error:', error);\n        return done(error, null);\n      }\n    }\n  )\n);\n\npassport.serializeUser((user: any, done) => {\n  done(null, user.id);\n});\n\npassport.deserializeUser(async (id: string, done) => {\n  try {\n    // TODO: \u041D\u0430\u0439\u0442\u0438 \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044F \u0432 \u0431\u0430\u0437\u0435 \u0434\u0430\u043D\u043D\u044B\u0445 \u0447\u0435\u0440\u0435\u0437 KeystoneJS\n    logger.info(`Deserialize user: ${id}`);\n    done(null, { id });\n  } catch (error) {\n    logger.error('Deserialize user error:', error);\n    done(error, null);\n  }\n});\n\nlogger.info('\u2705 Passport.js configured');\n\nexport default passport;\n\n", "/**\n * Security logger\n * \u041B\u043E\u0433\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u0435 \u0441\u043E\u0431\u044B\u0442\u0438\u0439 \u0431\u0435\u0437\u043E\u043F\u0430\u0441\u043D\u043E\u0441\u0442\u0438: \u043F\u043E\u043F\u044B\u0442\u043A\u0438 \u0434\u043E\u0441\u0442\u0443\u043F\u0430, \u043D\u0435\u0443\u0434\u0430\u0447\u043D\u044B\u0435 \u0432\u0445\u043E\u0434\u044B, \u043F\u043E\u0434\u043E\u0437\u0440\u0438\u0442\u0435\u043B\u044C\u043D\u0430\u044F \u0430\u043A\u0442\u0438\u0432\u043D\u043E\u0441\u0442\u044C\n */\nimport logger from './logger';\n\ninterface SecurityEvent {\n  type: 'login_attempt' | 'login_failure' | 'login_success' | 'admin_access_denied' | 'admin_access_granted' | 'rate_limit_exceeded';\n  ip?: string;\n  email?: string;\n  userId?: string;\n  userAgent?: string;\n  reason?: string;\n  timestamp?: Date;\n}\n\n/**\n * \u041B\u043E\u0433\u0438\u0440\u0443\u0435\u0442 \u0441\u043E\u0431\u044B\u0442\u0438\u0435 \u0431\u0435\u0437\u043E\u043F\u0430\u0441\u043D\u043E\u0441\u0442\u0438\n */\nexport function logSecurityEvent(event: SecurityEvent) {\n  const timestamp = event.timestamp || new Date();\n  const logData = {\n    type: event.type,\n    ip: event.ip,\n    email: event.email,\n    userId: event.userId,\n    userAgent: event.userAgent,\n    reason: event.reason,\n    timestamp: timestamp.toISOString(),\n  };\n\n  // \u041A\u0440\u0438\u0442\u0438\u0447\u0435\u0441\u043A\u0438\u0435 \u0441\u043E\u0431\u044B\u0442\u0438\u044F \u043B\u043E\u0433\u0438\u0440\u0443\u0435\u043C \u043A\u0430\u043A error, \u043E\u0441\u0442\u0430\u043B\u044C\u043D\u044B\u0435 \u043A\u0430\u043A warn\n  if (event.type === 'login_failure' || event.type === 'admin_access_denied' || event.type === 'rate_limit_exceeded') {\n    logger.warn(`\uD83D\uDD12 Security Event: ${event.type}`, logData);\n  } else {\n    logger.info(`\uD83D\uDD12 Security Event: ${event.type}`, logData);\n  }\n}\n\n/**\n * \u041B\u043E\u0433\u0438\u0440\u0443\u0435\u0442 \u043F\u043E\u043F\u044B\u0442\u043A\u0443 \u0432\u0445\u043E\u0434\u0430\n */\nexport function logLoginAttempt(ip: string, email: string, userAgent?: string) {\n  logSecurityEvent({\n    type: 'login_attempt',\n    ip,\n    email,\n    userAgent,\n  });\n}\n\n/**\n * \u041B\u043E\u0433\u0438\u0440\u0443\u0435\u0442 \u043D\u0435\u0443\u0434\u0430\u0447\u043D\u0443\u044E \u043F\u043E\u043F\u044B\u0442\u043A\u0443 \u0432\u0445\u043E\u0434\u0430\n */\nexport function logLoginFailure(ip: string, email: string, reason: string, userAgent?: string) {\n  logSecurityEvent({\n    type: 'login_failure',\n    ip,\n    email,\n    reason,\n    userAgent,\n  });\n}\n\n/**\n * \u041B\u043E\u0433\u0438\u0440\u0443\u0435\u0442 \u0443\u0441\u043F\u0435\u0448\u043D\u044B\u0439 \u0432\u0445\u043E\u0434\n */\nexport function logLoginSuccess(ip: string, email: string, userId: string, userAgent?: string) {\n  logSecurityEvent({\n    type: 'login_success',\n    ip,\n    email,\n    userId,\n    userAgent,\n  });\n}\n\n/**\n * \u041B\u043E\u0433\u0438\u0440\u0443\u0435\u0442 \u043E\u0442\u043A\u0430\u0437 \u0432 \u0434\u043E\u0441\u0442\u0443\u043F\u0435 \u043A Admin UI\n */\nexport function logAdminAccessDenied(ip: string, userId?: string, reason?: string, userAgent?: string) {\n  logSecurityEvent({\n    type: 'admin_access_denied',\n    ip,\n    userId,\n    reason,\n    userAgent,\n  });\n}\n\n/**\n * \u041B\u043E\u0433\u0438\u0440\u0443\u0435\u0442 \u0443\u0441\u043F\u0435\u0448\u043D\u044B\u0439 \u0434\u043E\u0441\u0442\u0443\u043F \u043A Admin UI\n */\nexport function logAdminAccessGranted(ip: string, userId: string, email: string, userAgent?: string) {\n  logSecurityEvent({\n    type: 'admin_access_granted',\n    ip,\n    userId,\n    email,\n    userAgent,\n  });\n}\n\n/**\n * \u041B\u043E\u0433\u0438\u0440\u0443\u0435\u0442 \u043F\u0440\u0435\u0432\u044B\u0448\u0435\u043D\u0438\u0435 rate limit\n */\nexport function logRateLimitExceeded(ip: string, endpoint: string, userAgent?: string) {\n  logSecurityEvent({\n    type: 'rate_limit_exceeded',\n    ip,\n    reason: `Rate limit exceeded for endpoint: ${endpoint}`,\n    userAgent,\n  });\n}\n\n", "/**\n * Custom GraphQL mutations for reactions\n * \u041A\u0430\u0441\u0442\u043E\u043C\u043D\u044B\u0435 mutations \u0434\u043B\u044F \u0440\u0435\u0430\u043A\u0446\u0438\u0439 \u043D\u0430 \u0441\u0442\u0430\u0442\u044C\u0438 \u0438 \u043A\u043E\u043C\u043C\u0435\u043D\u0442\u0430\u0440\u0438\u0438\n */\nimport { graphql } from '@keystone-6/core';\nimport logger from '../lib/logger';\nimport { createNotification, shouldNotifyAboutLike } from '../lib/notifications';\n\nexport const extendGraphqlSchema = graphql.extend((base) => {\n  // \u041E\u043F\u0440\u0435\u0434\u0435\u043B\u044F\u0435\u043C enum \u0441\u043D\u0430\u0447\u0430\u043B\u0430\n  const ReactionType = graphql.enum({\n    name: 'ReactionType',\n    values: graphql.enumValues(['like', 'dislike']),\n  });\n\n  return {\n    mutation: {\n      reactToArticle: graphql.field({\n        type: base.object('Article'),\n        args: {\n          articleId: graphql.arg({ type: graphql.nonNull(graphql.ID) }),\n          reaction: graphql.arg({\n            type: graphql.nonNull(ReactionType),\n          }),\n        },\n        async resolve(root, { articleId, reaction }, context) {\n          logger.info(`[reactToArticle] START: articleId=${articleId}, reaction=${reaction}`);\n          \n          const session = context.session;\n          if (!session?.itemId) {\n            logger.error(`[reactToArticle] Authentication required`);\n            throw new Error('Authentication required');\n          }\n\n          const userId = session.itemId;\n          logger.info(`[reactToArticle] userId=${userId}`);\n\n          // \u041F\u0440\u043E\u0432\u0435\u0440\u044F\u0435\u043C, \u0447\u0442\u043E \u0440\u0435\u0430\u043A\u0446\u0438\u044F \u0432\u0430\u043B\u0438\u0434\u043D\u0430\n          if (reaction !== 'like' && reaction !== 'dislike') {\n            logger.error(`[reactToArticle] Invalid reaction type: ${reaction}`);\n            throw new Error('Invalid reaction type');\n          }\n\n          // \u041D\u0430\u0445\u043E\u0434\u0438\u043C \u0441\u0442\u0430\u0442\u044C\u044E\n          logger.info(`[reactToArticle] Finding article: articleId=${articleId}`);\n          const article = await context.query.Article.findOne({\n            where: { id: articleId },\n            query: `\n              id\n              likes_count\n              dislikes_count\n              author {\n                id\n              }\n            `,\n          });\n          logger.info(`[reactToArticle] Article found:`, { id: article?.id, likes: article?.likes_count, dislikes: article?.dislikes_count });\n\n          if (!article) {\n            logger.error(`[reactToArticle] Article not found: articleId=${articleId}`);\n            throw new Error('Article not found');\n          }\n\n          // \u041F\u0440\u043E\u0432\u0435\u0440\u044F\u0435\u043C \u0441\u0443\u0449\u0435\u0441\u0442\u0432\u0443\u044E\u0449\u0443\u044E \u0440\u0435\u0430\u043A\u0446\u0438\u044E\n          logger.info(`[reactToArticle] Checking existing reaction: articleId=${articleId}, userId=${userId}`);\n          const existingReaction = await context.query.ArticleReaction.findMany({\n            where: {\n              article: { id: { equals: articleId } },\n              user: { id: { equals: userId } },\n            },\n            query: 'id reaction',\n            take: 1,\n          });\n          logger.info(`[reactToArticle] Existing reaction:`, existingReaction);\n\n          let finalUserReaction: 'like' | 'dislike' | null = null;\n          let newLikes = article.likes_count || 0;\n          let newDislikes = article.dislikes_count || 0;\n          const previousLikes = newLikes; // \u0421\u043E\u0445\u0440\u0430\u043D\u044F\u0435\u043C \u043F\u0440\u0435\u0434\u044B\u0434\u0443\u0449\u0435\u0435 \u0437\u043D\u0430\u0447\u0435\u043D\u0438\u0435 \u0434\u043B\u044F \u043F\u0440\u043E\u0432\u0435\u0440\u043A\u0438 \u043F\u043E\u0440\u043E\u0433\u043E\u0432\n\n          if (existingReaction.length > 0) {\n            const currentReaction = existingReaction[0].reaction;\n            logger.info(`[reactToArticle] Existing reaction found: current=${currentReaction}, new=${reaction}`);\n            \n            if (currentReaction === reaction) {\n              // \u0423\u0434\u0430\u043B\u044F\u0435\u043C \u0440\u0435\u0430\u043A\u0446\u0438\u044E (toggle off)\n              logger.info(`[reactToArticle] Removing reaction: reactionId=${existingReaction[0].id}`);\n              await context.sudo().query.ArticleReaction.deleteOne({\n                where: { id: existingReaction[0].id },\n              });\n              finalUserReaction = null;\n              \n              if (reaction === 'like') {\n                newLikes = Math.max(0, newLikes - 1);\n              } else {\n                newDislikes = Math.max(0, newDislikes - 1);\n              }\n            } else {\n              // \u041C\u0435\u043D\u044F\u0435\u043C \u0440\u0435\u0430\u043A\u0446\u0438\u044E\n              logger.info(`[reactToArticle] Updating reaction: reactionId=${existingReaction[0].id}, newReaction=${reaction}`);\n              await context.sudo().query.ArticleReaction.updateOne({\n                where: { id: existingReaction[0].id },\n                data: { reaction },\n              });\n              finalUserReaction = reaction;\n              \n              if (reaction === 'like') {\n                newLikes = newLikes + 1;\n                newDislikes = Math.max(0, newDislikes - 1);\n              } else {\n                newDislikes = newDislikes + 1;\n                newLikes = Math.max(0, newLikes - 1);\n              }\n            }\n          } else {\n            // \u0421\u043E\u0437\u0434\u0430\u0435\u043C \u043D\u043E\u0432\u0443\u044E \u0440\u0435\u0430\u043A\u0446\u0438\u044E\n            logger.info(`[reactToArticle] Creating new reaction: articleId=${articleId}, userId=${userId}, reaction=${reaction}`);\n            await context.query.ArticleReaction.createOne({\n              data: {\n                article: { connect: { id: articleId } },\n                user: { connect: { id: userId } },\n                reaction,\n              },\n            });\n            finalUserReaction = reaction;\n            \n            if (reaction === 'like') {\n              newLikes = newLikes + 1;\n            } else {\n              newDislikes = newDislikes + 1;\n            }\n          }\n\n          logger.info(`[reactToArticle] New counts: likes=${newLikes}, dislikes=${newDislikes}`);\n\n          // \u041E\u0431\u043D\u043E\u0432\u043B\u044F\u0435\u043C \u0441\u0447\u0435\u0442\u0447\u0438\u043A\u0438 \u0432 \u0441\u0442\u0430\u0442\u044C\u0435 \u0447\u0435\u0440\u0435\u0437 sudo (\u043E\u0431\u0445\u043E\u0434 access control)\n          logger.info(`[reactToArticle] Updating article counts: articleId=${articleId}`);\n          await context.sudo().query.Article.updateOne({\n            where: { id: articleId },\n            data: {\n              likes_count: newLikes,\n              dislikes_count: newDislikes,\n            },\n            query: 'id', // \u041C\u0438\u043D\u0438\u043C\u0430\u043B\u044C\u043D\u044B\u0439 \u0437\u0430\u043F\u0440\u043E\u0441 \u0434\u043B\u044F \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u044F\n          });\n          logger.info(`[reactToArticle] Article counts updated`);\n\n          // \u0421\u043E\u0437\u0434\u0430\u0435\u043C \u0443\u0432\u0435\u0434\u043E\u043C\u043B\u0435\u043D\u0438\u0435 \u043E \u043B\u0430\u0439\u043A\u0435, \u0435\u0441\u043B\u0438 \u043D\u0443\u0436\u043D\u043E (\u0442\u043E\u043B\u044C\u043A\u043E \u0434\u043B\u044F \u043B\u0430\u0439\u043A\u043E\u0432, \u043D\u0435 \u0434\u043B\u044F \u0434\u0438\u0437\u043B\u0430\u0439\u043A\u043E\u0432)\n          if (reaction === 'like' && finalUserReaction === 'like' && article.author?.id) {\n            try {\n              // \u041F\u043E\u0440\u043E\u0433\u0438 \u0434\u043B\u044F \u0441\u0442\u0430\u0442\u0435\u0439: 1, 5, 10, 50, 100, 500, 1000\n              const thresholds = [1, 5, 10, 50, 100, 500, 1000];\n              const threshold = shouldNotifyAboutLike(newLikes, previousLikes, thresholds);\n\n              if (threshold !== null) {\n                // \u0414\u043B\u044F \u043F\u0435\u0440\u0432\u043E\u0433\u043E \u043B\u0430\u0439\u043A\u0430 (threshold=1) \u043F\u0440\u043E\u0432\u0435\u0440\u044F\u0435\u043C \u0434\u0443\u0431\u043B\u0438\u043A\u0430\u0442\u044B \u0437\u0430 \u043F\u043E\u0441\u043B\u0435\u0434\u043D\u0438\u0439 \u0447\u0430\u0441\n                // \u0414\u043B\u044F \u043E\u0441\u0442\u0430\u043B\u044C\u043D\u044B\u0445 \u043F\u043E\u0440\u043E\u0433\u043E\u0432 \u043F\u0440\u043E\u0432\u0435\u0440\u044F\u0435\u043C \u0432\u0441\u0435 \u0441\u0443\u0449\u0435\u0441\u0442\u0432\u0443\u044E\u0449\u0438\u0435 \u0443\u0432\u0435\u0434\u043E\u043C\u043B\u0435\u043D\u0438\u044F\n                const timeWindow = threshold === 1 ? 60 * 60 * 1000 : undefined; // 1 \u0447\u0430\u0441 \u0434\u043B\u044F \u043F\u0435\u0440\u0432\u043E\u0433\u043E \u043B\u0430\u0439\u043A\u0430\n                const cutoffTime = timeWindow ? new Date(Date.now() - timeWindow) : null;\n\n                const where: any = {\n                  user: { id: { equals: String(article.author.id) } },\n                  article: { id: { equals: articleId } },\n                  type: { equals: 'article_like' },\n                };\n\n                if (cutoffTime) {\n                  where.createdAt = { gte: cutoffTime.toISOString() };\n                }\n\n                // \u041F\u0440\u043E\u0432\u0435\u0440\u044F\u0435\u043C, \u043D\u0435 \u0431\u044B\u043B\u043E \u043B\u0438 \u0443\u0436\u0435 \u0443\u0432\u0435\u0434\u043E\u043C\u043B\u0435\u043D\u0438\u044F \u0434\u043B\u044F \u044D\u0442\u043E\u0433\u043E \u043F\u043E\u0440\u043E\u0433\u0430\n                const existingNotifications = await context.sudo().query.Notification.findMany({\n                  where,\n                  query: 'id metadata createdAt',\n                });\n\n                // \u041F\u0440\u043E\u0432\u0435\u0440\u044F\u0435\u043C, \u0435\u0441\u0442\u044C \u043B\u0438 \u0443\u0436\u0435 \u0443\u0432\u0435\u0434\u043E\u043C\u043B\u0435\u043D\u0438\u0435 \u0441 \u044D\u0442\u0438\u043C \u043F\u043E\u0440\u043E\u0433\u043E\u043C \u0432 metadata\n                const hasNotificationForThreshold = existingNotifications.some(\n                  (notif: any) => notif.metadata?.threshold === threshold\n                );\n\n                if (!hasNotificationForThreshold) {\n                  await createNotification(context, {\n                    type: 'article_like',\n                    userId: article.author.id,\n                    actorId: userId,\n                    articleId,\n                    metadata: {\n                      threshold,\n                      likesCount: newLikes,\n                    },\n                  }, true); // \u041F\u0440\u043E\u043F\u0443\u0441\u043A\u0430\u0435\u043C \u043F\u0440\u043E\u0432\u0435\u0440\u043A\u0443 \u0434\u0443\u0431\u043B\u0438\u043A\u0430\u0442\u043E\u0432, \u0442\u0430\u043A \u043A\u0430\u043A \u0443\u0436\u0435 \u043F\u0440\u043E\u0432\u0435\u0440\u0438\u043B\u0438 \u0432\u044B\u0448\u0435\n                  logger.info(`[reactToArticle] Created notification for threshold: ${threshold}, likes: ${newLikes}`);\n                } else {\n                  logger.debug(`[reactToArticle] Notification already exists for threshold: ${threshold}`);\n                }\n              }\n            } catch (error: any) {\n              logger.error(`[reactToArticle] Failed to create like notification:`, {\n                error: error.message,\n                stack: error.stack,\n              });\n            }\n          }\n\n          // \u041F\u043E\u043B\u0443\u0447\u0430\u0435\u043C \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u043D\u0443\u044E \u0441\u0442\u0430\u0442\u044C\u044E (\u0431\u0435\u0437 author, \u0442\u0430\u043A \u043A\u0430\u043A \u043E\u043D \u043D\u0435 \u0437\u0430\u043F\u0440\u0430\u0448\u0438\u0432\u0430\u0435\u0442\u0441\u044F \u0432 GraphQL \u0437\u0430\u043F\u0440\u043E\u0441\u0435)\n          // \u0423\u0431\u0438\u0440\u0430\u0435\u043C DateTime \u043F\u043E\u043B\u044F, \u0442\u0430\u043A \u043A\u0430\u043A \u043E\u043D\u0438 \u0432\u044B\u0437\u044B\u0432\u0430\u044E\u0442 \u043F\u0440\u043E\u0431\u043B\u0435\u043C\u044B \u0441 \u0441\u0435\u0440\u0438\u0430\u043B\u0438\u0437\u0430\u0446\u0438\u0435\u0439\n          logger.info(`[reactToArticle] Fetching updated article: articleId=${articleId}`);\n          try {\n            const updatedArticle = await context.sudo().query.Article.findOne({\n              where: { id: articleId },\n              query: `\n                id\n                title\n                excerpt\n                previewImage\n                tags\n                difficulty\n                likes_count\n                dislikes_count\n                views\n                userReaction\n              `,\n            });\n            \n            logger.info(`[reactToArticle] Article fetched successfully:`, {\n              id: updatedArticle?.id,\n              title: updatedArticle?.title,\n              likes: updatedArticle?.likes_count,\n              dislikes: updatedArticle?.dislikes_count,\n              userReaction: updatedArticle?.userReaction,\n            });\n\n            logger.info(`[reactToArticle] SUCCESS: articleId=${articleId}, userId=${userId}, reaction=${finalUserReaction}`);\n            return updatedArticle;\n          } catch (error) {\n            logger.error(`[reactToArticle] Error fetching article:`, error);\n            throw error;\n          }\n        },\n      }),\n\n      reactToComment: graphql.field({\n        type: base.object('Comment'),\n        args: {\n          commentId: graphql.arg({ type: graphql.nonNull(graphql.ID) }),\n          reaction: graphql.arg({\n            type: graphql.nonNull(ReactionType),\n          }),\n        },\n        async resolve(root, { commentId, reaction }, context) {\n          logger.info(`[reactToComment] START: commentId=${commentId}, reaction=${reaction}`);\n          \n          const session = context.session;\n          if (!session?.itemId) {\n            logger.error(`[reactToComment] Authentication required`);\n            throw new Error('Authentication required');\n          }\n\n          const userId = session.itemId;\n          logger.info(`[reactToComment] userId=${userId}`);\n\n          // \u041F\u0440\u043E\u0432\u0435\u0440\u044F\u0435\u043C, \u0447\u0442\u043E \u0440\u0435\u0430\u043A\u0446\u0438\u044F \u0432\u0430\u043B\u0438\u0434\u043D\u0430\n          if (reaction !== 'like' && reaction !== 'dislike') {\n            logger.error(`[reactToComment] Invalid reaction type: ${reaction}`);\n            throw new Error('Invalid reaction type');\n          }\n\n          // \u041D\u0430\u0445\u043E\u0434\u0438\u043C \u043A\u043E\u043C\u043C\u0435\u043D\u0442\u0430\u0440\u0438\u0439\n          logger.info(`[reactToComment] Finding comment: commentId=${commentId}`);\n          const comment = await context.query.Comment.findOne({\n            where: { id: commentId },\n            query: `\n              id\n              likes_count\n              dislikes_count\n              author {\n                id\n              }\n              article {\n                id\n              }\n            `,\n          });\n          logger.info(`[reactToComment] Comment found:`, { id: comment?.id, likes: comment?.likes_count, dislikes: comment?.dislikes_count });\n\n          if (!comment) {\n            logger.error(`[reactToComment] Comment not found: commentId=${commentId}`);\n            throw new Error('Comment not found');\n          }\n\n          // \u041F\u0440\u043E\u0432\u0435\u0440\u044F\u0435\u043C \u0441\u0443\u0449\u0435\u0441\u0442\u0432\u0443\u044E\u0449\u0443\u044E \u0440\u0435\u0430\u043A\u0446\u0438\u044E\n          logger.info(`[reactToComment] Checking existing reaction: commentId=${commentId}, userId=${userId}`);\n          const existingReaction = await context.query.CommentReaction.findMany({\n            where: {\n              comment: { id: { equals: commentId } },\n              user: { id: { equals: userId } },\n            },\n            query: 'id reaction',\n            take: 1,\n          });\n          logger.info(`[reactToComment] Existing reaction:`, existingReaction);\n\n          let finalUserReaction: 'like' | 'dislike' | null = null;\n          let newLikes = comment.likes_count || 0;\n          let newDislikes = comment.dislikes_count || 0;\n          const previousLikes = newLikes; // \u0421\u043E\u0445\u0440\u0430\u043D\u044F\u0435\u043C \u043F\u0440\u0435\u0434\u044B\u0434\u0443\u0449\u0435\u0435 \u0437\u043D\u0430\u0447\u0435\u043D\u0438\u0435 \u0434\u043B\u044F \u043F\u0440\u043E\u0432\u0435\u0440\u043A\u0438 \u043F\u043E\u0440\u043E\u0433\u043E\u0432\n\n          if (existingReaction.length > 0) {\n            const currentReaction = existingReaction[0].reaction;\n            logger.info(`[reactToComment] Existing reaction found: current=${currentReaction}, new=${reaction}`);\n            \n            if (currentReaction === reaction) {\n              // \u0423\u0434\u0430\u043B\u044F\u0435\u043C \u0440\u0435\u0430\u043A\u0446\u0438\u044E (toggle off)\n              logger.info(`[reactToComment] Removing reaction: reactionId=${existingReaction[0].id}`);\n              await context.sudo().query.CommentReaction.deleteOne({\n                where: { id: existingReaction[0].id },\n              });\n              finalUserReaction = null;\n              \n              if (reaction === 'like') {\n                newLikes = Math.max(0, newLikes - 1);\n              } else {\n                newDislikes = Math.max(0, newDislikes - 1);\n              }\n            } else {\n              // \u041C\u0435\u043D\u044F\u0435\u043C \u0440\u0435\u0430\u043A\u0446\u0438\u044E\n              logger.info(`[reactToComment] Updating reaction: reactionId=${existingReaction[0].id}, newReaction=${reaction}`);\n              await context.sudo().query.CommentReaction.updateOne({\n                where: { id: existingReaction[0].id },\n                data: { reaction },\n              });\n              finalUserReaction = reaction;\n              \n              if (reaction === 'like') {\n                newLikes = newLikes + 1;\n                newDislikes = Math.max(0, newDislikes - 1);\n              } else {\n                newDislikes = newDislikes + 1;\n                newLikes = Math.max(0, newLikes - 1);\n              }\n            }\n          } else {\n            // \u0421\u043E\u0437\u0434\u0430\u0435\u043C \u043D\u043E\u0432\u0443\u044E \u0440\u0435\u0430\u043A\u0446\u0438\u044E\n            logger.info(`[reactToComment] Creating new reaction: commentId=${commentId}, userId=${userId}, reaction=${reaction}`);\n            await context.query.CommentReaction.createOne({\n              data: {\n                comment: { connect: { id: commentId } },\n                user: { connect: { id: userId } },\n                reaction,\n              },\n            });\n            finalUserReaction = reaction;\n            \n            if (reaction === 'like') {\n              newLikes = newLikes + 1;\n            } else {\n              newDislikes = newDislikes + 1;\n            }\n          }\n\n          logger.info(`[reactToComment] New counts: likes=${newLikes}, dislikes=${newDislikes}`);\n\n          // \u041E\u0431\u043D\u043E\u0432\u043B\u044F\u0435\u043C \u0441\u0447\u0435\u0442\u0447\u0438\u043A\u0438 \u0432 \u043A\u043E\u043C\u043C\u0435\u043D\u0442\u0430\u0440\u0438\u0438 \u0447\u0435\u0440\u0435\u0437 sudo (\u043E\u0431\u0445\u043E\u0434 access control)\n          logger.info(`[reactToComment] Updating comment counts: commentId=${commentId}`);\n          await context.sudo().query.Comment.updateOne({\n            where: { id: commentId },\n            data: {\n              likes_count: newLikes,\n              dislikes_count: newDislikes,\n            },\n            query: 'id', // \u041C\u0438\u043D\u0438\u043C\u0430\u043B\u044C\u043D\u044B\u0439 \u0437\u0430\u043F\u0440\u043E\u0441 \u0434\u043B\u044F \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u044F\n          });\n          logger.info(`[reactToComment] Comment counts updated`);\n\n          // \u0421\u043E\u0437\u0434\u0430\u0435\u043C \u0443\u0432\u0435\u0434\u043E\u043C\u043B\u0435\u043D\u0438\u0435 \u043E \u043B\u0430\u0439\u043A\u0435, \u0435\u0441\u043B\u0438 \u043D\u0443\u0436\u043D\u043E (\u0442\u043E\u043B\u044C\u043A\u043E \u0434\u043B\u044F \u043B\u0430\u0439\u043A\u043E\u0432, \u043D\u0435 \u0434\u043B\u044F \u0434\u0438\u0437\u043B\u0430\u0439\u043A\u043E\u0432)\n          if (reaction === 'like' && finalUserReaction === 'like' && comment.author?.id) {\n            try {\n              // \u041F\u043E\u0440\u043E\u0433\u0438 \u0434\u043B\u044F \u043A\u043E\u043C\u043C\u0435\u043D\u0442\u0430\u0440\u0438\u0435\u0432: 1, 3, 5, 10, 25\n              const thresholds = [1, 3, 5, 10, 25];\n              const threshold = shouldNotifyAboutLike(newLikes, previousLikes, thresholds);\n\n              if (threshold !== null) {\n                // \u0414\u043B\u044F \u043F\u0435\u0440\u0432\u043E\u0433\u043E \u043B\u0430\u0439\u043A\u0430 (threshold=1) \u043F\u0440\u043E\u0432\u0435\u0440\u044F\u0435\u043C \u0434\u0443\u0431\u043B\u0438\u043A\u0430\u0442\u044B \u0437\u0430 \u043F\u043E\u0441\u043B\u0435\u0434\u043D\u0438\u0439 \u0447\u0430\u0441\n                // \u0414\u043B\u044F \u043E\u0441\u0442\u0430\u043B\u044C\u043D\u044B\u0445 \u043F\u043E\u0440\u043E\u0433\u043E\u0432 \u043F\u0440\u043E\u0432\u0435\u0440\u044F\u0435\u043C \u0432\u0441\u0435 \u0441\u0443\u0449\u0435\u0441\u0442\u0432\u0443\u044E\u0449\u0438\u0435 \u0443\u0432\u0435\u0434\u043E\u043C\u043B\u0435\u043D\u0438\u044F\n                const timeWindow = threshold === 1 ? 60 * 60 * 1000 : undefined; // 1 \u0447\u0430\u0441 \u0434\u043B\u044F \u043F\u0435\u0440\u0432\u043E\u0433\u043E \u043B\u0430\u0439\u043A\u0430\n                const cutoffTime = timeWindow ? new Date(Date.now() - timeWindow) : null;\n\n                const where: any = {\n                  user: { id: { equals: String(comment.author.id) } },\n                  comment: { id: { equals: commentId } },\n                  type: { equals: 'comment_like' },\n                };\n\n                if (cutoffTime) {\n                  where.createdAt = { gte: cutoffTime.toISOString() };\n                }\n\n                // \u041F\u0440\u043E\u0432\u0435\u0440\u044F\u0435\u043C, \u043D\u0435 \u0431\u044B\u043B\u043E \u043B\u0438 \u0443\u0436\u0435 \u0443\u0432\u0435\u0434\u043E\u043C\u043B\u0435\u043D\u0438\u044F \u0434\u043B\u044F \u044D\u0442\u043E\u0433\u043E \u043F\u043E\u0440\u043E\u0433\u0430\n                const existingNotifications = await context.sudo().query.Notification.findMany({\n                  where,\n                  query: 'id metadata createdAt',\n                });\n\n                // \u041F\u0440\u043E\u0432\u0435\u0440\u044F\u0435\u043C, \u0435\u0441\u0442\u044C \u043B\u0438 \u0443\u0436\u0435 \u0443\u0432\u0435\u0434\u043E\u043C\u043B\u0435\u043D\u0438\u0435 \u0441 \u044D\u0442\u0438\u043C \u043F\u043E\u0440\u043E\u0433\u043E\u043C \u0432 metadata\n                const hasNotificationForThreshold = existingNotifications.some(\n                  (notif: any) => notif.metadata?.threshold === threshold\n                );\n\n                if (!hasNotificationForThreshold) {\n                  await createNotification(context, {\n                    type: 'comment_like',\n                    userId: comment.author.id,\n                    actorId: userId,\n                    articleId: comment.article?.id,\n                    commentId,\n                    metadata: {\n                      threshold,\n                      likesCount: newLikes,\n                    },\n                  }, true); // \u041F\u0440\u043E\u043F\u0443\u0441\u043A\u0430\u0435\u043C \u043F\u0440\u043E\u0432\u0435\u0440\u043A\u0443 \u0434\u0443\u0431\u043B\u0438\u043A\u0430\u0442\u043E\u0432, \u0442\u0430\u043A \u043A\u0430\u043A \u0443\u0436\u0435 \u043F\u0440\u043E\u0432\u0435\u0440\u0438\u043B\u0438 \u0432\u044B\u0448\u0435\n                  logger.info(`[reactToComment] Created notification for threshold: ${threshold}, likes: ${newLikes}`);\n                } else {\n                  logger.debug(`[reactToComment] Notification already exists for threshold: ${threshold}`);\n                }\n              }\n            } catch (error: any) {\n              logger.error(`[reactToComment] Failed to create like notification:`, {\n                error: error.message,\n                stack: error.stack,\n              });\n            }\n          }\n\n          // \u041F\u043E\u043B\u0443\u0447\u0430\u0435\u043C \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u043D\u044B\u0439 \u043A\u043E\u043C\u043C\u0435\u043D\u0442\u0430\u0440\u0438\u0439 \u0441 \u043D\u0435\u043E\u0431\u0445\u043E\u0434\u0438\u043C\u044B\u043C\u0438 \u043F\u043E\u043B\u044F\u043C\u0438 \u0447\u0435\u0440\u0435\u0437 KeystoneJS API\n          // \u0418\u0441\u043F\u043E\u043B\u044C\u0437\u0443\u0435\u043C \u043F\u0440\u0430\u0432\u0438\u043B\u044C\u043D\u044B\u0439 \u0441\u0438\u043D\u0442\u0430\u043A\u0441\u0438\u0441 \u0434\u043B\u044F \u043F\u043E\u043B\u0443\u0447\u0435\u043D\u0438\u044F \u0441\u0432\u044F\u0437\u0435\u0439 \u0447\u0435\u0440\u0435\u0437 KeystoneJS\n          logger.info(`[reactToComment] Fetching updated comment: commentId=${commentId}`);\n          let updatedComment = await context.sudo().query.Comment.findOne({\n            where: { id: commentId },\n            query: `\n              id\n              text\n              likes_count\n              dislikes_count\n              userReaction\n              author {\n                id\n                username\n                avatar\n              }\n              parent {\n                id\n              }\n              article {\n                id\n              }\n            `,\n          });\n\n          logger.info(`[reactToComment] Comment fetched successfully:`, {\n            id: updatedComment?.id,\n            text: updatedComment?.text,\n            author: updatedComment?.author?.id,\n            parent: updatedComment?.parent?.id,\n            article: updatedComment?.article?.id,\n            likes: updatedComment?.likes_count,\n            dislikes: updatedComment?.dislikes_count,\n            userReaction: updatedComment?.userReaction,\n          });\n\n          logger.info(`[reactToComment] SUCCESS: commentId=${commentId}, userId=${userId}, reaction=${finalUserReaction}`);\n\n          return updatedComment;\n        },\n      }),\n    },\n  };\n});\n\n"],
  "mappings": "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",
  "names": ["import_core", "session", "session", "import_core", "import_fields", "winston", "timestamp", "DailyRotateFile", "session", "import_core", "import_fields", "session", "import_core", "import_fields", "import_core", "import_fields", "import_core", "import_fields", "session", "import_core", "import_fields", "session", "import_core", "import_fields", "import_passport", "password", "Redis", "passport", "GoogleStrategy", "JwtStrategy", "timestamp", "multer", "express", "helmet", "cors", "compression", "rateLimit", "redisClient", "RedisStore", "expressSession", "passport", "frontendUrl", "password", "req", "res", "morgan", "import_core", "session"]
}
