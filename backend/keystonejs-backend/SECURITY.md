# üîí Security Guide

## –û–±–∑–æ—Ä –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

KeystoneJS Admin UI –∑–∞—â–∏—â–µ–Ω –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —Å–ª–æ—è–º–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –Ω–µ—Å–∞–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∏ –∞—Ç–∞–∫.

## –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ä—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### 1. –ö–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞ –∫ Admin UI

- **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏**: –¢–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ Admin UI
- **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏**: –¢–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å —Ä–æ–ª—å—é `admin` –º–æ–≥—É—Ç –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ Admin UI
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –¥–æ—Å—Ç—É–ø–∞ (—É—Å–ø–µ—à–Ω—ã–µ –∏ –Ω–µ—É–¥–∞—á–Ω—ã–µ) –ª–æ–≥–∏—Ä—É—é—Ç—Å—è

### 2. –ó–∞—â–∏—Ç–∞ –æ—Ç brute-force –∞—Ç–∞–∫

- **Rate limiting –¥–ª—è GraphQL**: –ú–∞–∫—Å–∏–º—É–º 20 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ 15 –º–∏–Ω—É—Ç —Å –æ–¥–Ω–æ–≥–æ IP
- **Rate limiting –¥–ª—è OAuth**: –ú–∞–∫—Å–∏–º—É–º 5 –ø–æ–ø—ã—Ç–æ–∫ –≤ 15 –º–∏–Ω—É—Ç —Å –æ–¥–Ω–æ–≥–æ IP
- **Rate limiting –¥–ª—è API**: –ú–∞–∫—Å–∏–º—É–º 100 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ 15 –º–∏–Ω—É—Ç —Å –æ–¥–Ω–æ–≥–æ IP
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –í—Å–µ –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è rate limit –ª–æ–≥–∏—Ä—É—é—Ç—Å—è

### 3. –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è

- **JWT —Å–µ—Å—Å–∏–∏**: –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è stateless JWT —Å–µ—Å—Å–∏–∏
- **–•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π**: –ü–∞—Ä–æ–ª–∏ —Ö–µ—à–∏—Ä—É—é—Ç—Å—è —Å –ø–æ–º–æ—â—å—é bcrypt (10 rounds)
- **–°—Ä–æ–∫ –∂–∏–∑–Ω–∏ —Å–µ—Å—Å–∏–∏**: 7 –¥–Ω–µ–π
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –≤—Ö–æ–¥–∞ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è

### 4. Security Headers

- **Helmet**: –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã security headers
  - HSTS (HTTP Strict Transport Security)
  - X-Frame-Options (–∑–∞—â–∏—Ç–∞ –æ—Ç clickjacking)
  - X-Content-Type-Options (–∑–∞—â–∏—Ç–∞ –æ—Ç MIME sniffing)
  - X-XSS-Protection
  - Referrer-Policy
  - Content-Security-Policy (–≤ production)

### 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ SESSION_SECRET

- **–í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ**: –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–ª–∏–Ω—É SESSION_SECRET
- **–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞**: 32 —Å–∏–º–≤–æ–ª–∞
- **Production**: –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –≤ production —Å —Å–ª–∞–±—ã–º SESSION_SECRET

### 6. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

–í—Å–µ —Å–æ–±—ã—Ç–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ —Ñ–∞–π–ª—ã:
- `logs/application-*.log` - –æ–±—â–∏–µ –ª–æ–≥–∏
- `logs/error-*.log` - –æ—à–∏–±–∫–∏ –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

–°–æ–±—ã—Ç–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è:
- –ü–æ–ø—ã—Ç–∫–∏ –≤—Ö–æ–¥–∞ (`login_attempt`)
- –ù–µ—É–¥–∞—á–Ω—ã–µ –≤—Ö–æ–¥—ã (`login_failure`)
- –£—Å–ø–µ—à–Ω—ã–µ –≤—Ö–æ–¥—ã (`login_success`)
- –û—Ç–∫–∞–∑—ã –≤ –¥–æ—Å—Ç—É–ø–µ –∫ Admin UI (`admin_access_denied`)
- –£—Å–ø–µ—à–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ Admin UI (`admin_access_granted`)
- –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ rate limit (`rate_limit_exceeded`)

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### SESSION_SECRET

**–í–ê–ñ–ù–û**: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Å–∏–ª—å–Ω—ã–π SESSION_SECRET –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –≤ production!

```bash
# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —Å–µ–∫—Ä–µ—Ç–∞ (64 —Å–∏–º–≤–æ–ª–∞)
openssl rand -base64 64
```

–î–æ–±–∞–≤—å—Ç–µ –≤ `.env`:
```env
SESSION_SECRET="your-generated-secret-here"
```

### Rate Limiting

–ù–∞—Å—Ç—Ä–æ–π–∫–∏ rate limiting –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –≤ `src/middlewares/index.ts`:

```typescript
// GraphQL (–≤–∫–ª—é—á–∞—è login)
max: 20, // –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ 15 –º–∏–Ω—É—Ç

// OAuth
max: 5, // –ø–æ–ø—ã—Ç–æ–∫ –≤ 15 –º–∏–Ω—É—Ç

// –û–±—â–∏–π API
max: 100, // –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ 15 –º–∏–Ω—É—Ç
```

### Security Headers

–ù–∞—Å—Ç—Ä–æ–π–∫–∏ security headers –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –≤ `src/middlewares/index.ts` –≤ —Å–µ–∫—Ü–∏–∏ `helmet()`.

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

```bash
# –í—Å–µ —Å–æ–±—ã—Ç–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
tail -f logs/application-*.log | grep "Security Event"

# –¢–æ–ª—å–∫–æ –æ—à–∏–±–∫–∏ –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
tail -f logs/error-*.log | grep "Security Event"
```

### –¢–∏–ø–∏—á–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

**–ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:**
- –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –Ω–µ—É–¥–∞—á–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –≤—Ö–æ–¥–∞ —Å –æ–¥–Ω–æ–≥–æ IP
- –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ rate limit
- –ü–æ–ø—ã—Ç–∫–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ Admin UI –Ω–µ-–∞–¥–º–∏–Ω–∞–º–∏

**–ù–æ—Ä–º–∞–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:**
- –£—Å–ø–µ—à–Ω—ã–µ –≤—Ö–æ–¥—ã –∞–¥–º–∏–Ω–æ–≤
- –£—Å–ø–µ—à–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ Admin UI

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è production

1. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ HTTPS**: –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ HTTPS –≤ production –¥–ª—è –∑–∞—â–∏—Ç—ã —Å–µ—Å—Å–∏–π
2. **–°–∏–ª—å–Ω—ã–π SESSION_SECRET**: –ú–∏–Ω–∏–º—É–º 64 —Å–∏–º–≤–æ–ª–∞, —Å–ª—É—á–∞–π–Ω—ã–π
3. **–†–µ–≥—É–ª—è—Ä–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –ª–æ–≥–∏ –Ω–∞ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—É—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
4. **–û–±–Ω–æ–≤–ª–µ–Ω–∏—è**: –†–µ–≥—É–ª—è—Ä–Ω–æ –æ–±–Ω–æ–≤–ª—è–π—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π
5. **Firewall**: –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ –∫ Admin UI –ø–æ IP (whitelist)
6. **–î–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è**: –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏—è 2FA –¥–ª—è –∞–¥–º–∏–Ω–æ–≤

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ä—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### IP Whitelist –¥–ª—è Admin UI

–ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É IP –∞–¥—Ä–µ—Å–∞ –≤ `keystone.ts`:

```typescript
ui: {
  isAccessAllowed: async (context) => {
    const req = (context as any).req;
    const ip = req?.ip || req?.connection?.remoteAddress;
    
    // Whitelist IP –∞–¥—Ä–µ—Å–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    const allowedIPs = process.env.ADMIN_IP_WHITELIST?.split(',') || [];
    if (allowedIPs.length > 0 && !allowedIPs.includes(ip)) {
      logAdminAccessDenied(ip, undefined, 'IP not in whitelist');
      return false;
    }
    
    // ... –æ—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞
  },
}
```

### –î–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è

–î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è 2FA –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫–∏:
- `speakeasy` –¥–ª—è TOTP
- `qrcode` –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –∫–æ–¥–æ–≤

## –ö–æ–Ω—Ç–∞–∫—Ç—ã

–ü—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–æ–æ–±—â–∏—Ç–µ –æ–± —ç—Ç–æ–º –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ.

